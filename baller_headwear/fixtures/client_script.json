[
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Pick List",
  "enabled": 0,
  "modified": "2025-06-24 16:40:55.977233",
  "module": null,
  "name": "Test pick list",
  "script": "frappe.ui.form.on('Pick List', {\n  refresh(frm) {\n    if (frm.doc.purpose === \"Material Transfer for Manufacture\" && frm.doc.docstatus === 0) {\n      frm.add_custom_button(\"Get Items from Work Orders\", () => {\n        // Mở dialog chọn Work Order\n        const d = new frappe.ui.form.MultiSelectDialog({\n          doctype: \"Work Order\",\n          target: frm,\n          setters: {\n            production_item: undefined,\n            company: frm.doc.company,\n            status: \"Submitted\",\n          },\n          add_filters_group: 1,\n          get_query() {\n            return {\n              filters: {\n                docstatus: 1,\n                status: [\"!=\", \"Completed\"],\n              },\n            };\n          },\n          action(selections) {\n            if (selections && selections.length > 0) {\n              frappe.call({\n                method: \"erpnext.stock.doctype.pick_list.pick_list.get_items_from_work_orders\",\n                args: {\n                  work_orders: selections,\n                  company: frm.doc.company,\n                },\n                callback: function(r) {\n                  if (!r.exc && r.message) {\n                    frm.clear_table(\"locations\");\n                    $.each(r.message, function(i, d) {\n                      const row = frm.add_child(\"locations\");\n                      Object.assign(row, d);\n                    });\n                    frm.refresh_field(\"locations\");\n                    d.dialog.hide();\n                  }\n                },\n              });\n            }\n          },\n        });\n      });\n    }\n  }\n});\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Purchase Order",
  "enabled": 1,
  "modified": "2025-07-01 14:49:37.581668",
  "module": null,
  "name": "PIC_INFO",
  "script": "frappe.ui.form.on('Purchase Order', {\n    onload: function(frm) {\n        if (frm.is_new() && !frm.doc.custom_pic) {\n            frm.set_value('custom_pic', frappe.session.user);\n        }\n    },\n\n    custom_pic: function(frm) {\n        if (frm.doc.custom_pic) {\n            frappe.db.get_doc('User', frm.doc.custom_pic).then(user => {\n                const full_name = user.full_name || `${user.first_name || ''} ${user.last_name || ''}`;\n                frm.set_value('custom_name', full_name.trim());\n                frm.set_value('custom_email', user.email || '');\n                frm.set_value('custom_phone', user.phone || '');\n                frm.set_value('custom_wechat_id', user.bio || '');\n            });\n        } else {\n            frm.set_value('custom_name', '');\n            frm.set_value('custom_email', '');\n            frm.set_value('custom_phone', '');\n            frm.set_value('custom_wechat_id', '');\n        }\n    }\n});\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "BOM Creator",
  "enabled": 1,
  "modified": "2025-10-17 08:52:30.715154",
  "module": "Manufacturing",
  "name": "Update Parent Row No",
  "script": "frappe.ui.form.on(\"BOM Creator Item\", {\n  fg_item: function(frm, cdt, cdn) {\n    let current_row = locals[cdt][cdn];\n\n    console.log(\"FG Item selected:\", current_row.fg_item);\n\n    let parent_row = frm.doc.items.find(\n      row => row.item_code === current_row.fg_item\n    );\n\n    if (parent_row) {\n      console.log(\"Match found at row:\", parent_row.idx);\n      frappe.model.set_value(cdt, cdn, \"parent_row_no\", parent_row.idx);\n    } else {\n      console.log(\"No match found.\");\n      frappe.model.set_value(cdt, cdn, \"parent_row_no\", \"\");\n    }\n  }\n});\n\n\n\n// frappe.ui.form.on(\"BOM Creator\", {\n//   onload: function(frm) {\n//     frm.fields_dict.items.grid.on_sort = () => {\n//       console.log(\"Rows have been reordered.\");\n\n//       frm.doc.items.forEach(child => {\n//         let parent_row = frm.doc.items.find(\n//           row => row.item_code === child.fg_item\n//         );\n//         if (parent_row) {\n//           frappe.model.set_value(child.doctype, child.name, \"parent_row_no\", parent_row.idx);\n//         } else {\n//           frappe.model.set_value(child.doctype, child.name, \"parent_row_no\", \"\");\n//         }\n//       });\n//     };\n//   }\n// });\n\n\n\nfrappe.ui.form.on(\"BOM Creator\", {\n  validate: function(frm) {\n    frm.doc.items.forEach(row => {\n      const parent_row = frm.doc.items.find(r => r.item_code === row.fg_item);\n      if (parent_row) {\n        frappe.model.set_value(row.doctype, row.name, \"parent_row_no\", parent_row.idx);\n      } else {\n        frappe.model.set_value(row.doctype, row.name, \"parent_row_no\", \"\");\n      }\n    });\n  }\n});\n\n\n\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Material Summary",
  "enabled": 1,
  "modified": "2026-01-13 15:12:37.448849",
  "module": null,
  "name": "Material Summary",
  "script": "frappe.ui.form.on('Material Summary', {\n    \n    before_load: function(frm) {\n        if (frm.is_new() && !frm.doc.naming_series) {\n            frm.set_value(\"naming_series\", \"MS-.YY.-.MM.-.DD.-.#####\");\n        }\n    },\n\n    \n    onload(frm) {\n        if (!frm.doc.posting_date) {\n            frm.set_value(\"posting_date\", frappe.datetime.get_today());\n        }\n\n        if (!frm.doc.posting_time) {\n            frm.set_value(\"posting_time\", frappe.datetime.now_time());\n        }\n        \n        if (!frm.doc.created_by) {\n            frm.set_value(\"created_by\", frappe.session.user);\n        }\n    \n    },\n    \n    \n    \n    get_work_orders(frm) {\n        const production_plan = frm.doc.production_plan;\n        const planned_start_date_from = frm.doc.planned_start_date_from;\n        const planned_start_date_to = frm.doc.planned_start_date_to;\n        const item_to_manufacture= frm.doc.item_to_manufacture;\n        const po_number =frm.doc.po_number;\n        const purpose = frm.doc.purpose;\n        const item_code = frm.doc.item_code;\n\n        frappe.call({\n            method: \"get_work_orders_by_production_plan\",\n            args: { \n                production_plan,\n                planned_start_date_from,\n                planned_start_date_to,\n                item_to_manufacture,\n                po_number,\n                purpose,\n                item_code\n            },\n            callback: function (response) {\n                const work_orders = response.message;\n\n                if (work_orders && work_orders.length > 0) {\n                    frm.clear_table(\"work_orders\");\n\n                    work_orders.forEach(row => {\n                        const child = frm.add_child(\"work_orders\");\n                        child.work_order = row.name;\n                        child.qty = row.qty;\n                        child.item_to_manufacture= row.production_item;\n                        child.bom_no = row.bom_no;\n                        child.po_number = row.po_number;\n                    });\n\n                    frm.refresh_field(\"work_orders\");\n                } else {\n                    if (purpose == 'Material Transfer') {\n                        frappe.msgprint(\"Không tìm thấy Work Orders nào (Work Orders phải có status = In Process và đã tạo phiếu Material Request) \");\n                    } else {\n                        frappe.msgprint(\"Không tìm thấy Work Orders nào\")\n                    }\n                }\n            }\n        });\n        \n        \n        \n    },\n    \n    \n    get_material_requests(frm) {\n        \n        let work_orders = frm.doc.work_orders.map(row => {\n            return row.work_order\n        });\n        \n        frappe.call({\n            method: \"get_material_request_from_work_order\",\n            args: {work_orders: work_orders},\n            callback: function (r) {\n                const material_requests = r.message;\n\n                if (material_requests && material_requests.length > 0) {\n                    frm.clear_table(\"material_requests\");\n\n                    material_requests.forEach(row => {\n                        const child = frm.add_child(\"material_requests\");\n                        child.material_request = row.name;\n                        child.per_ordered = row.per_ordered;\n                        child.per_received= row.per_received;\n                        child.schedule_date = row.schedule_date;\n                        child.source_warehouse = row.set_from_warehouse;\n                        child.target_warehouse= row.set_warehouse;\n                        child.work_order = row.work_order;\n                        child.workflow_state = row.workflow_state;\n\n                    });\n\n                    frm.refresh_field(\"material_requests\");\n                } else {\n                    frappe.msgprint(\"Không tìm thấy Material Request nào.\");\n                }                    \n            }\n        })\n    },\n    \n    \n    \n\n    get_items(frm) {\n        const purpose = frm.doc.purpose;\n        let work_orders = frm.doc.work_orders.map(row => row.work_order);\n        let material_requests = frm.doc.material_requests.map(row => row.material_request);\n        \n        if (purpose === \"Material Transfer for Manufacture\") {\n            frappe.call({\n                method: \"get_work_order_item\",\n                args: {\n                    purpose: \"Material Transfer for Manufacture\",\n                    work_orders: work_orders,\n                    get_only_fabric: frm.doc.get_only_fabric || 0\n                },\n                callback: function (response) {\n                    const items = response.message;\n        \n                    if (items && items.length > 0) {\n                        frm.clear_table(\"items\");\n        \n                        items.forEach(row => {\n                            const is_transferred_qty = row.required_qty - row.transferred_qty;\n                            if (is_transferred_qty == 0) {\n                                return\n                            }\n                            const child = frm.add_child(\"items\");\n                            child.not_yet_issued = row.required_qty - row.transferred_qty;\n                            child.item_code = row.item_code;\n                            child.required_qty = row.required_qty;\n                            child.issued_qty = row.transferred_qty;\n                            child.stock_uom = row.stock_uom;\n                            child.source_warehouse = row.source_warehouse;\n                            child.planned_issue_qty = child.not_yet_issued;\n                            child.planned_used_qty = child.planned_issue_qty;\n                            child.expected_surplus_quantity = row.expected_surplus_quantity;\n                        });\n        \n                        frm.refresh_field(\"items\");\n                    } else {\n                        frappe.msgprint(\"Không tìm thấy Items từ Work Order.\");\n                    }\n                }\n            });\n        } else {\n            frappe.call({\n                method: \"get_material_request_item\",\n                args: {\n                    purpose: \"Material Transfer\",\n                    material_requests: material_requests,\n                    get_only_fabric: frm.doc.get_only_fabric || 0\n                },\n                callback: function (response) {\n                    const items = response.message;\n        \n                    if (items && items.length > 0) {\n                        frm.clear_table(\"items\");\n        \n                        items.forEach(row => {\n                            const child = frm.add_child(\"items\");\n                            child.item_code = row.item_code;\n                            child.required_qty = row.qty;\n                            child.issued_qty = row.received_qty;\n                            child.not_yet_issued = row.qty-row.received_qty;\n                            child.source_warehouse = row.from_warehouse;\n                            child.stock_uom = row.stock_uom;\n                            child.available_stock = row.actual_qty;\n                            child.planned_issue_qty = child.not_yet_issued;\n                        });\n        \n                        frm.refresh_field(\"items\");\n                    } else {\n                        frappe.msgprint(\"Không tìm thấy Items từ Material Request.\");\n                    }\n                }\n            });\n        }\n\n    },\n\n    check_stock(frm) {\n        let posting_time = `${frm.doc.posting_date} ${frm.doc.posting_time}`;\n        \n        let source_warehouse = frm.doc.source_warehouse;\n        let time_check = frappe.datetime.now_datetime();\n\n\n        if (!frm.doc.items || frm.doc.items.length === 0) {\n            frappe.msgprint(\"Vui lòng nhập danh sách Items trước.\");\n            return;\n        }\n        \n        let items_data = frm.doc.items.map(row => {\n            return {\n                item_code: row.item_code,\n                not_yet_issued: row.not_yet_issued,\n                issued_qty: row.issued_qty,\n                stock_uom: row.stock_uom,\n                source_warehouse: row.source_warehouse,\n                posting_time: posting_time\n            };\n        });\n\n            frappe.call({\n                method: \"get_stock_actual_qty\", \n                args: {\n                    items: items_data\n                },\n                callback: function (r) {\n                    if (r.message && r.message.length > 0) {\n                \n                    // Kiểm tra xem có item nào thiếu hàng không\n                    const insufficientItems = r.message.filter(item => (item.shortage_qty || 0) > 0);\n                \n                    if (insufficientItems.length > 0) {\n                        // Có ít nhất 1 item thiếu hàng → hiển thị tất cả thông tin\n                        let msg = insufficientItems.map(result => `\n                            <b>Item:</b> ${result.item_code}<br>\n                            <b>Warehouse:</b> ${result.warehouse}<br>\n                            <b>Available Qty:</b> ${result.available_qty}<br>\n                            <b>Required Qty:</b> ${result.required_qty}<br>\n                            <b>Shortage:</b> ${result.shortage_qty || 0}<br>\n                            <b>Message:</b> ${result.message || 'Insufficient stock'}\n                        `).join(\"<hr>\");\n                \n                        frappe.msgprint({\n                            title: __('Stock Check Result'),\n                            message: msg,\n                            indicator: 'red'\n                        });\n                \n                    } else {\n                        // Không có item nào thiếu hàng → hiển thị Sufficient stock\n                        frappe.msgprint({\n                            title: __('Stock Check Result'),\n                            message: `<br>Sufficient stock to fulfill the material request.</br>`,\n                            indicator: 'green'\n                        });\n                \n                        // Cập nhật planned_issue_qty cho tất cả item\n                        r.message.forEach(result => {\n                            frm.doc.items\n                                .filter(i => i.item_code === result.item_code)\n                                .forEach(i => {\n                                    i.available_stock = result.available_qty;\n                                    i.returned_qty = i.not_yet_issued-i.planned_issue_qty;\n                                    i.planned_leftover_qty = (i.planned_issue_qty || 0) - (i.planned_used_qty || 0)\n                                });\n                        });\n                        frm.refresh_field(\"items\");\n                    }\n                }\n\n                }\n            });\n        },\n        \n        \n        \n    refresh: function(frm) {\n    if (!frm.is_new() && frm.doc.docstatus === 1) {\n        frm.add_custom_button(__(\"Create Material Transfer\"), function() {\n            frappe.dom.freeze();\n            frappe.call({\n                method: \"create_material_transfers\",\n                args: {\n                    summary_name: frm.doc.name,\n                    get_only_fabric: frm.doc.get_only_fabric || 0,\n                    work_orders: frm.doc.work_orders || [],\n                    items: frm.doc.items || [],\n                    material_requests: frm.doc.material_requests || [],\n                    posting_date: frm.doc.posting_date\n                },\n                callback: function(r) {\n                    frappe.dom.unfreeze();\n\n                    if (!r.exc && r.stock_entries) {\n                        let links = r.stock_entries.map(id => {\n                            return `<div><a href=\"/app/stock-entry/${id}\" target=\"_blank\">${id}</a></div>`;\n                        }).join(\"\");\n                    \n                        frappe.msgprint({\n                            title: __(\"Material Transfers Created\"),\n                            message: __(\"The following Stock Entries were created:<br><br>{0}\", [links]),\n                            indicator: \"green\"\n                        });\n                    } else {\n                        frappe.msgprint(__(\"No Stock Entry created\"));\n                    }\n\n                    frm.reload_doc();\n                },\n                \n                error: function(err) {\n                    frappe.dom.unfreeze();\n                },\n\n                \n                complete: function(r) {\n                    frappe.dom.unfreeze();\n                }\n            });\n            \n            $(document).on(\"hidden.bs.modal\", \".modal\", function () {\n            frappe.dom.unfreeze();\n        });\n        });\n    }\n},\n});\n\nfrappe.ui.form.on('Material Summary Items', {\n    items_add: function(frm, cdt, cdn) {\n        let row = locals[cdt][cdn];\n        // And set leftover accordingly\n        row.planned_leftover_qty = (row.planned_issue_qty || 0) - (row.planned_used_qty || 0);\n        frm.refresh_field(\"items\");\n    },\n\n    planned_issue_qty: function(frm, cdt, cdn) {\n        let row = locals[cdt][cdn];\n        row.planned_leftover_qty = (row.planned_issue_qty || 0) - (row.planned_used_qty || 0);\n        frm.refresh_field(\"items\");\n    },\n    \n    planned_used_qty: function(frm, cdt, cdn) {\n        let row = locals[cdt][cdn];\n        row.planned_leftover_qty = (row.planned_issue_qty || 0) - (row.planned_used_qty || 0);\n        frm.refresh_field(\"items\");\n    }\n});\n\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Cutting Operation",
  "enabled": 0,
  "modified": "2025-08-28 16:38:16.958692",
  "module": null,
  "name": "Cutting Operation",
  "script": "frappe.ui.form.on('Cutting Operation', {\n    before_load: function(frm) {\n        if (frm.is_new() && !frm.doc.naming_series) {\n            frm.set_value(\"naming_series\", \"OP-.YY.-.MM.-.DD.-.#####\");\n        }\n    },\n\n    onload: function(frm) {\n        if (!frm.doc.posting_date) {\n            frm.set_value(\"posting_date\", frappe.datetime.get_today());\n        }\n    }\n});\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Purchase Invoice",
  "enabled": 1,
  "modified": "2025-10-13 15:16:17.979162",
  "module": null,
  "name": "Company is Baller Headwear Pte. Ltd.  and document date is before 1/7/25  Use letterhead",
  "script": "frappe.ui.form.on('Purchase Invoice', {\n    company: function(frm) {\n        set_letterhead_based_on_date(frm);\n    },\n    posting_date: function(frm) {\n        set_letterhead_based_on_date(frm);\n    },\n    refresh: function(frm) {\n        set_letterhead_based_on_date(frm);\n    }\n});\n\nfunction set_letterhead_based_on_date(frm) {\n    // Only proceed if posting_date exists\n    if (!frm.doc.posting_date) return;\n\n    // Convert posting_date to JS Date\n    const doc_date = new Date(frm.doc.posting_date + \"T00:00:00\");\n    const cutoff_date = new Date(\"2025-07-01T00:00:00\");\n\n    // Set letterhead based on posting date\n    if (doc_date < cutoff_date) {\n        frm.set_value(\"letter_head\", \"BHS-Old\");\n    } else {\n        frm.set_value(\"letter_head\", \"BHS-New\");\n    }\n}",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Purchase Order",
  "enabled": 1,
  "modified": "2025-10-13 15:35:15.883334",
  "module": null,
  "name": "set value to letter head",
  "script": "frappe.ui.form.on('Purchase Order', {\n    company: function(frm) {\n        set_letterhead_based_on_date(frm);\n    },\n    transaction_date: function(frm) {\n        set_letterhead_based_on_date(frm);\n    },\n    refresh: function(frm) {\n        set_letterhead_based_on_date(frm);\n    }\n});\n\nfunction set_letterhead_based_on_date(frm) {\n    // Only proceed if transaction_date exists\n    if (!frm.doc.transaction_date) return;\n\n    // Convert posting_date to JS Date\n    const doc_date = new Date(frm.doc.transaction_date + \"T00:00:00\");\n    const cutoff_date = new Date(\"2025-07-01T00:00:00\");\n\n    // Set letterhead based on transaction_date\n    if (doc_date < cutoff_date) {\n        frm.set_value(\"letter_head\", \"BHS-Old\");\n    } else {\n        frm.set_value(\"letter_head\", \"BHS-New\");\n    }\n}\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Sales Order",
  "enabled": 1,
  "modified": "2025-10-13 15:37:57.849775",
  "module": null,
  "name": "set value to letter head basis on company and date",
  "script": "\nfrappe.ui.form.on('Sales Order', {\n    company: function(frm) {\n        set_letterhead_based_on_date(frm);\n    },\n    transaction_date: function(frm) {\n        set_letterhead_based_on_date(frm);\n    },\n    refresh: function(frm) {\n        set_letterhead_based_on_date(frm);\n    }\n});\n\nfunction set_letterhead_based_on_date(frm) {\n    // Only proceed if transaction_date exists\n    if (!frm.doc.transaction_date) return;\n\n    // Convert posting_date to JS Date\n    const doc_date = new Date(frm.doc.transaction_date + \"T00:00:00\");\n    const cutoff_date = new Date(\"2025-07-01T00:00:00\");\n\n    // Set letterhead based on transaction_date\n    if (doc_date < cutoff_date) {\n        frm.set_value(\"letter_head\", \"BHS-Old\");\n    } else {\n        frm.set_value(\"letter_head\", \"BHS-New\");\n    }\n}\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Sales Invoice",
  "enabled": 1,
  "modified": "2025-10-13 15:44:16.578617",
  "module": null,
  "name": "set letter head as per company and posting date",
  "script": "frappe.ui.form.on('Sales Invoice', {\n    company: function(frm) {\n        set_letterhead_based_on_date(frm);\n    },\n    transaction_date: function(frm) {\n        set_letterhead_based_on_date(frm);\n    },\n    refresh: function(frm) {\n        set_letterhead_based_on_date(frm);\n    }\n});\n\nfunction set_letterhead_based_on_date(frm) {\n    // Only proceed if transaction_date exists\n    if (!frm.doc.transaction_date) return;\n\n    // Convert posting_date to JS Date\n    const doc_date = new Date(frm.doc.transaction_date + \"T00:00:00\");\n    const cutoff_date = new Date(\"2025-07-01T00:00:00\");\n\n    // Set letterhead based on transaction_date\n    if (doc_date < cutoff_date) {\n        frm.set_value(\"letter_head\", \"BHS-Old\");\n    } else {\n        frm.set_value(\"letter_head\", \"BHS-New\");\n    }\n}\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Sales Order",
  "enabled": 1,
  "modified": "2026-01-07 17:21:53.936906",
  "module": null,
  "name": "custom_update_item",
  "script": "frappe.ui.form.on(\"Sales Order\", {\n    refresh(frm) {\n        const observer = new MutationObserver(() => {\n            const $dialog = $(\".modal:visible\").last();\n            const title = $dialog.find(\".modal-title\").text().trim();\n\n            if (title === \"Update Items\" && !$dialog.find(\".import-csv-btn\").length) {\n                console.log(\"Found 'Update Items' dialog\");\n\n                const importBtn = $(`\n                    <button class=\"btn btn-sm btn-secondary import-csv-btn\" style=\"margin-left:8px\">\n                        <i class=\"fa fa-upload\"></i> Import CSV\n                    </button>\n                `);\n\n                $dialog.find(\".modal-footer .btn-primary\").before(importBtn);\n\n                importBtn.on(\"click\", function () {\n                    const fileInput = $('<input type=\"file\" accept=\".csv\" style=\"display:none\"/>');\n                    $(\"body\").append(fileInput);\n\n                    fileInput.on(\"change\", function (e) {\n                        const file = e.target.files[0];\n                        if (!file) return;\n\n                        const reader = new FileReader();\n\n                        reader.onload = function (evt) {\n                            let csvText = evt.target.result || \"\";\n\n                            // Remove BOM\n                            if (csvText.charCodeAt(0) === 0xFEFF) {\n                                csvText = csvText.slice(1);\n                            }\n\n                            // Detect delimiter\n                            const semiCount = (csvText.match(/;/g) || []).length;\n                            const commaCount = (csvText.match(/,/g) || []).length;\n\n                            if (semiCount > commaCount) {\n                                csvText = csvText.replace(/;/g, \",\");\n                            }\n\n                            const lines = csvText\n                                .split(/\\r?\\n/)\n                                .map((l) => l.trim())\n                                .filter((l) => l);\n\n                            if (!lines.length) {\n                                frappe.msgprint(\"CSV is empty or invalid.\");\n                                return;\n                            }\n\n                            const headerIndex = lines.findIndex((l) =>\n                                l.toLowerCase().includes(\"item_code\")\n                            );\n\n                            if (headerIndex === -1) {\n                                frappe.msgprint(\"Could not find 'item_code' header in CSV.\");\n                                return;\n                            }\n\n                            const headers = lines[headerIndex]\n                                .split(\",\")\n                                .map((h) => h.trim().toLowerCase());\n\n                            const dataLines = lines.slice(headerIndex + 1);\n                            if (!dataLines.length) {\n                                frappe.msgprint(\"CSV has no data rows.\");\n                                return;\n                            }\n\n                            // Build CSV MAP – SUPPORT MULTIPLE ROWS PER ITEM CODE\n                            const csvMap = {};\n\n                            dataLines.forEach((line) => {\n                                const vals = line.split(\",\").map((v) => v.trim());\n                                if (vals.length === 1 && vals[0] === \"\") return;\n\n                                const row = {};\n                                headers.forEach((h, i) => (row[h] = vals[i] || \"\"));\n\n                                const rawCode =\n                                    row[\"item_code\"] ||\n                                    row[\"item\"] ||\n                                    row[\"item code\"];\n\n                                if (!rawCode) return;\n\n                                const itemCode = rawCode.trim().toLowerCase();\n\n                                if (!csvMap[itemCode]) csvMap[itemCode] = [];\n                                csvMap[itemCode].push(row); // push to list for duplicates\n                            });\n\n                            const $rows = $dialog.find(\".grid-body .grid-row\");\n                            if (!$rows.length) {\n                                frappe.msgprint(\"Could not find grid rows in dialog.\");\n                                return;\n                            }\n\n                            let updated = 0;\n\n                            $rows.each((rowIndex, el) => {\n                                const $r = $(el);\n                                const itemCodeRaw = $r\n                                    .find('[data-fieldname=\"item_code\"] a')\n                                    .text()\n                                    .trim();\n\n                                if (!itemCodeRaw) return;\n\n                                const itemCode = itemCodeRaw.toLowerCase();\n                                const csvList = csvMap[itemCode];\n\n                                if (!csvList || !csvList.length) return;\n\n                                // Take FIRST unused CSV row\n                                const csvRow = csvList.shift();\n\n                                console.log(\"DEBUG MATCH →\", itemCode, csvRow);\n\n                                // Get qty from CSV (priority order)\n                                let qty =\n                                    csvRow.qty ||\n                                    csvRow[\"qty as per stock uom\"] ||\n                                    csvRow.qty ||\n                                    csvRow.quantity;\n\n                                const rate = csvRow.rate;\n                                const delivery =\n                                    csvRow.delivery_date ||\n                                    csvRow[\"delivery date\"];\n\n                                const gridObj = $r.data(\"grid_row\");\n                                if (!gridObj || !gridObj.doc) return;\n\n                                if (qty) gridObj.doc.qty = qty;\n                                if (rate) gridObj.doc.rate = rate;\n                                if (delivery) gridObj.doc.delivery_date = delivery;\n\n                                gridObj.grid.refresh();\n                                updated++;\n                            });\n\n                            frappe.show_alert(`✅ Updated ${updated} items from CSV.`, 5);\n                        };\n\n                        reader.readAsText(file, \"utf-8\");\n                    });\n\n                    fileInput.click();\n                });\n            }\n        });\n\n        observer.observe(document.body, { childList: true, subtree: true });\n    },\n});",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Item",
  "enabled": 1,
  "modified": "2025-11-17 14:20:51.424346",
  "module": null,
  "name": "According to No of Months (Expense) set Deferred Expense Account",
  "script": "frappe.ui.form.on(\"Item\", {\n    no_of_months_exp(frm) {\n        update_deferred_expense_account(frm);\n    }\n});\n\nfunction update_deferred_expense_account(frm) {\n    const months = frm.doc.no_of_months_exp;\n\n    if (!months) return;\n\n    (frm.doc.item_defaults || []).forEach(row => {\n        if (!row.company) return;\n\n        frappe.db.get_value(\"Company\", row.company, [\n            \"default_deferred_expense_account\",\n            \"custom_default_deferred_expense_account__1_year\"\n        ]).then(r => {\n            if (!r.message) return;\n\n            let value = \"\";\n\n            if (months <= 12) {\n                value = r.message.default_deferred_expense_account;\n            } else {\n                value = r.message.custom_default_deferred_expense_account__1_year;\n            }\n\n            // Set value inside child table\n            frappe.model.set_value(row.doctype, row.name, \"deferred_expense_account\", value);\n        });\n    });\n}\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Production Plan",
  "enabled": 1,
  "modified": "2025-11-20 12:02:29.645480",
  "module": null,
  "name": "Get PO number for Production Plan",
  "script": "frappe.ui.form.on('Production Plan', {\n    get_items: function(frm) {\n        frappe.after_ajax(() => {\n            let payload = [];\n\n            (frm.doc.po_items || []).forEach(row => {\n                if (row.item_code) {\n                    payload.push({\n                        rowname: row.name,           // để biết cập nhật dòng nào\n                        doctype: row.doctype,\n                        item_code: row.item_code,\n                        sales_order: row.sales_order,\n                        sales_order_item: row.sales_order_item\n                    });\n                }\n            });\n\n            if (payload.length > 0) {\n                frappe.call({\n                    method: \"po_number_for_production_plan\",\n                    args: { items: payload },     // gửi cả mảng\n                    callback: function(r) {\n                        if (r.message) {\n                            r.message.forEach(res => {\n                                if (res.custom_po_number) {\n                                    frappe.model.set_value(\n                                        \"Production Plan Item\", // hoặc row.doctype\n                                        res.rowname,\n                                        \"custom_po_number\",\n                                        res.custom_po_number\n                                    );\n                                }\n                            });\n                        }\n                    }\n                });\n            }\n        });\n    }\n});\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Employee Overtime",
  "enabled": 1,
  "modified": "2025-12-05 03:04:04.996057",
  "module": null,
  "name": "Employee Overtime Auto Calculation",
  "script": "frappe.ui.form.on(\"Employee Overtime\", {\n\n    hourly_rate(frm) {\n        calculate_ot(frm);\n    },\n\n    multiplier(frm) {\n        calculate_ot(frm);\n    },\n\n    overtime_hours(frm) {\n        calculate_ot(frm);\n    },\n\n    employee_id(frm) {   // <-- Correct trigger\n        if (!frm.doc.employee_id) return;\n\n        frappe.call({\n            method: \"frappe.client.get_list\",\n            args: {\n                doctype: \"Salary Structure Assignment\",\n                filters: {\n                    employee: frm.doc.employee_id,\n                    docstatus: 1\n                },\n                fields: [\"name\", \"custom_hourly_rate\"],\n                limit: 1,\n                order_by: \"from_date desc\"\n            },\n            callback(r) {\n                if (r.message && r.message.length > 0) {\n                    let rate = r.message[0].custom_hourly_rate || 0;\n                    frm.set_value(\"hourly_rate\", rate);\n                } else {\n                    frm.set_value(\"hourly_rate\", 0);\n                    frappe.msgprint(\"No Salary Structure Assignment found for this Employee.\");\n                }\n            }\n        });\n    },\n});\n\nfunction calculate_ot(frm) {\n    let h = frm.doc.hourly_rate || 0;\n    let m = frm.doc.multiplier || 0;\n    let hrs = frm.doc.overtime_hours || 0;\n\n    let rate = h * m;\n    let amount = rate * hrs;\n\n    frm.set_value(\"overtime_rate\", rate);\n    frm.set_value(\"overtime_amount\", amount);\n}\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Attendance Bonus",
  "enabled": 1,
  "modified": "2026-01-14 14:54:41.448786",
  "module": null,
  "name": "Attendance Bonus Employee",
  "script": "// frappe.ui.form.on(\"Attendance Bonus\", {\n\n//     // ✔ Auto-clear child table when Payroll Date changes\n//     payroll_date: function (frm) {\n//         frm.clear_table(\"table_rbxn\");\n//         frm.refresh_field(\"table_rbxn\");\n//     },\n\n//     refresh(frm) {\n\n//         frm.add_custom_button(\"Fetch Employee\", async function () {\n\n//             if (!frm.doc.payroll_date) {\n//                 frappe.msgprint(\"Please select Payroll Date first.\");\n//                 return;\n//             }\n\n//             // 1️⃣ Selected Month Range\n//             let selected_date = frappe.datetime.str_to_obj(frm.doc.payroll_date);\n//             let month_start = frappe.datetime.obj_to_str(frappe.datetime.month_start(selected_date));\n//             let month_end = frappe.datetime.obj_to_str(frappe.datetime.month_end(selected_date));\n\n//             // 2️⃣ Standard Hours from HR Settings\n//             let hr_settings = await frappe.db.get_doc(\"HR Settings\");\n//             let standard_hours = hr_settings.standard_working_hours || 0;\n\n//             // 3️⃣ Working Hours for Selected Month ONLY\n//             let wh_data = await frappe.db.get_list(\"Daily Working Hours\", {\n//                 fields: [\"employee_id\", \"total_hours\"],\n//                 filters: {\n//                     date: [\"between\", [month_start, month_end]]\n//                 },\n//                 limit: 5000\n//             });\n\n//             // If no data → no employees should fetch\n//             if (!wh_data.length) {\n//                 frm.clear_table(\"table_rbxn\");\n//                 frm.refresh_field(\"table_rbxn\");\n//                 frappe.msgprint(\"No attendance records found for selected month.\");\n//                 return;\n//             }\n\n//             // 4️⃣ Build employee → summed hours map\n//             let employees_with_hours = {};\n//             wh_data.forEach(row => {\n//                 if (!employees_with_hours[row.employee_id]) {\n//                     employees_with_hours[row.employee_id] = 0;\n//                 }\n//                 employees_with_hours[row.employee_id] += Number(row.total_hours || 0);\n//             });\n\n//             let employee_ids = Object.keys(employees_with_hours);\n\n//             // 5️⃣ Fetch active employees with attendance data\n//             let employees = await frappe.db.get_list(\"Employee\", {\n//                 fields: [\"name\", \"employee_name\"],\n//                 filters: [\n//                     [\"status\", \"=\", \"Active\"],\n//                     [\"name\", \"in\", employee_ids]\n//                 ],\n//                 limit: 5000\n//             });\n\n//             frm.clear_table(\"table_rbxn\");\n\n//             if (!employees.length) {\n//                 frm.refresh_field(\"table_rbxn\");\n//                 frappe.msgprint(\"No active employees have attendance in this month.\");\n//                 return;\n//             }\n\n//             // 6️⃣ Create child table rows\n//             for (let emp of employees) {\n\n//                 let actual_hours = employees_with_hours[emp.name];\n\n//                 // ⭐ DIFFERENCE LOGIC (your exact rule)\n//                 let difference = Math.abs((standard_hours || 0) - (actual_hours || 0));\n\n//                 // ⭐ REGULATION SELECTION\n//                 let regulation = \"\";\n//                 if (difference === 0) {\n//                     regulation = \"Full monthly working hours\";\n//                 } \n//                 else if (difference >= 4 && difference <= 8) {\n//                     regulation = \"Unexcused absence 4–8 working hours/month\";\n//                 } \n//                 else if (difference > 8) {\n//                     regulation = \"Unexcused absence over 8 working hours/month\";\n//                 }\n\n//                 // ➕ Add row in child table\n//                 let row = frm.add_child(\"table_rbxn\");\n//                 row.employee = emp.name;\n//                 row.standard_working_hours = standard_hours;\n//                 row.actual_working_hours = actual_hours;\n//                 row.difference = difference;\n//                 row.regulation = regulation;\n\n//                 // ⭐ Fetch Allowance from Attendance Regulation doctype\n//                 try {\n//                     if (regulation) {\n//                         let reg_doc = await frappe.db.get_doc(\"Attendance Regulation\", regulation);\n//                         row.allowance_amount = reg_doc.allowance_amount || 0;\n//                     } else {\n//                         row.allowance_amount = 0;\n//                     }\n//                 } catch (e) {\n//                     row.allowance_amount = 0;\n//                 }\n//             }\n\n//             frm.refresh_field(\"table_rbxn\");\n//             frappe.show_alert(\"Employees loaded with correct regulations and allowance.\");\n//         });\n//     }\n// });\n\nfrappe.ui.form.on(\"Attendance Bonus\", {\n  payroll_date(frm) {\n    frm.clear_table(\"table_rbxn\");\n    frm.refresh_field(\"table_rbxn\");\n  },\n\n  refresh(frm) {\n    // safest to avoid duplicates\n    frm.clear_custom_buttons();\n\n    frm.add_custom_button(\"Fetch Employee\", async function () {\n      if (!frm.doc.payroll_date) {\n        frappe.msgprint(\"Please select Payroll Date first.\");\n        return;\n      }\n      if (!frm.doc.company) {\n        frappe.msgprint(\"Please select Company first.\");\n        return;\n      }\n\n      frm.clear_table(\"table_rbxn\");\n      frm.refresh_field(\"table_rbxn\");\n\n      try {\n        const r = await frappe.call({\n          method: \"attendance_bonus_build_rows\",\n          args: {\n            payroll_date: frm.doc.payroll_date,\n            company: frm.doc.company\n          }\n        });\n\n        const msg = r.message || {};\n        const rows = msg.rows || [];\n\n        if (!rows.length) {\n          frappe.msgprint(`No Daily Working Hours found between ${msg.month_start} and ${msg.month_end}.`);\n          return;\n        }\n\n        for (const rr of rows) {\n          const row = frm.add_child(\"table_rbxn\");\n          row.employee = rr.employee;\n          row.standard_working_hours = rr.standard_working_hours;\n          row.actual_working_hours = rr.actual_working_hours;\n          row.difference = rr.difference;\n          row.regulation = rr.regulation;\n          row.allowance_amount = rr.allowance_amount;\n          row.designation = rr.designation;\n          row.missing_days = rr.missing_days;\n        }\n\n        frm.refresh_field(\"table_rbxn\");\n        frappe.show_alert(`Loaded ${rows.length} employees (${msg.month_start} → ${msg.month_end}).`);\n      } catch (e) {\n        console.error(e);\n        frappe.msgprint(\"Failed to fetch rows. Check console.\");\n      }\n    });\n  }\n});\n\n\n\n\n\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Additional Salary",
  "enabled": 1,
  "modified": "2025-12-05 02:47:52.446317",
  "module": null,
  "name": "Additional Pay",
  "script": "frappe.ui.form.on(\"Additional Salary\", {\n\n    employee(frm) {\n        frm.trigger(\"calculate_ot\");\n    },\n\n    payroll_date(frm) {\n        frm.trigger(\"calculate_ot\");\n    },\n\n    refresh(frm) {\n        if (frm.doc.employee && frm.doc.payroll_date) {\n            frm.trigger(\"calculate_ot\");\n        }\n    },\n\n    calculate_ot(frm) {\n\n        // Step 1: Validation\n        if (!frm.doc.employee || !frm.doc.payroll_date) return;\n\n        const employee = frm.doc.employee;\n        const d = frm.doc.payroll_date;\n\n        // Step 2: Month Range (start_date → end_date)\n        const year = parseInt(d.substring(0, 4));\n        const month = parseInt(d.substring(5, 7));\n\n        const start_date = `${year}-${String(month).padStart(2, '0')}-01`;\n        const last_day = new Date(year, month, 0).getDate();\n        const end_date = `${year}-${String(month).padStart(2, '0')}-${last_day}`;\n\n        // Step 3: Fetch Overtime\n        frappe.call({\n            method: \"frappe.client.get_list\",\n            args: {\n                doctype: \"Employee Overtime\",\n                fields: [\"employee_id\", \"date\", \"overtime_hours\", \"hourly_rate\", \"docstatus\"],\n                limit_page_length: 5000\n            },\n\n            callback(r) {\n                const rows = r.message || [];\n\n                // Step 4: Filter Overtime\n                const overtime = rows.filter(row => {\n                    return (\n                        row.employee_id === employee &&\n                        row.docstatus !== 2 &&        // Not Cancelled\n                        row.date >= start_date &&\n                        row.date <= end_date\n                    );\n                });\n\n                // Step 5: If No OT Found\n                if (!overtime.length) {\n                    frm.set_value(\"custom_total_overtime_hours\", 0);\n                    frm.set_value(\"custom_hourly_rate\", 0);\n                    frm.set_value(\"amount\", 0);\n                    return;\n                }\n\n                // Step 6: Calculate\n                const total_hours = overtime.reduce((sum, r) => {\n                    return sum + (parseFloat(r.overtime_hours) || 0);\n                }, 0);\n\n                const hourly_rate = parseFloat(overtime[overtime.length - 1].hourly_rate || 0);\n                const amount = total_hours * hourly_rate;\n\n                // Step 7: Set Values in Form\n                frm.set_value(\"custom_total_overtime_hours\", total_hours);\n                frm.set_value(\"custom_hourly_rate\", hourly_rate);\n                frm.set_value(\"amount\", amount);\n            }\n        });\n    }\n});\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "KPI Bonus Pay",
  "enabled": 1,
  "modified": "2026-01-12 13:26:32.143463",
  "module": null,
  "name": "KPI Bonus Pay",
  "script": "frappe.ui.form.on('KPI Bonus Pay', {\n    refresh(frm) {\n        if (frm.doc.kpi_bonus && frm.doc.kpi_bonus.length > 0) {\n            frm.doc.kpi_bonus.forEach(row => {\n                calculate_kpi_bonus(frm, row.doctype, row.name);\n            });\n        }\n    }\n});\n\nfrappe.ui.form.on(\"KPI Bonus Table\", {\n\n    line(frm, cdt, cdn) {\n        calculate_kpi_bonus(frm, cdt, cdn);\n    },\n\n    average_outputdayline_pcs(frm, cdt, cdn) {\n        calculate_kpi_bonus(frm, cdt, cdn);\n    },\n\n    monthly_output(frm, cdt, cdn) {\n        // Even if monthly output changes, recalc should run\n        calculate_kpi_bonus(frm, cdt, cdn);\n    }\n});\n\n\n// --------------------- MAIN CALCULATION FUNCTION ------------------------\n\nfunction calculate_kpi_bonus(frm, cdt, cdn) {\n\n    let row = locals[cdt][cdn];\n\n    let line = row.line || \"\";\n    let avg = Number(row.average_outputdayline_pcs) || 0;   // ONLY THIS decides KPI Bonus\n\n    if (!line) {\n        frappe.model.set_value(cdt, cdn, \"kpi_bonus\", 0);\n        return;\n    }\n\n    // --------------------- KPI RULES BASED ONLY ON AVERAGE OUTPUT ---------------------\n\n    const KPI = {\n\n        \"Melin\": [\n            {a1: 0,   a2: 649, bonus: 0},\n            {a1: 650, a2: 749, bonus: 500000},\n            {a1: 750, a2: 899, bonus: 700000},\n            {a1: 900, a2: 999999999, bonus: 1000000}\n        ],\n\n        \"Baller\": [\n            {a1: 0,    a2: 1799, bonus: 0},\n            {a1: 1800, a2: 2199, bonus: 500000},\n            {a1: 2200, a2: 2599, bonus: 700000},\n            {a1: 2600, a2: 999999999, bonus: 1000000}\n        ],\n\n        \"Both\": [\n            {a1: 0,    a2: 724, bonus: 0},\n            {a1: 725,  a2: 849, bonus: 500000},\n            {a1: 850,  a2: 999, bonus: 700000},\n            {a1: 1000, a2: 999999999, bonus: 1000000}\n        ]\n    };\n\n    // --------------------- FIND MATCHING RULE ---------------------\n\n    let bonus = 0;\n\n    KPI[line].some(rule => {\n        if (avg >= rule.a1 && avg <= rule.a2) {\n            bonus = rule.bonus;\n            return true;   // Stop loop once matched\n        }\n    });\n\n    frappe.model.set_value(cdt, cdn, \"kpi_bonus\", bonus);\n}\n\n\n\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Payroll Entry",
  "enabled": 1,
  "modified": "2025-12-05 01:12:50.346505",
  "module": null,
  "name": "Payroll Entry Employee Total Hours",
  "script": "frappe.ui.form.on('Payroll Employee Detail', {\r\n\r\n    // Triggered whenever the Employee field changes inside the child table row\r\n    employee(frm, cdt, cdn) {\r\n\r\n        // Get the row (child table document)\r\n        const row = locals[cdt][cdn];\r\n\r\n        // If no employee selected, stop the function\r\n        if (!row.employee) return;\r\n\r\n        // Read Start Date and End Date from the parent Payroll Entry doctype\r\n        const start_date = frm.doc.start_date;\r\n        const end_date = frm.doc.end_date;\r\n\r\n        // These dates must be selected before fetching working hours data\r\n        if (!start_date || !end_date) {\r\n            frappe.msgprint(\"Please select Start Date and End Date on Payroll Entry.\");\r\n            return;\r\n        }\r\n\r\n        // Fetch data from Daily Working Hours doctype for this employee\r\n        // Filters:\r\n        //   - employee_id matches selected employee\r\n        //   - date is between start_date and end_date\r\n        frappe.db.get_list('Daily Working Hours', {\r\n            filters: {\r\n                employee_id: row.employee,\r\n                date: ['between', [start_date, end_date]]\r\n            },\r\n            fields: ['total_hours'],   // Only fetch total_hours field\r\n            limit_page_length: 5000    // Safety limit for large datasets\r\n        }).then(records => {\r\n\r\n            // Sum all total_hours values from the fetched records\r\n            let total = 0;\r\n            records.forEach(r => {\r\n                // (r.total_hours || 0) ensures we don't add \"undefined\"\r\n                total += r.total_hours || 0;\r\n            });\r\n\r\n            // Set the total into the child table field: custom_total_working_hour\r\n            frappe.model.set_value(cdt, cdn, 'custom_total_working_hour', total);\r\n\r\n        });\r\n    }\r\n});\r\n\r\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Salary Structure Assignment",
  "enabled": 0,
  "modified": "2026-01-16 01:58:05.913517",
  "module": null,
  "name": "Salary Stucture",
  "script": "frappe.ui.form.on(\"Salary Structure Assignment\", {\n    refresh(frm) {\n        calculate_custom_hourly_rate(frm);\n    },\n\n    // Trigger on change of any custom salary field\n    custom_basic_salary:        frm => calculate_custom_hourly_rate(frm),\n    custom_meal_allowance:      frm => calculate_custom_hourly_rate(frm),\n    custom_uniform_allowance:   frm => calculate_custom_hourly_rate(frm),\n    custom_fuel_allowance:      frm => calculate_custom_hourly_rate(frm),\n    custom_skill_allowance:     frm => calculate_custom_hourly_rate(frm),\n    custom_house_allowance:     frm => calculate_custom_hourly_rate(frm),\n    custom_child_allowance:     frm => calculate_custom_hourly_rate(frm),\n    custom_women_allowance:     frm => calculate_custom_hourly_rate(frm),\n    custom_toxic_allowance:     frm => calculate_custom_hourly_rate(frm),\n    custom_phone_allowance:     frm => calculate_custom_hourly_rate(frm),\n    custom_hourly_rate_input:   frm => calculate_custom_hourly_rate(frm)\n});\n\n\nfunction calculate_custom_hourly_rate(frm) {\n    let fields = [\n        \"custom_basic_salary\",\n        \"custom_meal_allowance\",\n        \"custom_uniform_allowance\",\n        \"custom_fuel_allowance\",\n        \"custom_skill_allowance\",\n        \"custom_house_allowance\",\n        \"custom_child_allowance\",\n        \"custom_women_allowance\",\n        \"custom_toxic_allowance\",\n        \"custom_phone_allowance\",\n        \"custom_hourly_rate_input\"\n    ];\n\n    let total = 0;\n\n    fields.forEach(f => {\n        total += flt(frm.doc[f]);\n    });\n\n    frm.set_value(\"custom_hourly_rate\", total);\n    frm.refresh_field(\"custom_hourly_rate\");\n}\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Sewing Line Incentive",
  "enabled": 1,
  "modified": "2025-12-14 17:58:33.037335",
  "module": null,
  "name": "Sewing Line Incentive Fetching Based On Line",
  "script": "frappe.ui.form.on('Sewing Line Incentive', {\r\n  employee(frm) {\r\n    if (!frm.doc.employee) return;\r\n\r\n    if (!frm.doc.line) {\r\n      frappe.msgprint(\"Please select Line first.\");\r\n      return;\r\n    }\r\n\r\n    if (!frm.doc.from_date || !frm.doc.to_date) {\r\n      frappe.msgprint(\"Please select From Date and To Date.\");\r\n      return;\r\n    }\r\n\r\n    frappe.call({\r\n      method: \"get_pcs_documents_for_line\",\r\n      args: {\r\n        line: frm.doc.line,\r\n        from_date: frm.doc.from_date,\r\n        to_date: frm.doc.to_date,\r\n        employee: frm.doc.employee,\r\n\r\n        // document context for server-side update\r\n        doctype: frm.doctype,\r\n        docname: frm.doc.name\r\n      },\r\n      freeze: true,\r\n      freeze_message: \"Fetching monthly output, KPI & incentives...\",\r\n      callback(r) {\r\n        frm.clear_table('sewing_line_incentive_item');\r\n\r\n        const result = r.message || {};\r\n        const rows = result.rows || [];\r\n        const totalLineIncentive = result.total_line_incentive || 0;\r\n\r\n        if (!rows.length) {\r\n          frappe.msgprint(\r\n            \"No product totals found for this employee in the selected line and date range.\"\r\n          );\r\n          frm.refresh_field('sewing_line_incentive_item');\r\n          frm.set_value('total_line_incentive', 0);\r\n          return;\r\n        }\r\n\r\n        rows.forEach(row => {\r\n          const child = frm.add_child('sewing_line_incentive_item');\r\n\r\n          child.product_code = row.product_code || '';\r\n          child.monthly_output = row.total_quantity || 0;\r\n          child.kpi = row.kpi || 0;\r\n\r\n          // ✅ NEW: Line Incentive per product\r\n          child.line_incentive = row.line_incentive || 0;\r\n\r\n          // Optional (keep commented unless fields exist)\r\n          // child.ui = row.ui || 0;\r\n          // child.smv = row.smv || 0;\r\n          // child.quality_ratio = row.quality_ratio || 0;\r\n        });\r\n\r\n        frm.refresh_field('sewing_line_incentive_item');\r\n\r\n        // populate parent total\r\n        frm.set_value('total_line_incentive', totalLineIncentive);\r\n      }\r\n    });\r\n  }\r\n});\r\n\r\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Pcs Based Incentive",
  "enabled": 1,
  "modified": "2025-12-13 17:49:57.989403",
  "module": null,
  "name": "Pcs Based Incentive for Ironing",
  "script": "frappe.ui.form.on(\"Pcs Based Incentive\", {\r\n  line(frm) {\r\n    if (!frm.doc.line) return;\r\n    if (frm.doc.line_type !== \"Ironing\") return;\r\n\r\n    if (!frm.doc.from_date || !frm.doc.to_date) {\r\n      frappe.msgprint(\"Please set From Date and To Date first.\");\r\n      return;\r\n    }\r\n\r\n    frappe.call({\r\n      method: \"get_ironing_line_summary\",\r\n      args: {\r\n        line: frm.doc.line,\r\n        from_date: frm.doc.from_date,\r\n        to_date: frm.doc.to_date\r\n      },\r\n      freeze: true,\r\n      freeze_message: \"Fetching ironing line data...\",\r\n      callback(r) {\r\n        const rows = r.message?.rows || [];\r\n\r\n        frm.clear_table(\"employee_ironing_incentive\");\r\n\r\n        rows.forEach(x => {\r\n          const row = frm.add_child(\"employee_ironing_incentive\");\r\n          row.employee = x.employee;\r\n          row.designation = x.designation;\r\n          row.total_finished_products = x.total_qty;\r\n          row.avg_daily_output_pcs = x.avg_per_day;\r\n          row.kpi = x.kpi;\r\n\r\n          // ✅ incentive comes as employee_incentive from server\r\n          row.incentive_amount = x.employee_incentive;   // <-- change here\r\n        });\r\n\r\n        frm.refresh_field(\"employee_ironing_incentive\");\r\n        frappe.msgprint(`Added ${rows.length} rows to Employee Ironing Incentive.`);\r\n      }\r\n    });\r\n  }\r\n});\r\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Pcs Based Incentive",
  "enabled": 1,
  "modified": "2025-12-13 11:55:11.875380",
  "module": null,
  "name": "Filter Line",
  "script": "frappe.ui.form.on('Pcs Based Incentive', {\r\n    line_type(frm) {\r\n        apply_line_filter(frm);\r\n    },\r\n\r\n    refresh(frm) {\r\n        apply_line_filter(frm);\r\n    }\r\n});\r\n\r\nfunction apply_line_filter(frm) {\r\n    if (!frm.doc.line_type) {\r\n        frm.set_query('line', () => ({}));\r\n        return;\r\n    }\r\n\r\n    let keyword = '';\r\n\r\n    if (frm.doc.line_type === 'Ironing') {\r\n        keyword = 'Iron';\r\n    } else if (frm.doc.line_type === 'Sewing') {\r\n        keyword = 'Sew';\r\n    }\r\n\r\n    frm.set_query('line', () => ({\r\n        filters: [\r\n            ['name', 'like', `%${keyword}%`]\r\n        ]\r\n    }));\r\n}\r\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Pcs Based Incentive",
  "enabled": 1,
  "modified": "2025-12-13 11:58:08.363021",
  "module": null,
  "name": "Incentive Amount Calculation",
  "script": "// Parent doctype (optional - keep if you need parent events)\r\nfrappe.ui.form.on('Pcs Based Incentive', {\r\n    refresh(frm) {\r\n        // nothing needed for this calc\r\n    }\r\n});\r\n\r\n// Child table doctype (THIS is where the calc belongs)\r\nfrappe.ui.form.on('Employee Ironing Incentive', {\r\n    total_finished_products(frm, cdt, cdn) {\r\n        calculate_incentive(frm, cdt, cdn);\r\n    },\r\n    kpi(frm, cdt, cdn) {\r\n        calculate_incentive(frm, cdt, cdn);\r\n    }\r\n});\r\n\r\nfunction calculate_incentive(frm, cdt, cdn) {\r\n    const row = locals[cdt][cdn];\r\n\r\n    const total = flt(row.total_finished_products);\r\n    const kpi = flt(row.kpi);\r\n\r\n    row.incentive_amount = total * 400 * kpi;\r\n\r\n    frm.refresh_field('employee_ironing_incentive');\r\n}\r\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Pcs Based Incentive",
  "enabled": 1,
  "modified": "2025-12-13 12:06:27.745387",
  "module": null,
  "name": "KPI Calculation",
  "script": "// Client Script (Form) for parent doctype: \"Pcs Based Incentive\"\r\n// Child table fieldname example: \"employee_ironing_incentive_applied_position\"\r\n// Child doctype: \"Employee Ironing Incentive Applied Position\"\r\n\r\nfrappe.ui.form.on(\"Pcs Based Employee Incentive - Ironing\", {\r\n  avg_daily_output_pcs: function (frm, cdt, cdn) {\r\n    const row = locals[cdt][cdn];\r\n    const v = flt(row.avg_daily_output_pcs);\r\n\r\n    let kpi = 0.0;\r\n\r\n    if (!v && v !== 0) {\r\n      // empty/null -> clear KPI\r\n      row.kpi = null;\r\n      frm.refresh_field(\"employee_ironing_incentive\");\r\n      return;\r\n    }\r\n\r\n    if (v < 80) kpi = 0.0;\r\n    else if (v < 200) kpi = 1.0;     // 80..199\r\n    else if (v < 300) kpi = 1.2;     // 200..299\r\n    else kpi = 1.5;                  // >=300\r\n\r\n    frappe.model.set_value(cdt, cdn, \"kpi\", kpi);\r\n  },\r\n});\r\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Pcs Based Incentive",
  "enabled": 1,
  "modified": "2025-12-13 12:04:12.182168",
  "module": null,
  "name": "Ironing KPI",
  "script": "// Parent doctype (only keep if you actually need it)\r\nfrappe.ui.form.on('Pcs Based Incentive', {\r\n    refresh(frm) {\r\n        // nothing needed for this calculation\r\n    }\r\n});\r\n\r\n// Child table doctype\r\nfrappe.ui.form.on('Pcs Based Employee Incentive - Ironing', {\r\n    avg_daily_output_pcs(frm, cdt, cdn) {\r\n        calculate_kpi_and_incentive(frm, cdt, cdn);\r\n    },\r\n    total_finished_products(frm, cdt, cdn) {\r\n        calculate_kpi_and_incentive(frm, cdt, cdn);\r\n    }\r\n});\r\n\r\nfunction calculate_kpi_and_incentive(frm, cdt, cdn) {\r\n    const row = locals[cdt][cdn];\r\n\r\n    const avg = flt(row.avg_daily_output_pcs);\r\n    const total = flt(row.total_finished_products);\r\n\r\n    let kpi = 0.0;\r\n\r\n    if (avg >= 300) kpi = 1.5;\r\n    else if (avg >= 200) kpi = 1.2;\r\n    else if (avg >= 80) kpi = 1.0;\r\n    else kpi = 0.0;\r\n\r\n    row.kpi = kpi;\r\n\r\n    const rate_per_piece = 400;\r\n    row.incentive_amount = total * rate_per_piece * kpi;\r\n\r\n    // IMPORTANT: this must be the *child table fieldname* on the parent doctype\r\n    frm.refresh_field('employee_ironing_incentive');\r\n}\r\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Pcs Based Incentive",
  "enabled": 1,
  "modified": "2026-01-14 16:13:08.499127",
  "module": null,
  "name": "Additional Salary - Pcs Based Incentive - Ironing",
  "script": "frappe.ui.form.on(\"Pcs Based Incentive\", {\r\n  refresh(frm) {\r\n    if (frm.is_new()) return;\r\n\r\n    frm.clear_custom_buttons();\r\n\r\n    frm.add_custom_button(__(\"Create Additional Salary\"), () => {\r\n\r\n      frappe.call({\r\n        method: \"create_additional_salary_for_ironing\", // must match Server Script API Method\r\n        args: {\r\n          docname: frm.doc.name,\r\n          line_type: frm.doc.line_type\r\n        }\r\n      }).then(r => {\r\n        frappe.msgprint({\r\n          title: \"Server Response\",\r\n          message: `<pre>${frappe.utils.escape_html(JSON.stringify(r.message, null, 2))}</pre>`,\r\n          wide: true\r\n        });\r\n      });\r\n    });\r\n  }\r\n});\r\n\r\n\r\n\r\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Sewing Line Incentive",
  "enabled": 1,
  "modified": "2025-12-14 11:14:27.200433",
  "module": null,
  "name": "Filter Line on Sewing Line Incentive",
  "script": "frappe.ui.form.on('Sewing Line Incentive', {\r\n    refresh(frm) {\r\n        apply_sewing_line_filter(frm);\r\n    }\r\n});\r\n\r\nfunction apply_sewing_line_filter(frm) {\r\n    frm.set_query('line', () => ({\r\n        filters: [\r\n            ['name', 'like', '%Sew%']\r\n        ]\r\n    }));\r\n}\r\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Pcs Produced Per Day Per Employee",
  "enabled": 1,
  "modified": "2025-12-14 11:31:18.999676",
  "module": null,
  "name": "Filter Employee Based on Line in Pcs Produced Per Day",
  "script": "frappe.ui.form.on('Pcs Produced Per Day Per Employee', {\r\n    line(frm) {\r\n        apply_employee_filter(frm);\r\n    },\r\n\r\n    refresh(frm) {\r\n        apply_employee_filter(frm);\r\n    }\r\n});\r\n\r\nfunction apply_employee_filter(frm) {\r\n    if (!frm.doc.line) {\r\n        // If no line selected, don't restrict employees\r\n        frm.set_query('employee', () => ({}));\r\n        return;\r\n    }\r\n\r\n    frm.set_query('employee', () => ({\r\n        filters: {\r\n            department: frm.doc.line,\r\n            status: 'Active'\r\n        }\r\n    }));\r\n}\r\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Sewing Line Incentive",
  "enabled": 1,
  "modified": "2025-12-14 14:18:23.718872",
  "module": null,
  "name": "Fetch Line Rate for Sewing",
  "script": "frappe.ui.form.on(\"Sewing Line Incentive\", {\r\n  line(frm) {\r\n    if (!frm.doc.line) return;\r\n\r\n    frappe.call({\r\n      method: \"fetch_sewing_line_rate\", // API Method name (Server Script)\r\n      args: {\r\n        line: frm.doc.line\r\n      },\r\n      freeze: true,\r\n      freeze_message: \"Calculating line rate...\",\r\n      callback(r) {\r\n        const data = r.message;\r\n        if (!data) return;\r\n\r\n        frm.set_value(\"line_rate\", data.line_rate || 0);\r\n\r\n        // Optional debug\r\n        // console.log(data.rows);\r\n      }\r\n    });\r\n  }\r\n});\r\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Pcs Based Incentive",
  "enabled": 1,
  "modified": "2025-12-19 19:57:15.122826",
  "module": null,
  "name": "Pcs Based Incentive - Sewing",
  "script": "frappe.ui.form.on(\"Pcs Based Incentive\", {\r\n  line(frm) {\r\n    if (!frm.doc.line) {\r\n      frappe.msgprint(\"Line not selected yet.\");\r\n      return;\r\n    }\r\n\r\n    // Only for Sewing\r\n    if (frm.doc.line_type !== \"Sewing\") {\r\n      return;\r\n    }\r\n\r\n    if (!frm.doc.from_date || !frm.doc.to_date) {\r\n      frappe.msgprint(\"Please set From Date and To Date first.\");\r\n      return;\r\n    }\r\n\r\n    frappe.call({\r\n      method: \"get_sewing_employees_with_rates_and_hours\",\r\n      args: {\r\n        line: frm.doc.line,\r\n        from_date: frm.doc.from_date,\r\n        to_date: frm.doc.to_date\r\n      },\r\n      freeze: true,\r\n      freeze_message: \"Fetching employees & rates...\",\r\n      callback(r) {\r\n        const data = r.message || {};\r\n        const rows = data.rows || [];\r\n\r\n        // ✅ If Quality Ratio is missing, prompt and stop\r\n        if (!data.quality_ratio_exists) {\r\n          frappe.msgprint({\r\n            title: \"Quality Ratio Missing\",\r\n            indicator: \"orange\",\r\n            message: `\r\n              No Quality Ratio found for:<br><br>\r\n              <b>Line:</b> ${frappe.utils.escape_html(frm.doc.line)}<br>\r\n              <b>From Date:</b> ${frappe.utils.escape_html(frm.doc.from_date)}<br>\r\n              <b>To Date:</b> ${frappe.utils.escape_html(frm.doc.to_date)}<br><br>\r\n              Please create the Quality Ratio for these filters, then select the line again.\r\n            `\r\n          });\r\n\r\n          frm.clear_table(\"pcs_based_employee_incentive_table\");\r\n          frm.refresh_field(\"pcs_based_employee_incentive_table\");\r\n          return;\r\n        }\r\n\r\n        frm.clear_table(\"pcs_based_employee_incentive_table\");\r\n\r\n        if (!rows.length) {\r\n          frm.refresh_field(\"pcs_based_employee_incentive_table\");\r\n          return;\r\n        }\r\n\r\n        rows.forEach((x) => {\r\n          const row = frm.add_child(\"pcs_based_employee_incentive_table\");\r\n          row.employee = x.employee;\r\n          row.designation = x.designation;\r\n          row.skill_rate = x.skill_rate || 0;\r\n          row.operation_rate = x.operation_rate || 0;\r\n\r\n          // ✅ totals\r\n          row.standard_working_hours_total = x.standard_working_hours_total || 0;\r\n          row.actual_working_hours_total = x.actual_working_hours_total || 0;\r\n        });\r\n\r\n        frm.refresh_field(\"pcs_based_employee_incentive_table\");\r\n      }\r\n    });\r\n  }\r\n});\r\n\r\n\r\n\r\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Pcs Based Incentive",
  "enabled": 1,
  "modified": "2025-12-15 01:43:23.213981",
  "module": null,
  "name": "Final Calculation based on Sewing Line Incentive",
  "script": "frappe.ui.form.on(\"Pcs Based Incentive\", {\r\n  refresh(frm) {\r\n    // Show button only for Sewing\r\n    if (frm.doc.line_type !== \"Sewing\") return;\r\n\r\n    // Don't show on new/unsaved docs (optional but recommended)\r\n    if (frm.is_new()) return;\r\n\r\n    frm.add_custom_button(__(\"Generate Sewing Line Incentive\"), () => {\r\n      if (!frm.doc.line || !frm.doc.from_date || !frm.doc.to_date) {\r\n        frappe.msgprint(\"Please set Line, From Date and To Date first.\");\r\n        return;\r\n      }\r\n\r\n      frappe.call({\r\n        method: \"generate_sewing_line_incentive_links\",\r\n        args: {\r\n          docname: frm.doc.name\r\n        },\r\n        freeze: true,\r\n        freeze_message: \"Linking Sewing Line Incentive documents...\",\r\n        callback(r) {\r\n          frappe.msgprint(r.message || \"Done\");\r\n          frm.reload_doc();\r\n        }\r\n      });\r\n    });\r\n  }\r\n});\r\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Sales Order",
  "enabled": 1,
  "modified": "2025-12-15 17:25:26.324323",
  "module": null,
  "name": "rate on change",
  "script": "function update_shipping_rate(frm, cdt, cdn) {\n    let row = locals[cdt][cdn];\n    row.custom_shipping_rate= row.rate - row.fob_rate\n    frm.refresh_field(\"items\");\n    \n}\nfrappe.ui.form.on('Sales Order Item', {\n\trefresh(frm) {\n\t\t// your code here\n\t},\n\trate(frm, cdt, cdn) {\n\t    let row = locals[cdt][cdn];\n\t    if (row.fob_rate <= 0) {\n\t        return;\n\t    }\n\t    update_shipping_rate(frm, cdt, cdn)\n\t},\n\tfob_rate(frm, cdt, cdn) {\n\t   update_shipping_rate(frm, cdt, cdn)\n\t}\n})",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Quotation",
  "enabled": 1,
  "modified": "2025-12-15 17:24:57.644662",
  "module": null,
  "name": "update fob rate",
  "script": "function update_shipping_rate(frm, cdt, cdn) {\n    let row = locals[cdt][cdn];\n    row.custom_shipping_rate= row.rate - row.fob_rate\n    frm.refresh_field(\"items\");\n    \n}\nfrappe.ui.form.on('Quotation Item', {\n\trefresh(frm) {\n\t\t// your code here\n\t},\n\trate(frm, cdt, cdn) {\n\t    let row = locals[cdt][cdn];\n\t    if (row.fob_rate <= 0) {\n\t        return;\n\t    }\n\t    update_shipping_rate(frm, cdt, cdn)\n\t},\n\tfob_rate(frm, cdt, cdn) {\n\t   update_shipping_rate(frm, cdt, cdn)\n\t}\n})\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Sales Invoice",
  "enabled": 1,
  "modified": "2025-12-15 17:25:14.026441",
  "module": null,
  "name": "update rate for SI",
  "script": "\n\nfunction update_shipping_rate(frm, cdt, cdn) {\n    let row = locals[cdt][cdn];\n    row.custom_shipping_rate = row.rate - row.custom_fob_rate\n    frm.refresh_field(\"items\");\n    \n}\nfrappe.ui.form.on('Sales Invoice Item', {\n\trefresh(frm) {\n\t\t// your code here\n\t},\n\trate(frm, cdt, cdn) {\n\t    let row = locals[cdt][cdn];\n\t    if (row.fob_rate <= 0) {\n\t        return;\n\t    }\n\t    update_shipping_rate(frm, cdt, cdn)\n\t},\n\tfob_rate(frm, cdt, cdn) {\n\t   update_shipping_rate(frm, cdt, cdn)\n\t}\n})",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Monthly Overtime Calculator",
  "enabled": 1,
  "modified": "2025-12-19 14:40:49.789996",
  "module": null,
  "name": "Monthly Overtime",
  "script": "frappe.ui.form.on(\"Monthly Overtime Calculator\", {\n\n\trefresh(frm){\n\t\tfrm.add_custom_button(\"Fetch OT\", ()=>{\n\t\t\tfrm.trigger(\"fetch_ot_data\");\n\t\t});\n\t},\n\n\tfetch_ot_data(frm){\n\n\t\tif(!frm.doc.from_date || !frm.doc.to_date){\n\t\t\tfrappe.msgprint(\"Please select From Date and To Date\");\n\t\t\treturn;\n\t\t}\n\n\t\tfrappe.call({\n\t\t\tmethod: \"frappe.client.get_list\",\n\t\t\targs:{\n\t\t\t\tdoctype: \"Daily Working Hours\",\n\t\t\t\tfilters: {\n\t\t\t\t\t\"overtime_hours\": [\">\", 0],\n\t\t\t\t\t\"date\": [\"between\", [frm.doc.from_date, frm.doc.to_date]]\n\t\t\t\t},\n\t\t\t\tfields: [\n\t\t\t\t\t\"employee_id\",\n\t\t\t\t\t\"date\",\n\t\t\t\t\t\"overtime_hours\"\n\t\t\t\t]\n\t\t\t},\n\t\t\tcallback(r){\n\n\t\t\t\tfrm.clear_table(\"table_lanc\");\n\n\t\t\t\t(r.message || []).forEach(row => {\n\n\t\t\t\t\tlet child = frm.add_child(\"table_lanc\");\n\n\t\t\t\t\tchild.employee = row.employee_id;\n\t\t\t\t\tchild.date = row.date;\n\t\t\t\t\tchild.ot_hours = row.overtime_hours;\n\n\t\t\t\t\tchild.formula = \"Default Formula\";\n\t\t\t\t\tchild.multiplier = 1.5;\n\t\t\t\t\tchild.hourly_rate = 200;\n\n\t\t\t\t\tchild.ot_amount = row.overtime_hours * 200 * 1.5;\n\n\t\t\t\t});\n\n\t\t\t\tfrm.refresh_field(\"table_lanc\");\n\n\t\t\t\tif(r.message.length){\n\t\t\t\t\tfrappe.msgprint(\"OT Records Added Successfully\");\n\t\t\t\t}else{\n\t\t\t\t\tfrappe.msgprint(\"No OT Data Found!\");\n\t\t\t\t}\n\t\t\t}\n\t\t})\n\t}\n});\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Quality Ratio For Sewing Line",
  "enabled": 1,
  "modified": "2025-12-19 15:47:58.427529",
  "module": null,
  "name": "Quality Ratio for Sewing Line Based on Defect Rate",
  "script": "frappe.ui.form.on(\"Quality Ratio For Sewing Line\", {\r\n  monthly_defect_rate(frm) {\r\n    set_quality_ratio(frm);\r\n  }\r\n});\r\n\r\nfunction set_quality_ratio(frm) {\r\n  const rate = frm.doc.monthly_defect_rate;\r\n\r\n  if (!rate) return;\r\n\r\n  if (rate === \">5%\") {\r\n    frm.set_value(\"quality_ratio\", 0.9);\r\n  } \r\n  else if (rate === \"3% to 5%\") {\r\n    frm.set_value(\"quality_ratio\", 1);\r\n  } \r\n  else if (rate === \"<3%\") {\r\n    frm.set_value(\"quality_ratio\", 1.1);\r\n  }\r\n}\r\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Workstation",
  "enabled": 1,
  "modified": "2026-01-12 16:37:06.148416",
  "module": null,
  "name": "Show Dialog Complete Job",
  "script": "function filter_completed_items(dialog) {\n    const keyword = (dialog.get_value(\"search\") || \"\").toLowerCase();\n    const grid = dialog.fields_dict.completed_items.grid;\n\n    grid.grid_rows.forEach(row => {\n        const doc = row.doc;\n\n        const match =\n            (doc.item_code && doc.item_code.toLowerCase().includes(keyword)) ||\n            (doc.status && doc.status.toLowerCase().includes(keyword));\n\n        $(row.row).toggle(match || !keyword);\n    });\n}\n\nfrappe.ui.form.on('Workstation', {\n    refresh(frm) {\n        setTimeout(() => {\n            let jobs = $('.section-head-job-card');\n            $('.custom-actions').removeClass('hidden-md')\n            $('.custom-actions').removeClass('hidden-xs')\n            jobs.each((index, item) => {\n                $(item).find('input[name=\"job_card[]\"]').remove();\n                $(item).prepend('<input type=\"checkbox\" name=\"job_card[]\" />');\n            });\n        }, 1000);\n        \n        setTimeout(() => {\n            $('.custom-actions').removeClass('hidden-md')\n            $('.custom-actions').removeClass('hidden-xs')\n        }, 1000);\n\n\n        frm.add_custom_button('Complete Jobs', () => {\n\n            let checked = $('.section-head-job-card').find('input[name=\"job_card[]\"]:checked');\n            let stopJobCards = [];\n\n            checked.each((index, item) => {\n                let po = $(item)\n                    .closest('.section-head-job-card')\n                    .closest('.job-card-link')\n                    .data('name');\n\n                if (po) stopJobCards.push(po);\n            });\n\n            // if (stopJobCards.length === 0) return;\n            frappe.call({\n                method: \"get_job_card_selected\",\n                args: { job_cards: stopJobCards, workstation: frm.doc.name},\n                callback: function (r) {\n                    if (!r.exc) {\n                        let dialog = new frappe.ui.Dialog({\n                            title: __(\"Complete Jobs\"),\n                            size: \"extra-large\",\n                            fields: [\n                                {\n                                    fieldname: \"search\",\n                                    fieldtype: \"Data\",\n                                    label: __(\"Search\"),\n                                    placeholder: __(\"Search Item\"),\n                                    onchange() {\n                                        filter_completed_items(dialog);\n                                    }\n                                },\n                                // {\n                                //     fieldname: \"btn_search\",\n                                //     fieldtype: \"Button\",\n                                //     label: __(\"Search\"),\n                                //     click() {\n                                //         filter_completed_items(dialog);\n                                //     }\n                                // },\n                                {\n                                    fieldname: \"completed_items\",\n                                    fieldtype: \"Table\",\n                                    cannot_add_rows: true,\n                                    in_place_edit: false,\n                                    reqd: 1,\n                                    data: r.message.map(jc => ({\n                                        docname: jc.name,\n                                        job_card: jc.name,\n                                        item_code: jc.production_item,\n                                        status: jc.status,\n                                        total_completed_qty: jc.total_completed_qty,\n                                        for_quantity: jc.for_quantity,\n                                        completed_qty: 0,\n                                        is_done: 0,\n                                        qc_quantity_fail: 0,\n                                        qc_quantity_pass: 0,\n                                        qc_quantity_note: ''\n                                    })),\n                                    fields: [\n                                        { fieldtype: \"Data\", fieldname: \"docname\", hidden: 1 },\n                                        { fieldtype: \"Link\", fieldname: \"item_code\", options: \"Item\", in_list_view: 1, in_list_filter: 1, read_only: 1, label: __(\"Item\") },\n                                        { fieldtype: \"Data\", fieldname: \"status\", in_list_view: 1, read_only: 1, label: __(\"Status\") },\n                                        { fieldtype: \"Float\", fieldname: \"for_quantity\", default: 0, in_list_view: 1, read_only: 1, label: __(\"Qty for Manufacture\") },\n                                        { fieldtype: \"Float\", fieldname: \"completed_qty\", default: 0, in_list_view: 1, label: __(\"Quantity\") },\n                                        { fieldtype: \"Float\", fieldname: \"total_completed_qty\", default: 0, in_list_view: 1, read_only: 1, label: __(\"Completed Qty\") },\n                                        \n                                        // { fieldtype: \"Float\", fieldname: \"qc_quantity_fail\", in_list_view: 1, read_only: 1, label: __(\"QC Quantity Fail\") },\n                                        // { fieldtype: \"Float\", fieldname: \"qc_quantity_pass\", in_list_view: 1, read_only: 1, label: __(\"QC Quantity Pass\") },\n                                        { fieldtype: \"Data\", fieldname: \"qc_quantity_note\", in_list_view: 1, label: __(\"QC Note\") },\n                                        { fieldtype: \"Check\", fieldname: \"is_done\", in_list_view: 1, label: __(\"Is Complete\"), in_list_view: 1},\n                                    ],\n                                },\n                            ],\n                            primary_action_label: __(\"Update\"),\n                            primary_action: function () {\n                                const completed_items = this.get_values()[\"completed_items\"].filter(i => !!i.item_code);\n                                dialog.fields_dict.completed_items.grid.grid_rows.forEach(row => {\n                                   let el = $(row.row).find('input[name=\"is_done[]\"]');\n                                   if (el.is(':checked')) {\n                                        let item_code = $(el).data('value')\n                                        let item = completed_items.find(i => i.item_code === item_code);\n                                        if (item) {\n                                            item.is_done = 1;\n                                        }\n                                    }\n                                })\n                                frappe.call({\n                                    method: \"update_completed_qty\",\n                                    freeze: true,\n                                    args: {\n                                        parent_doctype: frm.doc.doctype,\n                                        completed_items: completed_items,\n                                        parent_doctype_name: frm.doc.name,\n                                        user: frappe.user.name \n                                    },\n                                    callback: function (r) {\n                                        frm.reload_doc();\n                                    }\n                                });\n                                this.hide();\n                            }\n                        });\n\n                        dialog.show();\n                        let table_wrapper =\n                            dialog.fields_dict.completed_items.$wrapper;\n                        table_wrapper.find('.grid-body').css({\n                            'max-height': '400px',\n                            'overflow-y': 'scroll'\n                        });\n                        dialog.$wrapper.find(\".modal-dialog\").css({\n                            width: \"95vw\",\n                            maxWidth: \"1400px\"\n                        });\n                        $(table_wrapper).find('.grid-heading-row').find('.grid-row').find('.data-row').find('.col').last().css({'text-align': 'center'}).text('Done')\n                        dialog.fields_dict.completed_items.grid.grid_rows.forEach(row => {\n                            let el = $(row.row).find('[data-fieldname=\"status\"]').find('.static-area')\n                            $(row.row).find('.col').last().css({'text-align': 'center'}).html('').append(`<input type=\"checkbox\" data-value=\"${row.doc.item_code}\" name=\"is_done[]\" />`)\n                            let status = el.text()\n                            if (status == 'Open') {\n                                el.css({\n                                    'background': 'var(--bg-red)',\n                                    'text-align': 'center',\n                                    'border-radius': 'var(--border-radius-full)',\n                                    'color': 'var(--text-on-red)'\n                                });\n                            } else if(status == 'Completed') {\n                                el.css({\n                                    'background': 'var(--bg-green)',\n                                    'text-align': 'center',\n                                    'border-radius': 'var(--border-radius-full)',\n                                    'color': 'var(--text-on-green)'\n                                });\n                            } else {\n                                el.css({\n                                    'background': 'var(--bg-orange)',\n                                    'text-align': 'center',\n                                    'border-radius': 'var(--border-radius-full)'\n                                });\n                            }\n                        });\n                    } else {\n                        frappe.msgprint(__(\"Failed to get job cards\"));\n                    }\n                }\n            });\n        });\n    }\n});\n\nfrappe.ui.form.on(\"Workstation\", {\n    refresh(frm) {\n        $('.layout-side-section').css({'display': 'none'})\n        frm.$wrapper.on(\"click\", \".form-dashboard-section\", function (e) {\n            if ($(this).hasClass(\"job-active\")) {\n                $(this).removeClass(\"job-active\")\n                $(this).css({\"background-color\": \"\"});\n                $(this).find('.section-head-job-card').find('input[name=\"job_card[]\"]').prop('checked', false)\n            } else {\n                $(this).addClass(\"job-active\")\n                $(this).css({\"background-color\": \"#e6f0f0\"});\n                $(this).find('.section-head-job-card').find('input[name=\"job_card[]\"]').prop('checked', true)\n            }   \n        });\n        \n        setTimeout(() => {\n            $('.frappe-control .timer').remove()\n        }, 1000)\n    }\n});\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Sewing Line Incentive",
  "enabled": 1,
  "modified": "2025-12-23 14:43:57.348250",
  "module": null,
  "name": "Sewing Line Incentive Direct Monthly Input",
  "script": "frappe.ui.form.on(\"Sewing Line Incentive\", {\r\n  refresh(frm) {\r\n    if (frm.is_new()) return;\r\n    if (frm.doc.docstatus !== 0) return;\r\n\r\n    frm.add_custom_button(__(\"Calculate Avg/Day\"), () => {\r\n      frappe.call({\r\n        method: \"generate_sli_incentives\",\r\n        args: { docname: frm.doc.name },\r\n        freeze: true,\r\n        freeze_message: \"Calculating Avg Output/Day...\",\r\n        callback(r) {\r\n          frappe.msgprint(r.message || \"Done\");\r\n          frm.reload_doc();\r\n        }\r\n      });\r\n    });\r\n  }\r\n});\r\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Sales Order",
  "enabled": 1,
  "modified": "2026-01-15 08:47:45.454259",
  "module": null,
  "name": "Add Total Billed On Sales Order",
  "script": "frappe.listview_settings[\"Sales Order\"] = {\r\n\tadd_fields: [\r\n\t\t\"base_grand_total\",\r\n\t\t\"customer_name\",\r\n\t\t\"currency\",\r\n\t\t\"delivery_date\",\r\n\t\t\"per_delivered\",\r\n\t\t\"per_billed\",\r\n\t\t\"status\",\r\n\t\t\"order_type\",\r\n\t\t\"name\",\r\n\t\t\"skip_delivery_note\",\r\n\t\t\"custom_total_billed\"\r\n\t],\r\n\tget_indicator: function (doc) {\r\n\t\tif (doc.status === \"Closed\") {\r\n\t\t\t// Closed\r\n\t\t\treturn [__(\"Closed\"), \"green\", \"status,=,Closed\"];\r\n\t\t} else if (doc.status === \"On Hold\") {\r\n\t\t\t// on hold\r\n\t\t\treturn [__(\"On Hold\"), \"orange\", \"status,=,On Hold\"];\r\n\t\t} else if (doc.status === \"Completed\") {\r\n\t\t\treturn [__(\"Completed\"), \"green\", \"status,=,Completed\"];\r\n\t\t} else if (!doc.skip_delivery_note && flt(doc.per_delivered) < 100) {\r\n\t\t\tif (frappe.datetime.get_diff(doc.delivery_date) < 0) {\r\n\t\t\t\t// not delivered & overdue\r\n\t\t\t\treturn [\r\n\t\t\t\t\t__(\"Overdue\"),\r\n\t\t\t\t\t\"red\",\r\n\t\t\t\t\t\"per_delivered,<,100|delivery_date,<,Today|status,!=,Closed|docstatus,=,1\",\r\n\t\t\t\t];\r\n\t\t\t} else if (flt(doc.grand_total) === 0) {\r\n\t\t\t\t// not delivered (zeroount order)\r\n\t\t\t\treturn [\r\n\t\t\t\t\t__(\"To Deliver\"),\r\n\t\t\t\t\t\"orange\",\r\n\t\t\t\t\t\"per_delivered,<,100|grand_total,=,0|status,!=,Closed|docstatus,=,1\",\r\n\t\t\t\t];\r\n\t\t\t} else if (flt(doc.per_billed) < 100) {\r\n\t\t\t\t// not delivered & not billed\r\n\t\t\t\treturn [\r\n\t\t\t\t\t__(\"To Deliver and Bill\"),\r\n\t\t\t\t\t\"orange\",\r\n\t\t\t\t\t\"per_delivered,<,100|per_billed,<,100|status,!=,Closed\",\r\n\t\t\t\t];\r\n\t\t\t} else {\r\n\t\t\t\t// not billed\r\n\t\t\t\treturn [__(\"To Deliver\"), \"orange\", \"per_delivered,<,100|per_billed,=,100|status,!=,Closed\"];\r\n\t\t\t}\r\n\t\t} else if (\r\n\t\t\tflt(doc.per_delivered) === 100 &&\r\n\t\t\tflt(doc.grand_total) !== 0 &&\r\n\t\t\tflt(doc.per_billed) < 100\r\n\t\t) {\r\n\t\t\t// to bill\r\n\t\t\treturn [__(\"To Bill\"), \"orange\", \"per_delivered,=,100|per_billed,<,100|status,!=,Closed\"];\r\n\t\t} else if (doc.skip_delivery_note && flt(doc.per_billed) < 100) {\r\n\t\t\treturn [__(\"To Bill\"), \"orange\", \"per_billed,<,100|status,!=,Closed\"];\r\n\t\t}\r\n\t},\r\n\tformatters: {\r\n\t\tcustom_total_billed(value, df, doc) {\r\n\t\t\tlet percent = ((doc?.custom_total_billed/doc.grand_total) * 100).toFixed(1);\r\n\t\t\tlet color = percent >= 100 ? \"green\" : \"orange\";\r\n\t\t\tif (percent == 0 || doc.grand_total == 0 || doc?.custom_total_billed < 0) {\r\n\t\t\t   return `<div data-sale-order=\"${doc.name}\" class=\"progress persent\" style=\"height: 20px;\" data-delivered-qty=\"0\" data-sale-order-total-quantity=\"${doc.total_qty}\" data-total-billed=\"${doc?.custom_total_billed || ''}\" >\r\n                          <div class=\"progress-bar progress-bar progress-bar-success\" role=\"progressbar\" style=\"width: 0%\" aria-valuenow=\"0\" aria-valuemin=\"0\" aria-valuemax=\"300\">0%</div>\r\n                        </div>`;\r\n\t\t\t} else {\r\n\t\t\t    return `<div data-sale-order=\"${doc.name}\" class=\"progress persent\" style=\"height: 20px;\" data-delivered-qty=\"${doc.custom_total_delivered_qty}\" data-sale-order-total-quantity=\"${doc.total_qty}\" data-total-billed=\"${doc?.custom_total_billed || ''}\" >\r\n                          <div class=\"progress-bar progress-bar progress-bar-success\" role=\"progressbar\" style=\"width: ${percent}%; padding: 1px;\" aria-valuenow=\"${percent}\" aria-valuemin=\"0\" aria-valuemax=\"300\">${percent}%</div>\r\n                        </div>`\r\n\t\t\t}\r\n\t\t}\r\n\t},\r\n\tonload: function (listview) {\r\n\t   var method = \"erpnext.selling.doctype.sales_order.sales_order.close_or_unclose_sales_orders\";\r\n\r\n\t\tlistview.page.add_menu_item(__(\"Close\"), function () {\r\n\t\t\tlistview.call_for_selected_items(method, { status: \"Closed\" });\r\n\t\t});\r\n\r\n\t\tlistview.page.add_menu_item(__(\"Re-open\"), function () {\r\n\t\t\tlistview.call_for_selected_items(method, { status: \"Submitted\" });\r\n\t\t});\r\n\r\n\t\tif (frappe.model.can_create(\"Sales Invoice\")) {\r\n\t\t\tlistview.page.add_action_item(__(\"Sales Invoice\"), () => {\r\n\t\t\t\terpnext.bulk_transaction_processing.create(listview, \"Sales Order\", \"Sales Invoice\");\r\n\t\t\t});\r\n\t\t}\r\n\r\n\t\tif (frappe.model.can_create(\"Delivery Note\")) {\r\n\t\t\tlistview.page.add_action_item(__(\"Delivery Note\"), () => {\r\n\t\t\t\terpnext.bulk_transaction_processing.create(listview, \"Sales Order\", \"Delivery Note\");\r\n\t\t\t});\r\n\t\t}\r\n\r\n\t\tif (frappe.model.can_create(\"Payment Entry\")) {\r\n\t\t\tlistview.page.add_action_item(__(\"Advance Payment\"), () => {\r\n\t\t\t\terpnext.bulk_transaction_processing.create(listview, \"Sales Order\", \"Payment Entry\");\r\n\t\t\t});\r\n\t\t}\r\n        listview.page.wrapper.on(\r\n        'mouseover',\r\n        '.persent',\r\n        function () {\r\n            let total_billed = $(this).data('total-billed')\r\n            let sale_order = $(this).data('sale-order')\r\n            let el = $(this)\r\n            frappe.call({\r\n        \t\tmethod: 'get_total_summary',\r\n        \t\targs: {\r\n        \t\t\t'sale_order': sale_order\r\n        \t\t},\r\n        \t\tasync: false,\r\n        \t\tcallback: (r) => {\r\n        \t\t    console.log('re', r?.message)\r\n        \t\t    let total_delivered_qty = r?.message?.total_delivered_qty || 0\r\n        \t\t    let total_allocated_amount = r?.message?.total_allocated_amount || 0\r\n        \t\t    let so_total_qty = r?.message?.total_qty || 0\r\n                    el.tooltip({\r\n                        title: `\r\n                            <ul class=\"list-unstyled mb-0\">\r\n                                <li>\r\n                                    <b>Total SO Quantity:</b>\r\n                                    <span class=\"float-end\">${so_total_qty}</span>\r\n                                </li>\r\n                                <li>\r\n                                    <b>Delivered Quantity:</b>\r\n                                    <span class=\"float-end\">${total_delivered_qty}</span>\r\n                                </li>\r\n                                <li>\r\n                                    <b>Total Billed:</b>\r\n                                    <span class=\"float-end\">${format_currency(total_billed)}</span>\r\n                                </li>\r\n                                <li>\r\n                                    <b>Allocated Amount:</b>\r\n                                    <span class=\"float-end\">${format_currency(total_allocated_amount)}</span>\r\n                                </li>\r\n                            </ul>`\r\n                        ,\r\n                        placement: 'top',\r\n                        trigger: 'hover',\r\n                        html: true,\r\n                    }).tooltip('show');\r\n                }\r\n        \t});\r\n        }\r\n    );\r\n\t},\r\n};\r\n",
  "view": "List"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Delivery Note",
  "enabled": 0,
  "modified": "2025-12-26 13:44:36.358540",
  "module": null,
  "name": "validate",
  "script": "frappe.ui.form.on(\"Delivery Note\", {\n    validate(frm) {\n        // Disable duplicate item check\n        frm.doc.items.forEach(row => {\n            row.__islocal = true;\n        });\n    }\n});\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Delivery Note",
  "enabled": 1,
  "modified": "2025-06-20 11:56:21.160909",
  "module": null,
  "name": "Default Naming Series",
  "script": "frappe.ui.form.on('Delivery Note', {\n\tcompany:function(frm) {\n\t    frappe.call({\n            method: 'frappe.client.get_value',\n            args: {\n                doctype: 'Company Settings',\n                fieldname: 'vietnam_company_name'\n            },\n            callback: function(response) {\n                if (response.message) {\n                    var vietnam_company_name = response.message.vietnam_company_name;\n            \t\tif (frm.doc.company != vietnam_company_name){\n            \t\t    frm.set_value('naming_series', 'MAT-DN-.YYYY.-');\n            \t\t    \n            \t\t}\n            \t\tif (frm.doc.company == vietnam_company_name){\n            \t\t    frm.set_value('naming_series', '.{custom_abbr}.-DEL-.{custom_id_year}.-.{custom_id_month}.-.####');\n            \t\t    \n            \t\t}\n                }\n            }\n        });\n\t},\n\n})\n\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "BOM Creator",
  "enabled": 1,
  "modified": "2025-06-12 17:08:05.967797",
  "module": null,
  "name": "Fetch Image for child table",
  "script": "frappe.ui.form.on('BOM Creator', {\r\n    before_save: function(frm) {\r\n        if (frm._image_paths_set) return;\r\n\r\n        let promises = [];\r\n\r\n        (frm.doc.items || []).forEach(row => {\r\n            if (!row.custom_attach) {\r\n                let p = frappe.call({\r\n                    method: \"baller_headwear.baller_headwear.api.get_item_image\", \r\n                    args: { item_code: row.item_code },\r\n                    callback: function(r) {\r\n                        if (r.message) {\r\n                            frappe.model.set_value(row.doctype, row.name, 'custom_attach', r.message);\r\n                            console.log(`Set image path for ${row.item_code}: ${r.message}`);\r\n                        } else {\r\n                            console.log(`No image found for ${row.item_code}`);\r\n                        }\r\n                    }\r\n                });\r\n                promises.push(p);\r\n            }\r\n        });\r\n\r\n        if (promises.length) {\r\n            frappe.validated = false;  \r\n            Promise.all(promises.map(p => p.then?.() || Promise.resolve())).then(() => {\r\n                frm._image_paths_set = true;\r\n                frappe.show_alert({\r\n                    message: __('Image paths updated. Please click Save again.'),\r\n                    indicator: 'green'\r\n                });\r\n            });\r\n        }\r\n    }\r\n});\r\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Asset",
  "enabled": 1,
  "modified": "2025-04-08 13:25:04.998408",
  "module": "Baller Headwear",
  "name": "Default Naming Series (Asset)",
  "script": "frappe.ui.form.on('Asset', {\n\tcompany:function(frm) {\n\t    frappe.call({\n            method: 'frappe.client.get_value',\n            args: {\n                doctype: 'Company Settings',\n                fieldname: 'vietnam_company_name'\n            },\n            callback: function(response) {\n                if (response.message) {\n                    var vietnam_company_name = response.message.vietnam_company_name;\n            \t\tif (frm.doc.company != vietnam_company_name){\n            \t\t    frm.set_value('naming_series', 'ACC-ASS-.YYYY.-');\n            \t\t    \n            \t\t}\n            \t\tif (frm.doc.company == vietnam_company_name){\n            \t\t    frm.set_value('naming_series','.{custom_abbr}.-ASS-.{custom_id_year}.-.{custom_id_month}.-.####');\n            \t\t    \n            \t\t}\n                }\n            }\n        });\n\n\t},\n// \tbefore_save:function(frm) {\n// \t    frappe.call({\n//             method: 'frappe.client.get_value',\n//             args: {\n//                 doctype: 'Company Settings',\n//                 fieldname: 'vietnam_company_name'\n//             },\n//             callback: function(response) {\n//                 if (response.message) {\n//                     var vietnam_company_name = response.message.vietnam_company_name;\n//             \t\tif (frm.doc.company != vietnam_company_name){\n//             \t\t    frm.set_value('naming_series', 'PUR-ORD-.YYYY.-');\n            \t\t    \n//             \t\t}\n//             \t\tif (frm.doc.company == vietnam_company_name){\n//             \t\t    frm.set_value('naming_series','.{custom_abbr}.-PO-.{custom_id_year}.-.{custom_id_month}.-.####');\n            \t\t    \n//             \t\t}\n//                 }\n//             }\n//         });\n\n// \t}\n})\n\n\n\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Sales Order",
  "enabled": 1,
  "modified": "2025-03-04 12:09:05.594943",
  "module": "Baller Headwear",
  "name": "Default Naming Series (SO)",
  "script": "frappe.ui.form.on('Sales Order', {\n\tcompany:function(frm) {\n\t    frappe.call({\n            method: 'frappe.client.get_value',\n            args: {\n                doctype: 'Company Settings',\n                fieldname: 'vietnam_company_name'\n            },\n            callback: function(response) {\n                if (response.message) {\n                    var vietnam_company_name = response.message.vietnam_company_name;\n            \t\tif (frm.doc.company != vietnam_company_name){\n            \t\t    frm.set_value('naming_series', 'SAL-ORD-.YYYY.-');\n            \t\t    \n            \t\t}\n            \t\tif (frm.doc.company == vietnam_company_name){\n            \t\t    frm.set_value('naming_series','.{custom_abbr}.-SO-.{custom_id_year}.-.{custom_id_month}.-.####');\n            \t\t    \n            \t\t}\n                }\n            }\n        });\n\t},\n// \tbefore_save:function(frm) {\n// \t    frappe.call({\n//             method: 'frappe.client.get_value',\n//             args: {\n//                 doctype: 'Company Settings',\n//                 fieldname: 'vietnam_company_name'\n//             },\n//             callback: function(response) {\n//                 if (response.message) {\n//                     var vietnam_company_name = response.message.vietnam_company_name;\n//             \t\tif (frm.doc.company != vietnam_company_name){\n//             \t\t    frm.set_value('naming_series', 'SAL-ORD-.YYYY.-');\n            \t\t    \n//             \t\t}\n//             \t\tif (frm.doc.company == vietnam_company_name){\n//             \t\t    frm.set_value('naming_series','.{custom_abbr}.-SO-.{custom_id_year}.-.{custom_id_month}.-.####');\n            \t\t    \n//             \t\t}\n//                 }\n//             }\n//         });\n// \t}\n})\n\n\n\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Sales Invoice",
  "enabled": 1,
  "modified": "2025-03-04 12:09:21.052512",
  "module": "Baller Headwear",
  "name": "Default Naming Series (Sales Invoice)",
  "script": "frappe.ui.form.on('Sales Invoice', {\n\tcompany:function(frm) {\n\t    frappe.call({\n            method: 'frappe.client.get_value',\n            args: {\n                doctype: 'Company Settings',\n                fieldname: 'vietnam_company_name'\n            },\n            callback: function(response) {\n                if (response.message) {\n                    var vietnam_company_name = response.message.vietnam_company_name;\n            \t\tif (frm.doc.company != vietnam_company_name){\n            \t\t    frm.set_value('naming_series', 'ACC-SINV-.YYYY.-');\n            \t\t    \n            \t\t}\n            \t\tif (frm.doc.company == vietnam_company_name){\n            \t\t    frm.set_value('naming_series', '.{custom_abbr}.-SI-.{custom_id_year}.-.{custom_id_month}.-.####');\n            \t\t    \n            \t\t}\n                }\n            }\n        });\n\t},\n// \tbefore_save:function(frm) {\n// \t    frappe.call({\n//             method: 'frappe.client.get_value',\n//             args: {\n//                 doctype: 'Company Settings',\n//                 fieldname: 'vietnam_company_name'\n//             },\n//             callback: function(response) {\n//                 if (response.message) {\n//                     var vietnam_company_name = response.message.vietnam_company_name;\n//             \t\tif (frm.doc.company != vietnam_company_name){\n//             \t\t    frm.set_value('naming_series', 'ACC-SINV-.YYYY.-');\n            \t\t    \n//             \t\t}\n//             \t\tif (frm.doc.company == vietnam_company_name){\n//             \t\t    frm.set_value('naming_series', '.{custom_abbr}.-SI-.{custom_id_year}.-.{custom_id_month}.-.####');\n            \t\t    \n//             \t\t}\n//                 }\n//             }\n//         });\n// \t}\n})\n\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Purchase Order",
  "enabled": 1,
  "modified": "2025-03-04 12:08:48.618481",
  "module": "Baller Headwear",
  "name": "Default Naming Series (Purchase Order)",
  "script": "frappe.ui.form.on('Purchase Order', {\n\tcompany:function(frm) {\n\t    frappe.call({\n            method: 'frappe.client.get_value',\n            args: {\n                doctype: 'Company Settings',\n                fieldname: 'vietnam_company_name'\n            },\n            callback: function(response) {\n                if (response.message) {\n                    var vietnam_company_name = response.message.vietnam_company_name;\n            \t\tif (frm.doc.company != vietnam_company_name){\n            \t\t    frm.set_value('naming_series', 'PUR-ORD-.YYYY.-');\n            \t\t    \n            \t\t}\n            \t\tif (frm.doc.company == vietnam_company_name){\n            \t\t    frm.set_value('naming_series','.{custom_abbr}.-PO-.{custom_id_year}.-.{custom_id_month}.-.####');\n            \t\t    \n            \t\t}\n                }\n            }\n        });\n\n\t},\n// \tbefore_save:function(frm) {\n// \t    frappe.call({\n//             method: 'frappe.client.get_value',\n//             args: {\n//                 doctype: 'Company Settings',\n//                 fieldname: 'vietnam_company_name'\n//             },\n//             callback: function(response) {\n//                 if (response.message) {\n//                     var vietnam_company_name = response.message.vietnam_company_name;\n//             \t\tif (frm.doc.company != vietnam_company_name){\n//             \t\t    frm.set_value('naming_series', 'PUR-ORD-.YYYY.-');\n            \t\t    \n//             \t\t}\n//             \t\tif (frm.doc.company == vietnam_company_name){\n//             \t\t    frm.set_value('naming_series','.{custom_abbr}.-PO-.{custom_id_year}.-.{custom_id_month}.-.####');\n            \t\t    \n//             \t\t}\n//                 }\n//             }\n//         });\n\n// \t}\n})\n\n\n\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Purchase Invoice",
  "enabled": 1,
  "modified": "2025-03-04 12:08:01.016641",
  "module": "Baller Headwear",
  "name": "Default Naming Series (Purchase Invoice)",
  "script": "frappe.ui.form.on('Purchase Invoice', {\n\tcompany:function(frm) {\n\t    frappe.call({\n            method: 'frappe.client.get_value',\n            args: {\n                doctype: 'Company Settings',\n                fieldname: 'vietnam_company_name'\n            },\n            callback: function(response) {\n                if (response.message) {\n                    var vietnam_company_name = response.message.vietnam_company_name;\n            \t\tif (frm.doc.company != vietnam_company_name){\n            \t\t    frm.set_value('naming_series', 'ACC-PINV-.YYYY.-');\n            \t\t    \n            \t\t}\n            \t\tif (frm.doc.company == vietnam_company_name){\n            \t\t    frm.set_value('naming_series','.{custom_abbr}.-PI-.{custom_id_year}.-.{custom_id_month}.-.####');\n            \t\t    \n            \t\t}\n                }\n            }\n        });\n\t},\n// \tbefore_save:function(frm) {\n// \t    frappe.call({\n//             method: 'frappe.client.get_value',\n//             args: {\n//                 doctype: 'Company Settings',\n//                 fieldname: 'vietnam_company_name'\n//             },\n//             callback: function(response) {\n//                 if (response.message) {\n//                     var vietnam_company_name = response.message.vietnam_company_name;\n//             \t\tif (frm.doc.company != vietnam_company_name){\n//             \t\t    frm.set_value('naming_series', 'ACC-PINV-.YYYY.-');\n            \t\t    \n//             \t\t}\n//             \t\tif (frm.doc.company == vietnam_company_name){\n//             \t\t    frm.set_value('naming_series','.{custom_abbr}.-PI-.{custom_id_year}.-.{custom_id_month}.-.####');\n            \t\t    \n//             \t\t}\n//                 }\n//             }\n//         });\n// \t}\n})\n\n\n\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Quotation",
  "enabled": 1,
  "modified": "2025-03-04 12:07:45.824773",
  "module": "Baller Headwear",
  "name": "Default Naming Series (Quotation)",
  "script": "frappe.ui.form.on('Quotation', {\n\tcompany:function(frm) {\n\t    frappe.call({\n            method: 'frappe.client.get_value',\n            args: {\n                doctype: 'Company Settings',\n                fieldname: 'vietnam_company_name'\n            },\n            callback: function(response) {\n                if (response.message) {\n                    var vietnam_company_name = response.message.vietnam_company_name;\n            \t\tif (frm.doc.company != vietnam_company_name){\n            \t\t    frm.set_value('naming_series', 'SAL-QTN-.YYYY.-');\n            \t\t    \n            \t\t}\n            \t\tif (frm.doc.company == vietnam_company_name){\n            \t\t    frm.set_value('naming_series','.{custom_abbr}.-SQ-.{custom_id_year}.-.{custom_id_month}.-.####');\n            \t\t    \n            \t\t}\n                }\n            }\n        });\n\n\t},\n// \tbefore_save:function(frm) {\n// \t    frappe.call({\n//             method: 'frappe.client.get_value',\n//             args: {\n//                 doctype: 'Company Settings',\n//                 fieldname: 'vietnam_company_name'\n//             },\n//             callback: function(response) {\n//                 if (response.message) {\n//                     var vietnam_company_name = response.message.vietnam_company_name;\n//             \t\tif (frm.doc.company != vietnam_company_name){\n//             \t\t    frm.set_value('naming_series', 'SAL-QTN-.YYYY.-');\n            \t\t    \n//             \t\t}\n//             \t\tif (frm.doc.company == vietnam_company_name){\n//             \t\t    frm.set_value('naming_series','.{custom_abbr}.-SQ-.{custom_id_year}.-.{custom_id_month}.-.####');\n            \t\t    \n//             \t\t}\n//                 }\n//             }\n//         });\n\n// \t}\n})\n\n\n\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Payment Entry",
  "enabled": 1,
  "modified": "2026-01-09 10:13:01.015351",
  "module": "Baller Headwear",
  "name": "Default Naming Series (Payment Entry)",
  "script": "frappe.ui.form.on('Payment Entry', {\r\n    company: function(frm) {\r\n        frappe.call({\r\n            method: 'frappe.client.get_value',\r\n            args: {\r\n                doctype: 'Company Settings',\r\n                fieldname: 'vietnam_company_name'\r\n            },\r\n            callback: function(response) {\r\n                if (response.message) {\r\n                    var vietnam_company_name = response.message.vietnam_company_name;\r\n                    if (frm.doc.company != vietnam_company_name) {\r\n                        frm.set_value('naming_series', 'ACC-PAY-YYYY-.#####');\r\n                        const series = 'ACC-PAY-.YYYY.-';\r\n                        let options = frm.fields_dict.naming_series.df.options || '';\r\n                \r\n                        if (!options.split('\\n').includes(series)) {\r\n                            frm.set_df_property(\r\n                                'naming_series',\r\n                                'options',\r\n                                options + '\\n' + series\r\n                            );\r\n                        }\r\n                \r\n                        frm.set_value('naming_series', series);\r\n                    }\r\n                    if (frm.doc.company == vietnam_company_name) {\r\n                        frm.set_value('naming_series', '.{custom_abbr}.-PAY-.{custom_id_year}.-.{custom_id_month}.-.####');\r\n                    }\r\n                }\r\n            }\r\n        });\r\n    },\r\n    // onload_post_render: function(frm) {\r\n    //     if (frm.doc.docstatus != 1 && frm.doc.docstatus != 0) {\r\n    //         frappe.call({\r\n    //             method: 'frappe.client.get_value',\r\n    //             args: {\r\n    //                 doctype: 'Company Settings',\r\n    //                 fieldname: 'vietnam_company_name'\r\n    //             },\r\n    //             callback: function(response) {\r\n    //                 if (response.message) {\r\n    //                     var vietnam_company_name = response.message.vietnam_company_name;\r\n    //                     if (frm.doc.company != vietnam_company_name) {\r\n    //                         frm.set_value('naming_series', 'ACC-PAY-.YYYY.-');\r\n    //                     }\r\n    //                     if (frm.doc.company == vietnam_company_name) {\r\n    //                         frm.set_value('naming_series', '.{custom_abbr}.-PAY-.{custom_id_year}.-.{custom_id_month}.-.####');\r\n    //                     }\r\n    //                 }\r\n    //             }\r\n    //         });\r\n    //     }\r\n    // },\r\n\r\n});\r\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Journal Entry",
  "enabled": 1,
  "modified": "2025-03-18 19:22:04.488112",
  "module": "Baller Headwear",
  "name": "Default Naming Series (Journal Entry)",
  "script": "frappe.ui.form.on('Journal Entry', {\n\tcompany:function(frm) {\n\t    frappe.call({\n            method: 'frappe.client.get_value',\n            args: {\n                doctype: 'Company Settings',\n                fieldname: 'vietnam_company_name'\n            },\n            callback: function(response) {\n                if (response.message) {\n                    var vietnam_company_name = response.message.vietnam_company_name;\n            \t\tif (frm.doc.company != vietnam_company_name){\n            \t\t    frm.set_value('naming_series', 'ACC-JV-.YYYY.-');\n            \t\t    \n            \t\t}\n            \t\tif (frm.doc.company == vietnam_company_name){\n            \t\t    frm.set_value('naming_series','.{custom_abbr}.-JV-.{custom_id_year}.-.{custom_id_month}.-.####');\n            \t\t    \n            \t\t}\n                }\n            }\n        });\n\t},\n// \tbefore_save:function(frm) {\n// \t    frappe.call({\n//             method: 'frappe.client.get_value',\n//             args: {\n//                 doctype: 'Company Settings',\n//                 fieldname: 'vietnam_company_name'\n//             },\n//             callback: function(response) {\n//                 if (response.message) {\n//                     var vietnam_company_name = response.message.vietnam_company_name;\n//             \t\tif (frm.doc.company != vietnam_company_name){\n//             \t\t    frm.set_value('naming_series', 'ACC-JV-.YYYY.-');\n            \t\t    \n//             \t\t}\n//             \t\tif (frm.doc.company == vietnam_company_name){\n//             \t\t    frm.set_value('naming_series','.{custom_abbr}.-JV-.{custom_id_year}.-.{custom_id_month}.-.####');\n            \t\t    \n//             \t\t}\n//                 }\n//             }\n//         });\n// \t},\n})",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Work Order",
  "enabled": 1,
  "modified": "2025-03-04 12:06:56.118940",
  "module": "Baller Headwear",
  "name": "Default Naming Series (Work Order)",
  "script": "frappe.ui.form.on('Work Order', {\n\tcompany:function(frm) {\n\t    frappe.call({\n            method: 'frappe.client.get_value',\n            args: {\n                doctype: 'Company Settings',\n                fieldname: 'vietnam_company_name'\n            },\n            callback: function(response) {\n                if (response.message) {\n                    var vietnam_company_name = response.message.vietnam_company_name;\n            \t\tif (frm.doc.company != vietnam_company_name){\n            \t\t    frm.set_value('naming_series', 'MFG-WO-.YYYY.-');\n            \t\t    \n            \t\t}\n            \t\tif (frm.doc.company == vietnam_company_name){\n            \t\t    frm.set_value('naming_series','.{custom_abbr}.-WO-.{custom_id_year}.-.{custom_id_month}.-.####');\n            \t\t    \n            \t\t}\n                }\n            }\n        });\n\t},\n// \tbefore_save:function(frm) {\n// \t    frappe.call({\n//             method: 'frappe.client.get_value',\n//             args: {\n//                 doctype: 'Company Settings',\n//                 fieldname: 'vietnam_company_name'\n//             },\n//             callback: function(response) {\n//                 if (response.message) {\n//                     var vietnam_company_name = response.message.vietnam_company_name;\n//             \t\tif (frm.doc.company != vietnam_company_name){\n//             \t\t    frm.set_value('naming_series', 'MFG-WO-.YYYY.-');\n            \t\t    \n//             \t\t}\n//             \t\tif (frm.doc.company == vietnam_company_name){\n//             \t\t    frm.set_value('naming_series','.{custom_abbr}.-WO-.{custom_id_year}.-.{custom_id_month}.-.####');\n            \t\t    \n//             \t\t}\n//                 }\n//             }\n//         });\n// \t},\n})",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Purchase Receipt",
  "enabled": 1,
  "modified": "2025-03-04 12:06:33.631709",
  "module": "Baller Headwear",
  "name": "Default Naming Series (Purchase Receipt)",
  "script": "frappe.ui.form.on('Purchase Receipt', {\n\tcompany:function(frm) {\n\t    frappe.call({\n            method: 'frappe.client.get_value',\n            args: {\n                doctype: 'Company Settings',\n                fieldname: 'vietnam_company_name'\n            },\n            callback: function(response) {\n                if (response.message) {\n                    var vietnam_company_name = response.message.vietnam_company_name;\n            \t\tif (frm.doc.company != vietnam_company_name){\n            \t\t    frm.set_value('naming_series', 'MAT-PRE-.YYYY.-');\n            \t\t    \n            \t\t}\n            \t\tif (frm.doc.company == vietnam_company_name){\n            \t\t    frm.set_value('naming_series','.{custom_abbr}.-PR-.{custom_id_year}.-.{custom_id_month}.-.####');\n            \t\t    \n            \t\t}\n                }\n            }\n        });\n\t},\n// \tbefore_save:function(frm) {\n// \t    frappe.call({\n//             method: 'frappe.client.get_value',\n//             args: {\n//                 doctype: 'Company Settings',\n//                 fieldname: 'vietnam_company_name'\n//             },\n//             callback: function(response) {\n//                 if (response.message) {\n//                     var vietnam_company_name = response.message.vietnam_company_name;\n//             \t\tif (frm.doc.company != vietnam_company_name){\n//             \t\t    frm.set_value('naming_series', 'MAT-PRE-.YYYY.-');\n            \t\t    \n//             \t\t}\n//             \t\tif (frm.doc.company == vietnam_company_name){\n//             \t\t    frm.set_value('naming_series','.{custom_abbr}.-PR-.{custom_id_year}.-.{custom_id_month}.-.####');\n            \t\t    \n//             \t\t}\n//                 }\n//             }\n//         });\n// \t},\n})",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Material Request",
  "enabled": 1,
  "modified": "2025-03-04 12:06:08.992750",
  "module": "Baller Headwear",
  "name": "Default Naming Series (Material Request)",
  "script": "frappe.ui.form.on('Material Request', {\n\tcompany:function(frm) {\n\t    frappe.call({\n            method: 'frappe.client.get_value',\n            args: {\n                doctype: 'Company Settings',\n                fieldname: 'vietnam_company_name'\n            },\n            callback: function(response) {\n                if (response.message) {\n                    var vietnam_company_name = response.message.vietnam_company_name;\n            \t\tif (frm.doc.company != vietnam_company_name){\n            \t\t    frm.set_value('naming_series', 'MAT-MR-.YYYY.-');\n            \t\t    \n            \t\t}\n            \t\tif (frm.doc.company == vietnam_company_name){\n            \t\t    frm.set_value('naming_series','.{custom_abbr}.-MR-.{custom_id_year}.-.{custom_id_month}.-.####');\n            \t\t    \n            \t\t}\n                }\n            }\n        });\n\n\t},\n// \tbefore_save:function(frm) {\n// \t    frappe.call({\n//             method: 'frappe.client.get_value',\n//             args: {\n//                 doctype: 'Company Settings',\n//                 fieldname: 'vietnam_company_name'\n//             },\n//             callback: function(response) {\n//                 if (response.message) {\n//                     var vietnam_company_name = response.message.vietnam_company_name;\n//             \t\tif (frm.doc.company != vietnam_company_name){\n//             \t\t    frm.set_value('naming_series', 'MAT-MR-.YYYY.-');\n            \t\t    \n//             \t\t}\n//             \t\tif (frm.doc.company == vietnam_company_name){\n//             \t\t    frm.set_value('naming_series','.{custom_abbr}.-MR-.{custom_id_year}.-.{custom_id_month}.-.####');\n            \t\t    \n//             \t\t}\n//                 }\n//             }\n//         });\n\n// \t}\n})",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Production Plan",
  "enabled": 1,
  "modified": "2025-03-04 12:05:43.777405",
  "module": "Baller Headwear",
  "name": "Default Naming Series (Production Plan)",
  "script": "frappe.ui.form.on('Production Plan', {\n\tcompany:function(frm) {\n\t    frappe.call({\n            method: 'frappe.client.get_value',\n            args: {\n                doctype: 'Company Settings',\n                fieldname: 'vietnam_company_name'\n            },\n            callback: function(response) {\n                if (response.message) {\n                    var vietnam_company_name = response.message.vietnam_company_name;\n            \t\tif (frm.doc.company != vietnam_company_name){\n            \t\t    frm.set_value('naming_series', 'MFG-PP-.YYYY.-');\n            \t\t    \n            \t\t}\n            \t\tif (frm.doc.company == vietnam_company_name){\n            \t\t    frm.set_value('naming_series','.{custom_abbr}.-PP-.{custom_id_year}.-.{custom_id_month}.-.####');\n            \t\t    \n            \t\t}\n                }\n            }\n        });\n\t},\n\n})",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Work Order",
  "enabled": 1,
  "modified": "2024-12-24 12:19:13.525269",
  "module": "Baller Headwear",
  "name": "Work Order Customization (Create Material Request)",
  "script": "frappe.ui.form.on('Work Order', {\r\n    refresh: function (frm) {\r\n        if (frm.doc.docstatus === 1) {\r\n            frm.add_custom_button(__('Create Material Request'), function () {\r\n                frappe.db.get_doc('Work Order Customization Settings')\r\n                    .then(settings => {\r\n                        frappe.new_doc('Material Request', {\r\n                            work_order: frm.doc.name,\r\n                            company: frm.doc.company,\r\n                            material_request_type: 'Material Transfer',\r\n                            set_from_warehouse: settings.source_warehouse,\r\n                            set_warehouse: settings.target_warehouse\r\n                        });\r\n                    })\r\n                    .catch(err => {\r\n                        frappe.msgprint(__('Failed to fetch Work Order Customization Settings'));\r\n                        console.error(err);\r\n                    });\r\n            }, __('Actions'));\r\n        }\r\n    }\r\n});\r\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Material Request",
  "enabled": 1,
  "modified": "2024-12-24 12:19:23.062789",
  "module": "Baller Headwear",
  "name": "Material Request Customization",
  "script": "frappe.ui.form.on('Material Request', {\r\n    refresh: function(frm) {\r\n        if (frm.doc.docstatus === 1) {\r\n            frm.add_custom_button(__('Material Transfer for Manufacture'), function() {\r\n                frappe.model.open_mapped_doc({\r\n                    method: \"baller_headwear.baller_headwear.api.make_stock_entry\",\r\n                    frm: frm,\r\n                    args: {\r\n                        stock_entry_type: \"Material Transfer for Manufacture\"\r\n                    }\r\n                });\r\n            }, __(\"Create\"));\r\n        }\r\n    }\r\n});\r\n\r\n// frappe.ui.form.on('Material Request', {\r\n//     refresh: function(frm) {\r\n//         frm.add_custom_button(__('Material Transfer for Manufacture'), function() {\r\n//             frappe.model.open_mapped_doc({\r\n//                 method: \"baller_headwear.baller_headwear.api.make_stock_entry\",\r\n//                 frm: frm,\r\n//                 args: {\r\n//                     stock_entry_type: \"Material Transfer for Manufacture\"\r\n//                 }\r\n//             });\r\n//         }, __(\"Create\"));\r\n//     }\r\n// });\r\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Sales Invoice",
  "enabled": 0,
  "modified": "2025-05-02 13:48:28.027214",
  "module": "Baller Headwear",
  "name": "Exchange Rate Customization",
  "script": "frappe.ui.form.on('Sales Invoice', {     \r\n    custom_transaction_date_exchange_rate: function(frm) {         \r\n        console_log_sales_order_totals(frm);     \r\n    } \r\n});\r\n\r\nasync function console_log_sales_order_totals(frm) {     \r\n    if (!frm.doc.items || frm.doc.items.every(item => !item.item_code)) {\r\n        frappe.throw(__('Please add at least one item to the Sales Invoice before proceeding.'));\r\n    }\r\n\r\n    let sales_order_totals = {};     \r\n    let sales_order_ids = [];      \r\n\r\n    frm.doc.items.forEach(function(item) {         \r\n        if (item.sales_order) {             \r\n            if (sales_order_totals[item.sales_order]) {                 \r\n                sales_order_totals[item.sales_order] += item.amount;             \r\n            } else {                 \r\n                sales_order_totals[item.sales_order] = item.amount;                 \r\n                sales_order_ids.push(item.sales_order);             \r\n            }         \r\n        }     \r\n    });      \r\n\r\n    let sales_order_list = [];     \r\n    for (let sales_order_id in sales_order_totals) {         \r\n        sales_order_list.push({             \r\n            sales_order_id: sales_order_id,             \r\n            outstanding_amount: sales_order_totals[sales_order_id],             \r\n            exchange_rate: 1,              \r\n            allocated_amount: 0,             \r\n            payment_entry_id: null         \r\n        });     \r\n    }      \r\n\r\n    console.log('Sales Orders and Outstanding Amounts:', sales_order_list);     \r\n    console.log('Unique Sales Order IDs:', sales_order_ids);      \r\n\r\n    let updated_sales_order_list = await reduce_advance_amounts(frm, sales_order_list);     \r\n    console.log('Updated Sales Orders after reducing advance amounts:', updated_sales_order_list);      \r\n\r\n    let final_calculation = calculate_final_value(frm, updated_sales_order_list);     \r\n    console.log('Final Calculation:', final_calculation);      \r\n\r\n    frm.set_value('conversion_rate', final_calculation);     \r\n    frm.save();     \r\n    frappe.msgprint(__('Conversion Rate updated to: ' + final_calculation)); \r\n}  \r\n\r\nfunction reduce_advance_amounts(frm, sales_order_list) {     \r\n    let promises = [];     \r\n    let sales_order_ids_with_payment = [];     \r\n\r\n    frm.doc.advances.forEach(function(advance) {         \r\n        if (advance.reference_name) {             \r\n            let promise = new Promise((resolve, reject) => {                 \r\n                frappe.call({                     \r\n                    method: 'frappe.client.get',                     \r\n                    args: {                         \r\n                        doctype: 'Payment Entry',                         \r\n                        name: advance.reference_name                     \r\n                    },                     \r\n                    callback: function(response) {                         \r\n                        if (response.message) {                             \r\n                            let payment_entry_doc = response.message;                             \r\n                            let source_exchange_rate = payment_entry_doc.source_exchange_rate || 1;                             \r\n                            let payment_entry_id = payment_entry_doc.name;                             \r\n\r\n                            payment_entry_doc.references.forEach(function(reference) {                                 \r\n                                let reference_sales_order_id = reference.reference_name;                                 \r\n\r\n                                sales_order_ids_with_payment.push(reference_sales_order_id);\r\n\r\n                                sales_order_list.forEach(function(order) {                                     \r\n                                    if (order.sales_order_id === reference_sales_order_id) {                                         \r\n                                        let reduced_amount = order.outstanding_amount - advance.allocated_amount;                                         \r\n                                        order.outstanding_amount = reduced_amount < 0 ? 0 : reduced_amount;                                         \r\n                                        order.exchange_rate = source_exchange_rate;                                         \r\n                                        order.allocated_amount += advance.allocated_amount;                                         \r\n                                        order.payment_entry_id = payment_entry_id;                                     \r\n                                    }                                 \r\n                                });                             \r\n                            });                             \r\n                            resolve();                           \r\n                        } else {                             \r\n                            console.error('Failed to fetch Payment Entry:', advance.reference_name);                             \r\n                            reject();                         \r\n                        }                     \r\n                    }                 \r\n                });             \r\n            });             \r\n            promises.push(promise);         \r\n        }     \r\n    });      \r\n\r\n    return Promise.all(promises).then(() => {         \r\n        // sales_order_list.forEach(function(order) {             \r\n        //     if (!sales_order_ids_with_payment.includes(order.sales_order_id)) {                 \r\n        //         frappe.throw(__('No Payment Entry found for Sales Order: ' + order.sales_order_id));             \r\n        //     }         \r\n        // });         \r\n\r\n        return sales_order_list;     \r\n    }); \r\n}  \r\n\r\nfunction calculate_final_value(frm, sales_order_list) {     \r\n    let custom_transaction_exchange_rate = frm.doc.custom_transaction_date_exchange_rate || 1;     \r\n    console.log('Custom Exchange Rate:', custom_transaction_exchange_rate);      \r\n\r\n    let total_amount = frm.doc.total || 1;      \r\n\r\n    console.log('Total Amount:', total_amount);      \r\n\r\n    let total_outstanding_amount = 0;     \r\n    let total_allocated_amount = 0;      \r\n\r\n    sales_order_list.forEach(function(order) {         \r\n        total_outstanding_amount += order.outstanding_amount;         \r\n        total_allocated_amount += (order.allocated_amount * order.exchange_rate);     \r\n    });      \r\n\r\n    console.log('Total Outstanding Amount:', total_outstanding_amount);     \r\n    console.log('Total Allocated Amount:', total_allocated_amount);      \r\n\r\n    let outstanding_amount_value = total_outstanding_amount * custom_transaction_exchange_rate;     \r\n    let allocated_amount_value = total_allocated_amount;      \r\n\r\n    console.log('Outstanding Amount Value:', outstanding_amount_value);     \r\n    console.log('Allocated Amount Value:', allocated_amount_value);      \r\n\r\n    let final_value = (outstanding_amount_value + allocated_amount_value) / total_amount;\r\n    final_value = Math.round(final_value * 100) / 100;\r\n    \r\n    console.log('Final Value:', final_value);\r\n    return final_value;\r\n} \r\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Stock Entry",
  "enabled": 1,
  "modified": "2025-03-04 12:05:21.721048",
  "module": "Baller Headwear",
  "name": "Default Naming Series (Stock Entry)",
  "script": "frappe.ui.form.on('Stock Entry', {\n\tcompany:function(frm) {\n\t    frappe.call({\n            method: 'frappe.client.get_value',\n            args: {\n                doctype: 'Company Settings',\n                fieldname: 'vietnam_company_name'\n            },\n            callback: function(response) {\n                if (response.message) {\n                    var vietnam_company_name = response.message.vietnam_company_name;\n            \t\tif (frm.doc.company != vietnam_company_name){\n            \t\t    frm.set_value('naming_series', 'MAT-STE-.YYYY.-');\n            \t\t    \n            \t\t}\n            \t\tif (frm.doc.company == vietnam_company_name){\n            \t\t    frm.set_value('naming_series','.{custom_abbr}.-SE-.{custom_id_year}.-.{custom_id_month}.-.####');\n            \t\t    \n            \t\t}\n                }\n            }\n        });\n\n\t},\n\n})",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Packing Slip",
  "enabled": 1,
  "modified": "2025-03-11 17:22:14.542255",
  "module": "Baller Headwear",
  "name": "Packing list Customization",
  "script": "frappe.ui.form.on('Packing Slip', {\n    before_save: function(frm) {\n        total_gw_calc(frm);\n    },\n    delivery_note: function(frm) {\n        if (frm.doc.delivery_note) {\n            frappe.call({\n                method: 'frappe.client.get',\n                args: {\n                    doctype: 'Delivery Note',\n                    name: frm.doc.delivery_note\n                },\n                callback: function(response) {\n                    if (response.message) {\n                        var delivery_note_doc = response.message;\n                        \n                        if (delivery_note_doc.items && delivery_note_doc.items.length > 0) {\n                            var first_item = delivery_note_doc.items[0];\n\n                            if (first_item.against_sales_invoice) {\n                                frm.set_value('custom_sales_invoice_id', first_item.against_sales_invoice);\n                            } else {\n                                frappe.msgprint(__('No Sales Invoice found for this Delivery Note'));\n                            }\n                        } else {\n                            frappe.msgprint(__('No items found in this Delivery Note'));\n                        }\n                    }\n                }\n            });\n        } else {\n            frm.set_value('custom_sales_invoice_id', '');\n        }\n    }\n})\n\nfrappe.ui.form.on('Packing Slip Item', {\n    custom_quantity_of_cartons: function(frm, cdt, cdn) {\n        calculateTotal(frm, cdt, cdn);\n        calculatetotal_gw(frm, cdt, cdn);\n    },\n    custom_nwkgctn: function(frm, cdt, cdn) {\n        calculateTotal(frm, cdt, cdn);\n    },\n    custom_total_net_weight: function(frm, cdt, cdn) {\n        calculate_per_item_net_weight(frm, cdt, cdn);\n    },\n    custom_gwkgctn: function(frm, cdt, cdn) {\n        calculatetotal_gw(frm, cdt, cdn);\n    },\n\n});\n\nfunction calculateTotal(frm, cdt, cdn) {\n    var child_doc = locals[cdt][cdn];\n    var total_net_weight = 0;\n    if (child_doc.custom_quantity_of_cartons) {\n        total_net_weight = child_doc.custom_quantity_of_cartons * child_doc.custom_nwkgctn ;\n    }\n    if (child_doc.custom_nwkgctn) {\n        total_net_weight = child_doc.custom_nwkgctn * child_doc.custom_quantity_of_cartons ;\n    }\n    frappe.model.set_value(cdt, cdn, 'custom_total_net_weight', total_net_weight);\n}\n\nfunction calculatetotal_gw(frm, cdt, cdn) {\n    var child_doc = locals[cdt][cdn];\n    var total_net_weight = 0;\n    if (child_doc.custom_quantity_of_cartons) {\n        total_net_weight = child_doc.custom_quantity_of_cartons * child_doc.custom_gwkgctn ;\n    }\n    if (child_doc.custom_gwkgctn) {\n        total_net_weight = child_doc.custom_gwkgctn * child_doc.custom_quantity_of_cartons ;\n    }\n    frappe.model.set_value(cdt, cdn, 'custom_total_gross_weight', total_net_weight);\n}\n\nfunction calculate_per_item_net_weight(frm, cdt, cdn, total_net_weight) {\n    var child_doc = locals[cdt][cdn];\n    var per_item_net_weight = 0;\n    \n    if (child_doc.custom_total_net_weight > 0 && child_doc.qty > 0) {\n        per_item_net_weight = child_doc.custom_total_net_weight / child_doc.qty;\n    } else {\n        per_item_net_weight = 0;\n    }\n\n    frappe.model.set_value(cdt, cdn, 'net_weight', per_item_net_weight);\n}\n\nfunction total_gw_calc(frm) {\n    var total_gross_weight = 0;\n    \n    frm.doc.items.forEach(row => {\n        total_gross_weight += row.custom_total_gross_weight;\n    }); \n \n\n    frm.set_value('gross_weight_pkg', total_gross_weight);\n}\n\n\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Company",
  "enabled": 1,
  "modified": "2025-04-17 12:07:49.560225",
  "module": "Baller Headwear",
  "name": "Filter for Exchange / Gain Loss fields",
  "script": "frappe.ui.form.on('Company', {\n    refresh(frm) {\n        frm.set_query(\"custom_exchange_gain_account\", () => {\n            return {\n                filters: {\n                    company: frm.doc.name  \n                }\n            };\n        });\n    }\n});\n\nfrappe.ui.form.on('Company', {\n    refresh(frm) {\n        frm.set_query(\"custom_exchange_loss_account\", () => {\n            return {\n                filters: {\n                    company: frm.doc.name  \n                }\n            };\n        });\n    }\n});\n\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Sales Invoice",
  "enabled": 0,
  "modified": "2025-05-06 15:17:33.542935",
  "module": "Baller Headwear",
  "name": "Test",
  "script": "frappe.ui.form.on('Sales Invoice', {\r\n    onload: function(frm) {\r\n        let from_currency = frm.doc.currency;\r\n\r\n        if (!from_currency) {\r\n            console.warn('No from_currency (currency) specified.');\r\n            return;\r\n        }\r\n\r\n        frappe.db.get_value('Company', frm.doc.company, 'default_currency', function(r) {\r\n            let to_currency = r.default_currency;\r\n\r\n            if (!to_currency) {\r\n                console.error('Could not fetch company default currency.');\r\n                return;\r\n            }\r\n\r\n            if (from_currency === to_currency) {\r\n                console.log('No exchange rate needed. Both currencies are the same.');\r\n                return;\r\n            }\r\n\r\n            frappe.call({\r\n                method: 'erpnext.setup.utils.get_exchange_rate',\r\n                args: {\r\n                    from_currency: from_currency,\r\n                    to_currency: to_currency\r\n                },\r\n                callback: function(response) {\r\n                    if (response.message) {\r\n                        console.log(`Exchange Rate from ${from_currency} to ${to_currency}:`, response.message);\r\n                    } else {\r\n                        console.warn('No exchange rate returned.');\r\n                    }\r\n                }\r\n            });\r\n        });\r\n    }\r\n});\r\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "BOM Creator",
  "enabled": 1,
  "modified": "2025-07-10 09:01:17.749730",
  "module": null,
  "name": "Calc Planned Fabric Needed",
  "script": "frappe.ui.form.on('BOM Creator Item', {\n    qty: function(frm, cdt, cdn) {\n        update_planned_fabric_needed(frm, cdt, cdn);\n    }\n});\nfrappe.ui.form.on('BOM Creator', {\n    custom_planned_qty: function(frm) {\n        frm.doc.items.forEach(function(child) {\n            var cdt = child.doctype;\n            var cdn = child.name;\n            update_planned_fabric_needed(frm, cdt, cdn);\n        });\n        frm.refresh_field('items');\n    }\n});\n\nfunction update_planned_fabric_needed(frm, cdt, cdn) {\n    var child_doc = locals[cdt][cdn];\n    if (frm.doc.custom_planned_qty && child_doc.qty) {\n        var custom_planned_fabric_needed = frm.doc.custom_planned_qty * child_doc.qty;\n        frappe.model.set_value(cdt, cdn, 'custom_planned_fabric_needed', custom_planned_fabric_needed);\n    }\n}\n\n// frappe.ui.form.on('BOM Creator Item', {\n//     qty: function(frm, cdt, cdn) {\n//         var child_doc = locals[cdt][cdn];\n        \n//         var custom_planned_fabric_needed = frm.doc.custom_planned_qty * child_doc.qty;\n        \n//         frappe.model.set_value(cdt, cdn, 'custom_planned_fabric_needed', custom_planned_fabric_needed);\n//     }\n// })\n\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Cutting Operation",
  "enabled": 1,
  "modified": "2025-06-27 14:54:55.820603",
  "module": "Baller Headwear",
  "name": "Fetch Work Order Data",
  "script": "frappe.ui.form.on('Cutting Operation', {\r\n    fetch_work_order: function(frm) {\r\n        if (!frm.doc.item && (!frm.doc.from_date || !frm.doc.to_date)) {\r\n            frappe.msgprint(__('Please select either Item or From/To Date.'));\r\n            return;\r\n        }\r\n\r\n        frappe.call({\r\n            method: \"baller_headwear.baller_headwear.api.get_work_orders_for_cutting\",\r\n            args: {\r\n                from_date: frm.doc.from_date,\r\n                to_date: frm.doc.to_date,\r\n                item: frm.doc.item\r\n            },\r\n            callback: function(r) {\r\n                if (r.message && r.message.length) {\r\n                    frm.clear_table(\"cutting_material\");\r\n\r\n                    r.message.forEach(item => {\r\n                        let row = frm.add_child(\"cutting_material\");\r\n                        row.work_order = item.work_order;\r\n                        row.item_fabric = item.item_fabric;\r\n                        row.qty = item.qty;\r\n                    });\r\n\r\n                    frm.refresh_field(\"cutting_material\");\r\n                    frappe.msgprint(`${r.message.length} Fabric item(s) added from Work Orders.`);\r\n                } else {\r\n                    frappe.msgprint(\"No matching Fabric items found in Work Orders.\");\r\n                }\r\n            }\r\n        });\r\n    }\r\n});\r\n\r\n\r\n\r\n\r\n// frappe.ui.form.on('Cutting Operation', {\r\n//     fetch_work_order: function(frm) {\r\n//         if (!frm.doc.from_date || !frm.doc.to_date) {\r\n//             frappe.msgprint(__('Please enter From Date and To Date.'));\r\n//             return;\r\n//         }\r\n\r\n//         frappe.call({\r\n//             method: \"baller_headwear.baller_headwear.api.get_work_orders_for_cutting\",\r\n//             args: {\r\n//                 from_date: frm.doc.from_date,\r\n//                 to_date: frm.doc.to_date\r\n//             },\r\n//             callback: function(r) {\r\n//                 if (r.message && r.message.length) {\r\n//                     frm.clear_table(\"cutting_material\");\r\n\r\n//                     r.message.forEach(wo => {\r\n//                         let row = frm.add_child(\"cutting_material\");\r\n//                         row.work_order = wo.name;\r\n//                     });\r\n\r\n//                     frm.refresh_field(\"cutting_material\");\r\n//                     frappe.msgprint(`${r.message.length} Work Order(s) added.`);\r\n//                 } else {\r\n//                     frappe.msgprint(\"No matching Work Orders found.\");\r\n//                 }\r\n//             }\r\n//         });\r\n//     }\r\n// });\r\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Cutting Operation",
  "enabled": 1,
  "modified": "2025-06-27 14:09:49.164883",
  "module": "Baller Headwear",
  "name": "Calculation of Layer and Actual Qty",
  "script": "frappe.ui.form.on('Cutting Operation Items', {\r\n  no_of_piece(frm, cdt, cdn) {\r\n    const row = locals[cdt][cdn];\r\n\r\n    if (row.no_of_piece && row.planned_qty) {\r\n      row.layer = Math.round(row.planned_qty / row.no_of_piece);\r\n    }\r\n\r\n    if (row.layer && row.cutting_mould) {\r\n      row.actual_qty = row.layer * row.cutting_mould;\r\n    }\r\n\r\n    frm.refresh_field('cutting_material');\r\n  },\r\n\r\n//   cutting_mould(frm, cdt, cdn) {\r\n//     const row = locals[cdt][cdn];\r\n\r\n//     if (row.layer && row.cutting_mould) {\r\n//       row.actual_qty = row.layer * row.cutting_mould;\r\n//       frm.refresh_field('cutting_material');\r\n//     }\r\n//   }\r\n});\r\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Pattern Cutting Specification",
  "enabled": 1,
  "modified": "2025-06-27 17:02:23.927947",
  "module": "Baller Headwear",
  "name": "Pattern Cutting Specification (ID)",
  "script": "frappe.ui.form.on('Pattern Cutting Specification', {\n\tcutting_mould:function (frm) {\n\t\tfrm.set_value('cutting_mould_copy',`'${frm.doc.cutting_mould}'`);\n\t}\n})",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Purchase Order",
  "enabled": 0,
  "modified": "2025-07-09 14:14:42.928488",
  "module": null,
  "name": "PIC-PO",
  "script": "frappe.ui.form.on('Purchase Order', {\n    onload: function(frm) {\n        if (frm.is_new() && !frm.doc.custom_pic) {\n            frm.set_value('custom_pic', frappe.session.user);\n        }\n    },\n\n    custom_pic: function(frm) {\n        if (frm.doc.custom_pic) {\n            frappe.db.get_doc('User', frm.doc.custom_pic).then(user => {\n                const full_name = user.full_name || `${user.first_name} ${user.last_name || ''}`;\n                const email = user.email || '';\n                const phone = user.phone || '';\n                const mobile = user.mobile_no || '';\n\n                const desc = `👤 ${full_name}<br>📧 ${email}<br>📞 Phone: ${phone || '-'} | Mobile: ${mobile || '-'}`;\n                \n                frm.fields_dict.custom_pic.set_description(desc);\n            });\n        } else {\n            frm.fields_dict.custom_pic.set_description('');\n        }\n    }\n});\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Pick List",
  "enabled": 0,
  "modified": "2025-07-09 14:14:43.028560",
  "module": null,
  "name": "pick list production plan",
  "script": "frappe.ui.form.on('Pick List', {\n    refresh(frm) {\n        frm.add_custom_button('Chọn WO từ PP', function () {\n            let pp = frm.doc.custom_production_plan;\n\n            if (!pp) {\n                frappe.msgprint('Vui lòng chọn Production Plan trước.');\n                return;\n            }\n\n            frappe.call({\n                method: 'frappe.handler.run_server_script',\n                args: {\n                    script: 'get_work_orders_by_production_plan',\n                    production_plan: pp\n                },\n                callback(r) {\n                    if (!r.message || r.message.length === 0) {\n                        frappe.msgprint('Không tìm thấy Work Order nào.');\n                        return;\n                    }\n\n                    new frappe.ui.form.MultiSelectDialog({\n                        doctype: 'Work Order',\n                        target: frm,\n                        date_field: 'planned_start_date',\n                        setters: {},\n                        get_query() {\n                            return {\n                                filters: {\n                                    name: ['in', r.message.map(w => w.name)]\n                                }\n                            };\n                        },\n                        action(selections) {\n                            frappe.msgprint(`Bạn đã chọn ${selections.length} WO: ${selections.join(', ')}`);\n                            // Gọi server script khác để lấy NVL sau này nếu muốn\n                        }\n                    });\n                }\n            });\n        });\n    }\n});\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "BOM Creator",
  "enabled": 1,
  "modified": "2026-01-07 16:11:38.565962",
  "module": "Baller Headwear",
  "name": "Auto Parent Row No",
  "script": "frappe.ui.form.on(\"BOM Creator Item\", {\n  fg_item: function(frm, cdt, cdn) {\n    let current_row = locals[cdt][cdn];\n\n    console.log(\"FG Item selected:\", current_row.fg_item);\n\n    let parent_row = frm.doc.items.find(\n      row => row.item_code === current_row.fg_item\n    );\n\n    if (parent_row) {\n      console.log(\"Match found at row:\", parent_row.idx);\n      frappe.model.set_value(cdt, cdn, \"parent_row_no\", parent_row.idx);\n    } else {\n      console.log(\"No match found.\");\n      frappe.model.set_value(cdt, cdn, \"parent_row_no\", \"\");\n    }\n  }\n});\n\n\n\n// frappe.ui.form.on(\"BOM Creator\", {\n//   onload: function(frm) {\n//     frm.fields_dict.items.grid.on_sort = () => {\n//       console.log(\"Rows have been reordered.\");\n\n//       frm.doc.items.forEach(child => {\n//         let parent_row = frm.doc.items.find(\n//           row => row.item_code === child.fg_item\n//         );\n//         if (parent_row) {\n//           frappe.model.set_value(child.doctype, child.name, \"parent_row_no\", parent_row.idx);\n//         } else {\n//           frappe.model.set_value(child.doctype, child.name, \"parent_row_no\", \"\");\n//         }\n//       });\n//     };\n//   }\n// });\n\n\n\nfrappe.ui.form.on(\"BOM Creator\", {\n  validate: function(frm) {\n    frm.doc.items.forEach(row => {\n      const parent_row = frm.doc.items.find(r => r.item_code === row.fg_item);\n      if (parent_row) {\n        frappe.model.set_value(row.doctype, row.name, \"parent_row_no\", parent_row.idx);\n      } else {\n        frappe.model.set_value(row.doctype, row.name, \"parent_row_no\", \"\");\n      }\n    });\n  }\n});\n\n\n\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Material Request",
  "enabled": 0,
  "modified": "2025-07-09 14:14:42.989487",
  "module": null,
  "name": "Material request item",
  "script": "frappe.ui.form.on('Material Request', {\n    validate: async function(frm) {\n        for (let item of frm.doc.items) {\n            if (!item.schedule_date || !item.item_code) continue;\n\n            let res = await frappe.call({\n                method: 'frappe.client.get_value',\n                args: {\n                    doctype: 'Item',\n                    filters: { name: item.item_code },\n                    fieldname: 'lead_time_days'\n                }\n            });\n\n            const lead_days = res.message.lead_time_days || 0;\n            const today = frappe.datetime.get_today();\n            const min_required_date = frappe.datetime.add_days(today, lead_days);\n\n            if (frappe.datetime.str_to_obj(item.schedule_date) < frappe.datetime.str_to_obj(min_required_date)) {\n                frappe.throw(`\n                    Dòng item <b>${item.item_code}</b>: Required Date (${item.schedule_date}) không hợp lệ.<br>\n                    Phải sau tối thiểu <b>${lead_days}</b> ngày kể từ hôm nay (${today}).\n                `);\n            }\n        }\n    }\n});\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "BOM Creator",
  "enabled": 0,
  "modified": "2025-07-10 11:23:32.031582",
  "module": "Baller Headwear",
  "name": "Auto Source Warehouse",
  "script": "frappe.ui.form.on(\"BOM Creator\", {\n  onload: function(frm) {\n    frm.fields_dict.items.grid.on_sort = () => {\n      console.log(\"Items reordered. Rechecking source warehouse...\");\n      update_source_warehouses(frm);\n    };\n  },\n\n  refresh: function(frm) {\n    update_source_warehouses(frm);\n  },\n\n  validate: function(frm) {\n    update_source_warehouses(frm);\n  }\n});\n\nfrappe.ui.form.on(\"BOM Creator Item\", {\n  item_code: function(frm, cdt, cdn) {\n    let row = locals[cdt][cdn];\n    update_source_warehouse(row);\n    frm.refresh_field(\"items\");\n  }\n});\n\nfunction update_source_warehouses(frm) {\n  frm.doc.items.forEach(row => {\n    update_source_warehouse(row);\n  });\n  frm.refresh_field(\"items\");\n}\n\nfunction update_source_warehouse(row) {\n  if (!row.item_code) return;\n\n  if (row.item_code.startsWith(\"SW-\") || row.item_code.startsWith(\"Piping\")) {\n    row.source_warehouse = \"Semi-finished Goods  - BHV\";\n  } else {\n    row.source_warehouse = \"Main Store - BHV\";\n  }\n}\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Purchase Order",
  "enabled": 1,
  "modified": "2026-01-15 11:54:45.554489",
  "module": null,
  "name": "Show Percent In Purchase Order",
  "script": "frappe.listview_settings[\"Purchase Order\"] = {\r\n\tadd_fields: [\r\n\t\t\"base_grand_total\",\r\n\t\t\"company\",\r\n\t\t\"currency\",\r\n\t\t\"supplier\",\r\n\t\t\"supplier_name\",\r\n\t\t\"per_received\",\r\n\t\t\"per_billed\",\r\n\t\t\"status\",\r\n\t\t'custom_total_billed'\r\n\t],\r\n\tget_indicator: function (doc) {\r\n\t\t// Please do not add precision in the flt function\r\n\t\tif (doc.status === \"Closed\") {\r\n\t\t\treturn [__(\"Closed\"), \"green\", \"status,=,Closed\"];\r\n\t\t} else if (doc.status === \"On Hold\") {\r\n\t\t\treturn [__(\"On Hold\"), \"orange\", \"status,=,On Hold\"];\r\n\t\t} else if (doc.status === \"Delivered\") {\r\n\t\t\treturn [__(\"Delivered\"), \"green\", \"status,=,Closed\"];\r\n\t\t} else if (flt(doc.per_received) < 100 && doc.status !== \"Closed\") {\r\n\t\t\tif (flt(doc.per_billed) < 100) {\r\n\t\t\t\treturn [\r\n\t\t\t\t\t__(\"To Receive and Bill\"),\r\n\t\t\t\t\t\"orange\",\r\n\t\t\t\t\t\"per_received,<,100|per_billed,<,100|status,!=,Closed|docstatus,=,1\",\r\n\t\t\t\t];\r\n\t\t\t} else {\r\n\t\t\t\treturn [\r\n\t\t\t\t\t__(\"To Receive\"),\r\n\t\t\t\t\t\"orange\",\r\n\t\t\t\t\t\"per_received,<,100|per_billed,=,100|status,!=,Closed|docstatus,=,1\",\r\n\t\t\t\t];\r\n\t\t\t}\r\n\t\t} else if (flt(doc.per_received) >= 100 && flt(doc.per_billed) < 100 && doc.status !== \"Closed\") {\r\n\t\t\treturn [\r\n\t\t\t\t__(\"To Bill\"),\r\n\t\t\t\t\"orange\",\r\n\t\t\t\t\"per_received,=,100|per_billed,<,100|status,!=,Closed|docstatus,=,1\",\r\n\t\t\t];\r\n\t\t} else if (flt(doc.per_received) >= 100 && flt(doc.per_billed) == 100 && doc.status !== \"Closed\") {\r\n\t\t\treturn [\r\n\t\t\t\t__(\"Completed\"),\r\n\t\t\t\t\"green\",\r\n\t\t\t\t\"per_received,=,100|per_billed,=,100|status,!=,Closed|docstatus,=,1\",\r\n\t\t\t];\r\n\t\t}\r\n\t},\r\n\tformatters: {\r\n\t\tcustom_total_billed(value, df, doc) {\r\n\t\t\tlet percent = ((doc?.custom_total_billed/doc.grand_total) * 100).toFixed(1);\r\n\t\t\tlet color = percent >= 100 ? \"green\" : \"orange\";\r\n\t\t\tif (percent == 0 || doc.grand_total == 0) {\r\n\t\t\t   return `<div data-purchase-order=\"${doc.name}\" class=\"progress persent\" style=\"height: 20px;\" data-delivered-qty=\"0\" data-purchase-order-total-quantity=\"${doc.total_qty}\" data-total-billed=\"${doc?.custom_total_billed || ''}\" >\r\n                          <div class=\"progress-bar progress-bar progress-bar-success\" role=\"progressbar\" style=\"width: 0%\" aria-valuenow=\"0\" aria-valuemin=\"0\" aria-valuemax=\"300\">0%</div>\r\n                        </div>`;\r\n\t\t\t} else {\r\n\t\t\t    return `<div data-purchase-order=\"${doc.name}\" class=\"progress persent\" style=\"height: 20px;\" data-delivered-qty=\"${doc.custom_total_delivered_qty}\" data-purchase-order-total-quantity=\"${doc.total_qty}\" data-total-billed=\"${doc?.custom_total_billed || ''}\" >\r\n                          <div class=\"progress-bar progress-bar progress-bar-success\" role=\"progressbar\" style=\"width: ${percent}%; padding: 1px;\" aria-valuenow=\"${percent}\" aria-valuemin=\"0\" aria-valuemax=\"300\">${percent}%</div>\r\n                        </div>`\r\n\t\t\t}\r\n\t\t}\r\n\t},\r\n\tonload: function (listview) {\r\n\t\tvar method = \"erpnext.buying.doctype.purchase_order.purchase_order.close_or_unclose_purchase_orders\";\r\n\r\n\t\tlistview.page.add_menu_item(__(\"Close\"), function () {\r\n\t\t\tlistview.call_for_selected_items(method, { status: \"Closed\" });\r\n\t\t});\r\n\r\n\t\tlistview.page.add_menu_item(__(\"Reopen\"), function () {\r\n\t\t\tlistview.call_for_selected_items(method, { status: \"Submitted\" });\r\n\t\t});\r\n\r\n\t\tif (frappe.model.can_create(\"Purchase Invoice\")) {\r\n\t\t\tlistview.page.add_action_item(__(\"Purchase Invoice\"), () => {\r\n\t\t\t\terpnext.bulk_transaction_processing.create(listview, \"Purchase Order\", \"Purchase Invoice\");\r\n\t\t\t});\r\n\t\t}\r\n\r\n\t\tif (frappe.model.can_create(\"Purchase Receipt\")) {\r\n\t\t\tlistview.page.add_action_item(__(\"Purchase Receipt\"), () => {\r\n\t\t\t\terpnext.bulk_transaction_processing.create(listview, \"Purchase Order\", \"Purchase Receipt\");\r\n\t\t\t});\r\n\t\t}\r\n\r\n\t\tif (frappe.model.can_create(\"Payment Entry\")) {\r\n\t\t\tlistview.page.add_action_item(__(\"Advance Payment\"), () => {\r\n\t\t\t\terpnext.bulk_transaction_processing.create(listview, \"Purchase Order\", \"Payment Entry\");\r\n\t\t\t});\r\n\t\t}\r\n\t\t\r\n\t\tlistview.page.wrapper.on(\r\n        'mouseover',\r\n        '.persent',\r\n        function () {\r\n            let total_billed = $(this).data('total-billed')\r\n            let purchase_order = $(this).data('purchase-order')\r\n            let el = $(this)\r\n            frappe.call({\r\n        \t\tmethod: 'get_purchase_order_info',\r\n        \t\targs: {\r\n        \t\t\t'purchase_order': purchase_order\r\n        \t\t},\r\n        \t\tasync: false,\r\n        \t\tcallback: (r) => {\r\n        \t\t    console.log('re', r?.message)\r\n        \t\t    let total_delivered_qty = r?.message?.total_delivered_qty || 0\r\n        \t\t    let total_allocated_amount = r?.message?.total_allocated_amount || 0\r\n        \t\t    let so_total_qty = r?.message?.total_qty || 0\r\n                    el.tooltip({\r\n                        title: `\r\n                            <ul class=\"list-unstyled mb-0\">\r\n                                <li>\r\n                                    <b>PO Quantity:</b>\r\n                                    <span class=\"float-end\">${so_total_qty}</span>\r\n                                </li>\r\n                                <li>\r\n                                    <b>Received Quantity:</b>\r\n                                    <span class=\"float-end\">${total_delivered_qty}</span>\r\n                                </li>\r\n                                <li>\r\n                                    <b>Total Billed:</b>\r\n                                    <span class=\"float-end\">${format_currency(total_billed)}</span>\r\n                                </li>\r\n                            </ul>`\r\n                        ,\r\n                        placement: 'top',\r\n                        trigger: 'hover',\r\n                        html: true,\r\n                    }).tooltip('show');\r\n                }\r\n        \t});\r\n        }\r\n    );\r\n\t},\r\n};\r\n",
  "view": "List"
 }
]