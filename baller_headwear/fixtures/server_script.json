[
 {
  "allow_guest": 0,
  "api_method": "set_maintain_stock",
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Insert",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2025-07-30 11:15:13.127715",
  "module": null,
  "name": "Set Maintain Stock True",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": null,
  "script": "frappe.db.set_value(\"Item\", frappe.form_dict.get(\"item_code\"), \"is_stock_item\", 1)\nfrappe.msgprint(\"Maintain Stock set to TRUE for item.\")\n",
  "script_type": "API"
 },
 {
  "allow_guest": 0,
  "api_method": "get_stock_actual_qty",
  "cron_format": null,
  "disabled": 1,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Insert",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2026-01-14 17:13:06.101622",
  "module": "Baller Headwear",
  "name": "get_stock_actual_qty",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": null,
  "script": "# L·∫•y raw string items t·ª´ form_dict\nitems_raw = frappe.form_dict.get(\"items\")\n\n# N·∫øu items_raw l√† string JSON, parse ra list dict\nif isinstance(items_raw, str):\n    items = json.loads(items_raw)\nelse:\n    items = items_raw\n\nresults = []\n\n\nfor item in items:\n    item_code = item.get(\"item_code\")\n    not_yet_issued = float(item.get(\"not_yet_issued\", 0))\n    source_warehouse = item.get(\"source_warehouse\")\n    posting_time = frappe.utils.get_datetime(item.get(\"posting_time\"))\n\n    frappe.log_error(\n        message=f\"Processing item_code: {item_code}, not_yet_issued: {not_yet_issued}, source_warehouse: {source_warehouse}, posting_time: {posting_time}\",\n        title=\"Check Item Data\"\n    )\n    \n\n    # L·∫•y bin_data\n    bin_data = frappe.db.get_value(\n    \"Bin\",\n    filters={\"item_code\": item_code, \"warehouse\": source_warehouse},\n    fieldname=[\"item_code\", \"warehouse\", \"actual_qty\", \"modified\"],\n    as_dict=True\n    )\n    \n    if not bin_data:\n        results.append({\n            \"message\": \"No Bin data found\",\n            \"item_code\": item_code,\n            \"warehouse\": source_warehouse,\n        })\n        continue\n    \n    actual_qty = bin_data.actual_qty\n    modified = bin_data.modified\n\n    if posting_time >= modified:\n        final_qty = actual_qty\n    else:\n        # T√≠nh l·∫°i t·ªìn kho trong kho·∫£ng th·ªùi gian\n        se_items = frappe.get_all(\n            \"Stock Entry Detail\",\n            filters={\n                \"item_code\": item_code,\n                \"parenttype\": \"Stock Entry\",\n                \"docstatus\": 1,\n                \"modified\": [\"between\", [posting_time.date(), modified.date()]],\n                \"s_warehouse\": [\"in\", [source_warehouse, None]],\n            },\n            fields=[\"qty\", \"t_warehouse\", \"s_warehouse\", \"parent\"]\n        )\n\n        adjusted_qty = actual_qty\n\n        for se in se_items:\n            if se[\"t_warehouse\"] == source_warehouse:\n                adjusted_qty += se[\"qty\"]\n            elif se[\"s_warehouse\"] == source_warehouse:\n                adjusted_qty -= se[\"qty\"]\n\n        final_qty = adjusted_qty\n\n    if not_yet_issued > final_qty:\n        shortage_qty = not_yet_issued - final_qty\n        results.append({\n            \"item_code\": item_code,\n            \"warehouse\": source_warehouse,\n            \"available_qty\": final_qty,\n            \"required_qty\": not_yet_issued,\n            \"shortage_qty\": shortage_qty,\n            \"message\": f\"Insufficient stock for item '{item_code}' in warehouse '{source_warehouse}'. Shortage: {shortage_qty}. Please prioritize Work Orders.\"\n        })\n    else:\n        results.append({\n            \"message\": \"OK\",\n            \"item_code\": item_code,\n            \"available_qty\": final_qty\n            })\n\nfrappe.response[\"message\"] = results",
  "script_type": "API"
 },
 {
  "allow_guest": 0,
  "api_method": "get_work_order_item",
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Insert",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2026-01-22 14:17:18.756973",
  "module": null,
  "name": "get_work_order_item",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": null,
  "script": "work_orders = frappe.form_dict.get(\"work_orders\")\nget_only_fabric = int(frappe.form_dict.get(\"get_only_fabric\") or 0)\n\nif isinstance(work_orders, str):\n    work_orders = json.loads(work_orders)\n\nif not work_orders:\n    frappe.response[\"message\"] = []\n\n# N·∫øu ch·ªâ l·∫•y Fabric\nif get_only_fabric:\n    items = frappe.db.sql(\"\"\"\n        SELECT woi.item_code, woi.source_warehouse, woi.item_name,\n               woi.required_qty, woi.amount, woi.stock_uom, woi.rate,\n               woi.transferred_qty, woi.returned_qty,\n               woi.available_qty_at_source_warehouse,\n               woi.available_qty_at_wip_warehouse,\n               IFNULL((\n                    SELECT SUM(loi.leftover_qty)\n                    FROM `tabLeft Over Summary Items` loi\n                    WHERE loi.item_code = woi.item_code\n                ), 0) AS total_leftover_qty\n        FROM `tabWork Order Item` woi\n        JOIN `tabItem` i ON i.name = woi.item_code\n        WHERE woi.parent in %(work_orders)s\n          AND i.item_group = 'Fabric'\n    \"\"\", {\"work_orders\": work_orders}, as_dict=True)\nelse:\n    items = frappe.get_all(\n        \"Work Order Item\",\n        filters={\"parent\": [\"in\", work_orders]},\n        fields=[\n            \"item_code\",\"source_warehouse\", \"item_name\", \"required_qty\", \"amount\", \"stock_uom\", \"rate\",\n            \"transferred_qty\", \"returned_qty\", \"available_qty_at_source_warehouse\",\n            \"available_qty_at_wip_warehouse\", \"stock_uom\"\n        ]\n    )\n\n    # collect all item_codes\n    item_codes = [d.item_code for d in items]\n    \n    # get total leftover quantities grouped by item_code\n    leftovers = frappe.db.get_all(\n        \"Left Over Summary Items\",\n        filters={\"item_code\": [\"in\", item_codes]},\n        fields=[\"item_code\", \"SUM(leftover_qty) as total_leftover_qty\"],\n        group_by=\"item_code\"\n    )\n    \n    # convert list to dict for fast lookup\n    leftover_map = {d.item_code: d.total_leftover_qty for d in leftovers}\n    \n    # merge back into items list\n    for d in items:\n        d[\"total_leftover_qty\"] = leftover_map.get(d.item_code, 0)\n\nsummary = {}\n\nfor item in items:\n    key = (item[\"item_code\"], item[\"item_name\"], item[\"stock_uom\"])\n    if key not in summary:\n        summary[key] = {\n            \"item_code\": item[\"item_code\"],\n            \"source_warehouse\": item[\"source_warehouse\"],\n            \"item_name\": item[\"item_name\"],\n            \"stock_uom\": item[\"stock_uom\"],\n            \"required_qty\": 0,\n            \"amount\": 0,\n            \"rate\": item[\"rate\"],\n            \"expected_surplus_quantity\": item['total_leftover_qty'],\n            \"transferred_qty\": 0,\n            \"returned_qty\": 0,\n            \"available_qty_at_source_warehouse\": 0,\n            \"available_qty_at_wip_warehouse\": 0\n            \n        }\n\n    for field in [\n        \"required_qty\", \"amount\", \"transferred_qty\", \"returned_qty\",\n        \"available_qty_at_source_warehouse\", \"available_qty_at_wip_warehouse\"\n    ]:\n        summary[key][field] = float(summary[key][field]) + float(item.get(field, 0) or 0)\n\nfrappe.response[\"message\"] = list(summary.values())\n",
  "script_type": "API"
 },
 {
  "allow_guest": 0,
  "api_method": "create_material_transfers",
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Insert",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2026-01-10 12:21:43.696405",
  "module": null,
  "name": "create_material_transfers",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": null,
  "script": "summary_name = frappe.form_dict.get(\"summary_name\")\r\nget_only_fabric = int(frappe.form_dict.get(\"get_only_fabric\") or 0)\r\nwork_orders = frappe.form_dict.get(\"work_orders\")\r\nitems = frappe.form_dict.get(\"items\")\r\nmaterial_requests = frappe.form_dict.get(\"material_requests\")\r\nposting_date = frappe.form_dict.get(\"posting_date\")\r\n# load Material Summary doc t·ª´ t√™n\r\nsummary = frappe.get_doc(\"Material Summary\", summary_name)\r\n\r\n# parse JSON n·∫øu l√† string\r\nif isinstance(work_orders, str):\r\n    work_orders = json.loads(work_orders)\r\n    \r\ntotal_qty_work_order = sum([float(wo.get(\"qty\", 0)) for wo in work_orders])\r\n\r\nif isinstance(items, str):\r\n    items = json.loads(items)\r\n\r\nif isinstance(material_requests, str):\r\n    material_requests = json.loads(material_requests)\r\n\r\n# Map item_code -> source warehouse t·ª´ items trong request\r\nitem_source_map = {i[\"item_code\"]: i.get(\"source_warehouse\") for i in items}\r\n\r\nstock_entry_ids = []\r\nstock_entry_details = []\r\n\r\n# N·∫øu c√≥ material_requests ‚Üí l·∫•y work_order t·ª´ ƒë√≥\r\nif material_requests:\r\n    work_orders = frappe.get_all(\r\n        \"Material Request\",\r\n        filters={\r\n            \"name\": [\"in\", [mr[\"material_request\"] for mr in material_requests]]\r\n        },\r\n        fields=[\"work_order\", \"name\"]\r\n    )\r\nelse:\r\n    work_orders = summary.work_orders\r\n\r\nadjusted_distribution = {}\r\nadjusted_distribution_not_exist_in_bom= {}\r\n\r\nfor item in summary.items:\r\n    item_code = item.item_code\r\n    adjusted_distribution_not_exist_in_bom.setdefault(item_code, [])\r\n    planned_total = item.planned_used_qty\r\n    uom = frappe.db.get_value(\"Item\", item_code, \"stock_uom\")\r\n    wo_list = []\r\n    for wo in work_orders:\r\n        if isinstance(wo, dict):\r\n            wo_name = wo.get(\"work_order\")\r\n        else:\r\n            wo_name = wo.work_order\r\n\r\n        wo_doc = frappe.get_doc(\"Work Order\", wo_name)\r\n\r\n        for wo_item in wo_doc.required_items:\r\n            if wo_item.item_code == item_code:\r\n                remain = wo_item.required_qty - wo_item.transferred_qty\r\n                if remain > 0:\r\n                    wo_list.append({\r\n                        \"work_order\": wo_doc.name,\r\n                        \"remain\": remain,\r\n                        \"item_code\": item_code\r\n                    })\r\n\r\n    original_total = sum(w[\"remain\"] for w in wo_list)\r\n\r\n    uom = frappe.db.get_value(\"Item\", item_code, \"stock_uom\")\r\n    distribution = []\r\n    allocated_sum = 0\r\n    for w in wo_list:\r\n        planned = planned_total * (w[\"remain\"] / original_total)\r\n        if uom == \"Set\" or uom == 'Pcs':\r\n            planned_rounded = round(planned)\r\n        else:\r\n            planned_rounded = planned\r\n\r\n        distribution.append({\r\n            \"work_order\": w[\"work_order\"],\r\n            \"item_code\": item_code,\r\n            \"planned\": planned_rounded\r\n        })\r\n        allocated_sum += planned_rounded\r\n\r\n    if uom == \"Set\" or uom == 'Pcs':\r\n        diff = round(planned_total - allocated_sum)\r\n        if distribution and diff != 0:\r\n            distribution[-1][\"planned\"] = distribution[-1][\"planned\"] + diff\r\n    \r\n    if any(w.get(\"item_code\") == item_code for w in distribution):\r\n        filtered = [w for w in distribution if w.get(\"item_code\") == item_code]\r\n        if filtered:\r\n            adjusted_distribution[item_code] = distribution\r\n    else:\r\n        distributed_qty_sum = 0\r\n        if not item.not_in_bom:\r\n            continue\r\n        \r\n        for i, w in enumerate(work_orders):\r\n            wo_name = w.get(\"work_order\") if isinstance(w, dict) else w.work_order\r\n            qty_ratio = (w.get('qty') or 0) / total_qty_work_order\r\n            qty = planned_total * qty_ratio\r\n\r\n            uom = frappe.db.get_value(\"Item\", item_code, \"stock_uom\")\r\n            if uom == \"Set\" or uom == 'Pcs':\r\n                qty = round(qty)\r\n                distributed_qty_sum += qty\r\n\r\n            adjusted_distribution_not_exist_in_bom[item_code].append({\r\n                \"work_order\": wo_name,\r\n                \"planned\": planned_total,\r\n                \"rate\": qty_ratio,\r\n                \"qty\": qty,\r\n                \"s_warehouse\": item_source_map.get(item_code),\r\n                't_warehouse': frappe.get_doc(\"Work Order\", w.get(\"work_order\")).wip_warehouse\r\n            })\r\n\r\n        if uom == \"Set\" or uom == 'Pcs':\r\n            diff = planned_total - distributed_qty_sum\r\n            adjusted_distribution_not_exist_in_bom[item_code][-1][\"qty\"] = adjusted_distribution_not_exist_in_bom[item_code][-1][\"qty\"] + diff\r\n\r\n\r\nfor wo in work_orders:\r\n    se = frappe.new_doc(\"Stock Entry\")\r\n    se.set_posting_time = 1\r\n    se.stock_entry_type = \"Material Transfer for Manufacture\"\r\n    se.material_summary_doctype = \"Material Summary\"\r\n    se.material_summary = summary.name\r\n    se.posting_date = posting_date\r\n    se.from_bom = 1\r\n    wo_dict = wo if isinstance(wo, dict) else wo.as_dict()\r\n    se.work_order = wo_dict.get(\"work_order\")\r\n    se.bom_no = wo_dict.get(\"bom_no\")\r\n    se.fg_completed_qty = 0\r\n    se.company = wo_dict.get(\"company\") or 'Baller Headwear Vietnam Ltd'\r\n\r\n    wo_doc = frappe.get_doc(\"Work Order\", se.work_order)\r\n   \r\n    for wo_item in wo_doc.required_items:\r\n        item_code = wo_item.item_code\r\n        if get_only_fabric == 1:\r\n            item_group = frappe.db.get_value(\"Item\", item_code, \"item_group\")\r\n            if item_group != \"Fabric\":\r\n                continue\r\n\r\n        # Get the planned qty for THIS work order specifically\r\n        wo_plan_list = adjusted_distribution.get(item_code, [])\r\n            \r\n        wo_plan = 0\r\n        for p in wo_plan_list:\r\n            if p[\"work_order\"] == se.work_order:\r\n                wo_plan = p[\"planned\"]\r\n                break\r\n\r\n        planned_remain = wo_plan\r\n\r\n        if planned_remain <= 0:\r\n            continue\r\n       \r\n        required = (wo_item.required_qty or 0) - (wo_item.transferred_qty or 0)\r\n        if required <= 0:\r\n            continue\r\n\r\n        transfer_qty = planned_remain\r\n        # reduce from adjusted distribution map\r\n        for p in wo_plan_list:\r\n            if p[\"work_order\"] == se.work_order:\r\n                p[\"planned\"] = p[\"planned\"] - transfer_qty\r\n                break\r\n\r\n        s_warehouse = item_source_map.get(item_code)\r\n        if not s_warehouse:\r\n            frappe.throw(_(\"Missing source warehouse for Item {0}\").format(item_code))\r\n\r\n        se.append(\"items\", {\r\n            \"item_code\": item_code,\r\n            \"qty\": transfer_qty,\r\n            \"transfer_qty\": transfer_qty,   \r\n            \"uom\": wo_item.uom,   \r\n            \"s_warehouse\": s_warehouse,\r\n            \"t_warehouse\": wo_doc.wip_warehouse,\r\n            \"is_finished_item\": 0\r\n        })\r\n    \r\n    for item_code, plan_list in adjusted_distribution_not_exist_in_bom.items():\r\n        wo_doc = frappe.get_doc(\"Work Order\", se.work_order)\r\n        for plan in plan_list:\r\n            if plan['work_order'] == se.work_order:\r\n                se.append(\"items\", {\r\n                    \"item_code\": item_code,\r\n                    \"qty\": plan['qty'],\r\n                    \"transfer_qty\": plan['qty'],\r\n                    \"uom\": frappe.get_doc(\"Item\", item_code).stock_uom,\r\n                    \"s_warehouse\": plan['s_warehouse'],\r\n                    \"t_warehouse\": wo_doc.wip_warehouse,\r\n                    \"is_finished_item\": 0\r\n                })\r\n                break\r\n            \r\n    if se.items:\r\n        \r\n        se.insert(ignore_permissions=True)\r\n        se.submit()\r\n        se.reload()\r\n        # se.db_set(\"fg_completed_qty\", wo_dict.get(\"qty\"))\r\n        se.db_set(\"fg_completed_qty\", 0)\r\n        stock_entry_ids.append(se.name)\r\n        wo = frappe.get_doc(\"Work Order\", se.work_order)\r\n        if wo.status == \"Not Started\":\r\n            frappe.db.set_value(\"Work Order\", wo.name, \"status\", \"In Process\")\r\n            frappe.db.set_value(\"Work Order\", wo.name, \"material_transferred_for_manufacturing\", wo.qty)\r\n  \r\n        stock_entry_details.append({\r\n            \"id\": se.name,\r\n            \"stock_entry_type\": se.stock_entry_type,\r\n            \"work_order\": se.work_order,\r\n            \"material_summary\": se.material_summary,\r\n            \"bom_no\": se.bom_no,\r\n            \"fg_completed_qty\": se.fg_completed_qty,\r\n            \"items\": [\r\n                {\r\n                    \"item_code\": item.item_code,\r\n                    \"qty\": item.qty,\r\n                    \"s_warehouse\": item.s_warehouse,\r\n                    \"t_warehouse\": item.t_warehouse\r\n                }\r\n                for item in se.items\r\n            ]\r\n        })\r\n\r\nfrappe.response[\"stock_entries\"] = stock_entry_ids\r\nfrappe.response[\"stock_entry_details\"] = stock_entry_details",
  "script_type": "API"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 1,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Submit",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2025-10-27 18:38:49.620560",
  "module": null,
  "name": "update_WO_status",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "Stock Entry",
  "script": "# Ensure Work Order consistency on Manufacture or Transfer entries\n\nif doc.work_order:\n    work_order = frappe.get_doc(\"Work Order\", doc.work_order)\n    work_order_name = work_order.name \n\n    # Case 1: Material Transfer for Manufacture\n    if doc.purpose == \"Material Transfer for Manufacture\":\n        transferred_qty = work_order.qty\n\n        work_order.db_set(\"material_transferred_for_manufacturing\", transferred_qty)\n        work_order.db_set(\"status\", \"In Process\" if transferred_qty > 0 else \"Not Started\")\n        frappe.msgprint(f\"Work Order {work_order.name} updated ‚Äî Transferred Qty set to {transferred_qty}\")\n\n    # Case 2: Manufacture (without From BOM)\n    elif doc.purpose == \"Manufacture\":\n        def restore_material_transfer():\n            wo = frappe.get_doc(\"Work Order\", work_order_name)\n            if wo.material_transferred_for_manufacturing == 0:\n                frappe.db.set_value(\"Work Order\", work_order_name, \"material_transferred_for_manufacturing\", wo.qty)\n                frappe.msgprint(f\"‚úÖ Restored Transferred Qty on {work_order_name} ‚Üí {wo.qty}\")\n\n            if wo.status != \"In Process\":\n                frappe.db.set_value(\"Work Order\", work_order_name, \"status\", \"In Process\")\n\n        # Run *after* ERPNext finishes resetting it to 0\n        frappe.db.after_commit.add(restore_material_transfer)",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Insert",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2025-10-13 15:59:58.421279",
  "module": null,
  "name": "to reslove unsupported operand type(s) for 'NoneType' and 'int'",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "Subcontracting Order Item",
  "script": "# Only run if parent Subcontracting Order has a Purchase Order\nif doc.parent and doc.parenttype == \"Subcontracting Order\" and doc.purchase_order_item is None:\n    parent_doc = frappe.get_doc(\"Subcontracting Order\", doc.parent)\n\n    if parent_doc.purchase_order:\n        # Fetch all items from the linked Purchase Order\n        po_items = frappe.get_all(\n            \"Purchase Order Item\",\n            filters={\"parent\": parent_doc.purchase_order, \"item_code\": doc.item_code},\n            fields=[\"name\", \"item_code\"]\n        )\n\n        if po_items:\n            # Set the hidden purchase_order_item field\n            doc.purchase_order_item = po_items[0].name\n        else:\n            frappe.log_error(\n                message=f\"No matching Purchase Order Item found for {doc.item_code} in PO {parent_doc.purchase_order}\",\n                title=\"Subcontracting Order Item Warning\"\n            )\n",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "After Submit",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2025-10-23 09:09:48.772769",
  "module": null,
  "name": "left_over_update",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "Material Summary",
  "script": "leftover_summary = frappe.get_doc(\"Left Over Summary\", \"Left Over Summary Record\")  \n\nif not leftover_summary.left_over_table:\n    leftover_summary.left_over_table = []\n    \nexisting_rows = {(r.item_code,r.source_warehouse): r for r in leftover_summary.left_over_table}\n    \nfor row in doc.items:  \n    b_row = existing_rows.get(row.item_code)\n    if not b_row:\n        b_row = leftover_summary.append(\"left_over_table\",{})\n        b_row.item_code = row.item_code\n        b_row.source_warehouse = row.source_warehouse\n\n    b_row.leftover_qty = row.planned_leftover_qty\n\nleftover_summary.save(ignore_permissions=True)\n",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": "get_material_request_from_work_order",
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Insert",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2025-10-23 10:22:28.169566",
  "module": null,
  "name": "get_material_request_from_work_order",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": null,
  "script": "work_orders = frappe.form_dict.get(\"work_orders\")\n\nif isinstance(work_orders, str):\n    work_orders = json.loads(work_orders)\n\nif not work_orders:\n    frappe.response[\"message\"] = []\nelse:\n    mr_list = frappe.get_all(\n        \"Material Request\",\n        filters=[\n            [\"work_order\", \"in\", work_orders],\n            # [\"status\", \"!=\", \"Transferred\"],\n            [\"workflow_state\", \"=\", \"Approved\"]\n        ],\n        fields=[\n            \"name\",\"per_ordered\",\"per_received\",\n            \"schedule_date\",\"set_from_warehouse\",\"set_warehouse\",\n            \"transaction_date\",\"work_order\",\"workflow_state\"\n        ]\n    )\n    frappe.response[\"message\"] = mr_list\n",
  "script_type": "API"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 1,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "After Submit",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2025-10-27 19:01:12.892529",
  "module": null,
  "name": "matching_posting_date",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "Material Summary",
  "script": "# loop through all Stock Entries linked to this Material Summary\nstock_entries = frappe.get_all(\"Stock Entry\", filters={\"material_summary\": doc.name})\n\nfor se_name in stock_entries:\n    se = frappe.get_doc(\"Stock Entry\", se_name.name)\n    se.posting_date = doc.posting_date\n    se.save(ignore_permissions=True)",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Cancel",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2025-11-03 10:29:52.704462",
  "module": null,
  "name": "before_cancle",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "Stock Entry",
  "script": "doc.fg_completed_qty = 0",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": "get_material_request_item",
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Insert",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2025-11-10 13:36:13.924171",
  "module": "Baller Headwear",
  "name": "get_material_request_item",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": null,
  "script": "\"\"\"\nL·∫•y danh s√°ch item_code t·ª´ Material Request Item,\njoin v·ªõi Material Request ƒë·ªÉ l·ªçc d·ªØ li·ªáu\n\"\"\"\n\nmaterial_requests = frappe.form_dict.get(\"material_requests\")\nget_only_fabric = int(frappe.form_dict.get(\"get_only_fabric\") or 0)\n\nif isinstance(material_requests, str):\n    material_requests = json.loads(material_requests)\n\nif not material_requests:\n    frappe.response[\"message\"] = []\nelse:\n    if get_only_fabric:\n        # N·∫øu ch·ªâ l·∫•y Fabric\n        items = frappe.db.sql(\"\"\"\n            SELECT mri.item_code, mri.item_group, mri.item_name,\n                   mri.ordered_qty, mri.amount, mri.parent, mri.projected_qty,\n                   mri.qty, mri.received_qty, mri.sales_order, mri.schedule_date,\n                   mri.stock_qty, mri.stock_uom, mri.uom,\n                   mri.warehouse, mri.from_warehouse, mri.actual_qty\n            FROM `tabMaterial Request Item` mri\n            JOIN `tabMaterial Request` mr ON mr.name = mri.parent\n            WHERE mri.parent in %(material_requests)s\n              AND mri.ordered_qty = mri.qty\n        \"\"\", {\"material_requests\": tuple(material_requests)}, as_dict=True)\n    else:\n        items = frappe.get_all(\n            \"Material Request Item\",\n            filters={\"parent\": [\"in\", material_requests]},\n            fields=[\n                \"item_code\",\n                \"item_group\",\n                \"item_name\",\n                \"ordered_qty\",\n                \"amount\",\n                \"parent\",\n                \"projected_qty\",\n                \"qty\",\n                \"received_qty\",\n                \"sales_order\",\n                \"schedule_date\",\n                \"stock_qty\",\n                \"stock_uom\",\n                \"uom\",\n                \"warehouse\",\n                \"from_warehouse\",\n                \"actual_qty\"\n            ]\n        )\n\n    summary = {}\n\n    for item in items:\n        key = (item[\"item_code\"], item[\"item_name\"], item[\"stock_uom\"])\n        if key not in summary:\n            summary[key] = {\n                \"item_code\": item[\"item_code\"],\n                \"from_warehouse\": item[\"from_warehouse\"],\n                \"warehouse\": item[\"warehouse\"],\n                \"item_name\": item[\"item_name\"],\n                \"stock_uom\": item[\"stock_uom\"],\n                \"qty\": 0,\n                \"ordered_qty\": 0,\n                \"received_qty\": 0,\n                \"amount\": 0,\n                \"projected_qty\": 0,\n                \"actual_qty\": 0\n            }\n\n        for field in [\"qty\", \"ordered_qty\", \"received_qty\", \"amount\", \"projected_qty\",\"actual_qty\"]:\n            summary[key][field] = float(summary[key][field]) + float(item.get(field, 0) or 0)\n\n    frappe.response[\"message\"] = list(summary.values())\n",
  "script_type": "API"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "After Cancel",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2026-01-02 11:56:55.705048",
  "module": "Baller Headwear",
  "name": "update_work_order_after_cancel_stock_entry",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "Stock Entry",
  "script": "purpose = doc.purpose\r\nis_exist = frappe.db.exists(\"Work Order\", doc.work_order)\r\n\r\nif is_exist:\r\n    work_order = frappe.get_doc(\"Work Order\", doc.work_order)\r\n    status = work_order.status\r\n    if purpose == 'Material Transfer for Manufacture':\r\n        material_transferred_for_manufacturing = work_order.material_transferred_for_manufacturing\r\n        if material_transferred_for_manufacturing < 0:\r\n            material_transferred_for_manufacturing = 0\r\n        frappe.db.set_value(\"Work Order\", doc.work_order, \"material_transferred_for_manufacturing\", material_transferred_for_manufacturing)\r\n        stock_entry = frappe.db.sql(\"\"\"\r\n            SELECT 1\r\n            FROM `tabStock Entry`\r\n            WHERE work_order=%s AND docstatus=1\r\n            LIMIT 1\r\n        \"\"\", doc.work_order, as_dict=True)\r\n        \r\n        if stock_entry:\r\n            frappe.db.set_value(\"Work Order\", doc.work_order, \"status\", \"In Process\")\r\n            status = \"In Process\"\r\n        else:\r\n            frappe.db.set_value(\"Work Order\", doc.work_order, \"status\", \"Not Started\")\r\n            status = \"Not Started\"\r\n        \r\n    if purpose == 'Manufacture':\r\n        fg_items = [item for item in doc.items if item.s_warehouse is None]\r\n        fg_qty = 0\r\n        for item in fg_items:\r\n            fg_qty = fg_qty + (item.qty or 0)\r\n            \r\n        produced_qty = work_order.produced_qty - fg_qty\r\n        material_transferred_for_manufacturing = work_order.qty\r\n        frappe.db.set_value(\"Work Order\", doc.work_order, \"produced_qty\", produced_qty)\r\n        frappe.db.set_value(\"Work Order\", doc.work_order, \"material_transferred_for_manufacturing\", material_transferred_for_manufacturing)\r\n        stock_entry = frappe.db.sql(\"\"\"\r\n            SELECT 1\r\n            FROM `tabStock Entry`\r\n            WHERE work_order=%s AND docstatus=1\r\n            LIMIT 1\r\n        \"\"\", doc.work_order, as_dict=True)\r\n        \r\n        if stock_entry:\r\n            frappe.db.set_value(\"Work Order\", doc.work_order, \"status\", \"In Process\")\r\n            status = \"In Process\"\r\n        else:\r\n            frappe.db.set_value(\"Work Order\", doc.work_order, \"status\", \"Not Started\")\r\n            status = \"Not Started\"\r\n            \r\n    if status == 'Not Started':\r\n        frappe.db.set_value(\"Work Order\", doc.work_order, \"material_transferred_for_manufacturing\", 0)\r\n        frappe.db.set_value(\"Work Order\", doc.work_order, \"produced_qty\", 0)\r\n        ",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": "po_number_for_production_plan",
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Insert",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2025-11-20 12:24:52.637299",
  "module": null,
  "name": "po_number_for_production_plan",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": null,
  "script": "\n\"\"\"\nL·∫•y PO number t·ª´ Sale Orer v√† truy·ªÅn sang Production Plan\n\"\"\"\n\n\n\nresults = []\nitems = frappe.form_dict.get(\"items\")\n\n# N·∫øu items l√† string th√¨ parse th√†nh list\nif isinstance(items, str):\n    try:\n        items = json.loads(items)\n    except Exception as e:\n        frappe.throw(f\"Invalid items payload: {e}\")\n\nfor row in items:\n    item_code = row.get(\"item_code\")\n    sales_order = row.get(\"sales_order\")\n    sales_order_item = row.get(\"sales_order_item\")\n\n    custom_po_number = frappe.get_all(\n        \"Sales Order Item\",\n        filters={\n            \"item_code\": item_code,\n            \"parent\": sales_order,\n            \"name\": sales_order_item\n        },\n        fields=[\"custom_po_number\"]\n    )\n\n    if custom_po_number:\n        results.append({\n            \"rowname\": row.get(\"rowname\"),\n            \"custom_po_number\": custom_po_number[0].custom_po_number\n        })\n\nfrappe.response[\"message\"] = results\n",
  "script_type": "API"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Insert",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2025-11-20 12:06:13.686540",
  "module": null,
  "name": "get_po_number_for_work_order",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "Work Order",
  "script": "if doc.production_plan and doc.production_plan_item:\n    plan_item = frappe.get_doc(\"Production Plan Item\", doc.production_plan_item)\n    if plan_item.custom_po_number:\n        doc.custom_po_number = plan_item.custom_po_number",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Save",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2025-11-25 20:12:08.758524",
  "module": null,
  "name": "Start date of leave should be more than 7 days from creation date",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "Leave Application",
  "script": "# Apply rule only for Annual Leave\nif doc.leave_type == \"Annual Leave\":\n    if not doc.from_date:\n        frappe.throw(\"Please select a From Date.\")\n\n    creation_date = frappe.utils.getdate(doc.creation)\n    min_allowed_date = frappe.utils.add_days(creation_date, 7)\n\n    # Validate start date\n    if frappe.utils.getdate(doc.from_date) <= min_allowed_date:\n        frappe.throw(\n            f\"‚ùå <b>Annual Leave</b> must start at least <b>7 days after</b> the creation date.<br>\"\n            f\"üìÖ Creation Date: <b>{creation_date}</b><br>\"\n            f\"üü¢ Earliest Allowed Start Date: <b>{min_allowed_date}</b>\"\n        )\n",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 1,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "After Save",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2026-01-02 21:33:42.369246",
  "module": null,
  "name": "Get Rate",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "Daily Working Hours",
  "script": "overtime = doc.overtime_hours or 0\n\nif overtime > 0:\n    overtime_doc = frappe.new_doc(\"Employee Overtime\")\n    overtime_doc.employee_id = doc.employee_id\n    overtime_doc.date = doc.date\n    overtime_doc.overtime_hours = overtime\n    overtime_doc.shift = doc.shift_type   # mapping shift_type ‚Üí shift\n    \n    overtime_doc.insert(ignore_permissions=True)\n",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "After Submit",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2026-01-02 12:02:56.191315",
  "module": null,
  "name": "update_wo",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "Stock Entry",
  "script": "purpose = doc.purpose\r\nis_exist = frappe.db.exists(\"Work Order\", doc.work_order)\r\n\r\nif is_exist:\r\n    work_order = frappe.get_doc(\"Work Order\", doc.work_order)\r\n\r\n    if purpose == 'Material Transfer for Manufacture':\r\n        material_transferred_for_manufacturing = work_order.qty\r\n        if material_transferred_for_manufacturing < 0:\r\n            material_transferred_for_manufacturing = 0\r\n        frappe.db.set_value(\"Work Order\", doc.work_order, \"material_transferred_for_manufacturing\", material_transferred_for_manufacturing)\r\n        stock_entry = frappe.db.sql(\"\"\"\r\n            SELECT 1\r\n            FROM `tabStock Entry`\r\n            WHERE work_order=%s AND docstatus=1\r\n            LIMIT 1\r\n        \"\"\", doc.work_order, as_dict=True)\r\n        \r\n        if stock_entry:\r\n            frappe.db.set_value(\"Work Order\", doc.work_order, \"status\", \"In Process\")\r\n            status = \"In Process\"\r\n            \r\n    if purpose == 'Manufacture':\r\n        if work_order.produced_qty < work_order.qty:\r\n            frappe.db.set_value(\"Work Order\", doc.work_order, \"status\", \"In Process\")\r\n            frappe.db.set_value(\"Work Order\", doc.work_order, \"material_transferred_for_manufacturing\", work_order.qty)\r\n            \r\n        frappe.db.set_value(\"Work Order\", doc.work_order, \"material_transferred_for_manufacturing\", work_order.qty)\r\n    ",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "After Save",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2026-01-14 15:51:13.622687",
  "module": null,
  "name": "KPI Bonus",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "KPI Bonus Pay",
  "script": "# for idx, row in enumerate(doc.kpibonus):\n    \n#     # employee = frappe.db.get_value(\n#     #     \"Employee\",\n#     #     {\"custsom_line\": row.line},\n#     #     \"name\"\n#     # )\n\n#     # if not employee:\n#     #     frappe.log_error(\n#     #         \"KPI Bonus Error\",\n#     #         f\"Row {idx} | Employee NOT FOUND for custsom_line={row.line}\"\n#     #     )\n#     #     continue\n\n#     # -------- CREATE ADDITIONAL SALARY --------\n#     add = frappe.new_doc(\"Additional Salary\")\n#     add.employee = \"HR-EMP-00002\"\n#     add.company = \"Baller Headwear Pte. Ltd.\"\n\n#     # the Payroll Date from main document\n#     add.payroll_date = doc.payroll_date\n\n#     add.salary_component = \"Basic\"          # SAME AS SCREENSHOT\n#     add.salary_component_type = \"Earning\"   # Same as UI\n#     add.overwrite_salary_structure_amount = 1   # Checked\n#     add.amount = row.kpi_bonus              # Set your KPI bonus here\n\n#     # Optional extra fields shown in screenshot\n    \n\n#     add.save(ignore_mandatory=True)\n\n\n\n\n# Trigger: Document Event ‚Üí after_save\n\n# Trigger: Document Event ‚Üí after_save\n\nallowed_designations = [\n    'Logo Press Operator',\n    'Brim Fusing Operator',\n    'Hot-Cold Machine Operator',\n    'Auto-visor Operator',\n    'Auto Supporter',\n    'Auto Line Leader',\n    'Fusing Operator',\n    'Button Operator',\n    'Packing Operator',\n    'Packing Leader',\n    'Pressing Operator',\n    'Sweatband Operator',\n    'Cutting Operator',\n    'Cutting Supporter',\n    'Rolling Operator',\n    'Sewer for 45¬∞ Cutting Machine',\n    'Cut Counting Staff',\n    'Cutting Leader'\n]\n\n# Check once if \"currency\" field exists in Additional Salary (depends on ERPNext version/customization)\nadd_salary_has_currency = False\nmeta = frappe.get_meta(\"Additional Salary\")\nfor df in meta.fields:\n    if df.fieldname == \"currency\":\n        add_salary_has_currency = True\n        break\n\ntotal_created = 0\n\nfor row in doc.kpibonus:\n    created_for_line = 0\n\n    employee_list = frappe.get_all(\n        \"Employee\",\n        filters={\n            \"designation\": [\"in\", allowed_designations],\n            \"custom_line\": row.line\n        },\n        fields=[\"name\", \"company\"]\n    )\n\n    if not employee_list:\n        frappe.msgprint(f\"No employees found for allowed designations in line {row.line}\")\n        continue\n\n    for employee in employee_list:\n        # Block Duplicate Creation\n        exists = frappe.db.exists(\n            \"Additional Salary\",\n            {\n                \"employee\": employee.name,\n                \"payroll_date\": doc.payroll_date,\n                \"salary_component\": \"KPI Bonus\"\n            }\n        )\n        if exists:\n            continue\n\n        company = employee.company or doc.company\n\n        # ---- Fetch currency from Salary Structure Assignment (effective on payroll_date) ----\n        # SSA must be submitted (docstatus=1) and from_date <= payroll_date\n        ssa = frappe.get_all(\n            \"Salary Structure Assignment\",\n            filters={\n                \"employee\": employee.name,\n                \"company\": company,\n                \"docstatus\": 1,\n                \"from_date\": [\"<=\", doc.payroll_date],\n            },\n            fields=[\"salary_structure\"],\n            order_by=\"from_date desc\",\n            limit_page_length=1\n        )\n\n        currency = None\n        if ssa:\n            salary_structure = ssa[0].salary_structure\n            if salary_structure:\n                currency = frappe.db.get_value(\"Salary Structure\", salary_structure, \"currency\")\n\n        # ---- Create Additional Salary ----\n        add_salary = frappe.new_doc(\"Additional Salary\")\n        add_salary.employee = employee.name\n        add_salary.company = company\n        add_salary.payroll_date = doc.payroll_date\n\n        add_salary.salary_component = \"KPI Bonus\"\n        add_salary.salary_component_type = \"Earning\"\n        add_salary.overwrite_salary_structure_amount = 1\n\n        add_salary.amount = row.kpi_bonus\n\n        # Set currency ONLY if the field exists and we found a currency\n        if add_salary_has_currency and currency:\n            add_salary.currency = currency\n\n        add_salary.insert(ignore_permissions=True)\n        add_salary.submit()\n\n        created_for_line += 1\n        total_created += 1\n\n    if created_for_line:\n        frappe.msgprint(f\"{created_for_line} Additional Salary entries for line {row.line} created successfully.\")\n\n\n\n####################################################################################################\n# employees = frappe.get_all(\n#     \"Employee\",\n#     filters={\"designation\": [\"in\", allowed_designations],\n#         \"custsom_line\" : doc.line\n#     },\n#     fields=[\"name\", \"company\"]\n# )\n# lin\n# if not employees:\n#     frappe.msgprint(\"‚ùó No employees found for allowed designations.\")\n# else:\n#     created = 0\n\n#     for emp in employees:\n\n#         # Block Duplicate Creation\n#         exists = frappe.db.exists(\n#             \"Additional Salary\",\n#             {\n#                 \"employee\": emp.name,\n#                 \"payroll_date\": doc.payroll_date,\n#                 \"salary_component\": \"KPI Bonus\"\n#             }\n#         )\n\n#         if exists:\n#             continue\n\n#         add_salary = frappe.new_doc(\"Additional Salary\")\n#         add_salary.employee = emp.name\n#         add_salary.company = emp.company or doc.company\n#         add_salary.payroll_date = doc.payroll_date\n\n#         add_salary.salary_component = \"KPI Bonus\"\n#         add_salary.salary_component_type = \"Earning\"\n#         add_salary.overwrite_salary_structure_amount = 1\n#         add_salary.amount = doc.amount\n\n#         # Only INSERT (NO SUBMIT)\n#         add_salary.insert(ignore_permissions=True)\n\n#         created += 1\n\n#     frappe.msgprint(f\"üéâ {created} Additional Salary entries created successfully!\")\n",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Insert",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2025-12-04 20:22:14.797874",
  "module": null,
  "name": "Salary Slip",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "Salary Slip",
  "script": "if doc.payroll_entry:\r\n    employee_rows = frappe.get_all(\r\n        \"Payroll Employee Detail\",\r\n        filters={\r\n            \"parent\": doc.payroll_entry,\r\n            \"employee\": doc.employee\r\n        },\r\n        fields=[\"custom_total_working_hour\"]\r\n    )\r\n\r\n    if employee_rows:\r\n        doc.custom_total_working_hour = employee_rows[0].custom_total_working_hour or 0\r\n",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "After Insert",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2026-01-14 17:37:57.249606",
  "module": null,
  "name": "Attendance",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "Attendance Bonus",
  "script": "for row in doc.table_rbxn:\r\n\r\n    # --- Fetch currency from Salary Structure Assignment ---\r\n    currency = frappe.db.get_value(\r\n        \"Salary Structure Assignment\",\r\n        {\"employee\": row.employee, \"docstatus\": 1},\r\n        \"currency\"\r\n    )\r\n\r\n    # Fallback to company default currency if not found\r\n    if not currency:\r\n        currency = frappe.db.get_value(\"Company\", doc.company, \"default_currency\")\r\n\r\n    add_salary = frappe.new_doc(\"Additional Salary\")\r\n    add_salary.employee = row.employee\r\n    add_salary.company = doc.company\r\n    add_salary.salary_component = \"Attendance Allowance\"\r\n    add_salary.payroll_date = doc.payroll_date\r\n    add_salary.amount = row.allowance_amount\r\n    add_salary.currency = currency\r\n    add_salary.overwrite_salary_structure_amount = 1\r\n\r\n    add_salary.insert(ignore_permissions=True)\r\n    add_salary.submit()\r\n\r\nfrappe.msgprint(\"üéâ Additional Salary Entries Created Successfully!\")\r\n",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Save",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2026-01-02 15:29:08.713059",
  "module": null,
  "name": "Fetch Employee Working Hours on Payroll Entry",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "Payroll Entry",
  "script": "for row in doc.employees or []:\r\n\r\n    # Skip if no employee selected\r\n    if not row.employee:\r\n        continue\r\n\r\n    # Skip if already manually populated\r\n    if row.custom_total_working_hour:\r\n        continue\r\n\r\n    # Fetch Daily Working Hours records\r\n    records = frappe.get_all(\r\n        \"Daily Working Hours\",\r\n        filters={\r\n            \"employee_id\": row.employee,   # change if fieldname differs\r\n            \"date\": [\"between\", [doc.start_date, doc.end_date]],\r\n        },\r\n        fields=[\r\n            \"actual_working_hours\",\r\n            \"standard_working_hours\"\r\n        ],\r\n        limit_page_length=5000\r\n    )\r\n\r\n    total = 0\r\n    for r in records:\r\n        total_hours = r.get(\"actual_working_hours\") or 0\r\n        standard_hours = r.get(\"standard_working_hours\") or 0\r\n\r\n        # Take whichever is smaller\r\n        total += min(total_hours, standard_hours)\r\n\r\n    # Set back to child row\r\n    row.custom_total_working_hour = total\r\n",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": "get_pcs_documents_for_line",
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Insert",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2025-12-14 18:31:11.552731",
  "module": null,
  "name": "Fetching Documents Based on the Date and Line Filter",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": null,
  "script": "# ------------------------------------------------------------\r\n# INPUTS\r\n# ------------------------------------------------------------\r\nline = frappe.request.form.get(\"line\")\r\nfrom_date = frappe.request.form.get(\"from_date\")\r\nto_date = frappe.request.form.get(\"to_date\")\r\nemployee = frappe.request.form.get(\"employee\")\r\n\r\n# OPTIONAL (for updating the parent doc)\r\ndoctype = frappe.request.form.get(\"doctype\")   # e.g. \"Sewing Line Incentive\"\r\ndocname = frappe.request.form.get(\"docname\")   # current document name\r\n\r\nif not line or not from_date or not to_date or not employee:\r\n    frappe.throw(\"Line, From Date, To Date and Employee are required.\")\r\n\r\n# ------------------------------------------------------------\r\n# 1) Monthly output per product\r\n# ------------------------------------------------------------\r\n\r\ndata = frappe.db.sql(\"\"\"\r\n    SELECT\r\n        c.product_code,\r\n        SUM(c.quantity) AS total_quantity\r\n    FROM `tabPcs Produced Per Day Per Employee` p\r\n    JOIN `tabProduct Produced By Employee` c\r\n        ON c.parent = p.name\r\n    WHERE p.line = %s\r\n      AND p.employee = %s\r\n      AND p.date BETWEEN %s AND %s\r\n    GROUP BY c.product_code\r\n    ORDER BY c.product_code\r\n\"\"\", (line, employee, from_date, to_date), as_dict=True)\r\n\r\nif not data:\r\n    frappe.response.message = {\"rows\": [], \"total_line_incentive\": 0}\r\n\r\nproduct_codes = [d[\"product_code\"] for d in data if d.get(\"product_code\")]\r\n\r\n# ------------------------------------------------------------\r\n# 2) KPI Cutoff slabs\r\n# ------------------------------------------------------------\r\n\r\ncutoff_map = {}\r\n\r\nif product_codes:\r\n    placeholders = \", \".join([\"%s\"] * len(product_codes))\r\n\r\n    cutoffs = frappe.db.sql(f\"\"\"\r\n        SELECT\r\n            parent AS product_code,\r\n            kpi_cutoff_upper_limit,\r\n            kpi\r\n        FROM `tabProduct Code KPI Cut Off`\r\n        WHERE parenttype = 'Product Code'\r\n          AND parent IN ({placeholders})\r\n        ORDER BY parent, kpi_cutoff_upper_limit\r\n    \"\"\", tuple(product_codes), as_dict=True)\r\n\r\n    for r in cutoffs:\r\n        pc = r.get(\"product_code\")\r\n        if pc:\r\n            cutoff_map.setdefault(pc, []).append(\r\n                (r.get(\"kpi_cutoff_upper_limit\"), r.get(\"kpi\"))\r\n            )\r\n\r\n# ------------------------------------------------------------\r\n# 3) Fetch UI + SMV per product\r\n# ------------------------------------------------------------\r\n\r\nproduct_meta_map = {}\r\n\r\nproducts = frappe.get_all(\r\n    \"Product Code\",\r\n    filters={\"name\": [\"in\", product_codes]},\r\n    fields=[\"name\", \"ui\", \"smv\"]  # your working fields\r\n)\r\n\r\nfor p in products:\r\n    product_meta_map[p[\"name\"]] = {\r\n        \"ui\": p.get(\"ui\"),\r\n        \"smv\": p.get(\"smv\")\r\n    }\r\n\r\n# ------------------------------------------------------------\r\n# 4) Fetch Quality Ratio\r\n# ------------------------------------------------------------\r\n\r\nquality_ratio = frappe.db.get_value(\r\n    \"Quality Ratio For Sewing Line\",\r\n    {\"line\": line},\r\n    \"quality_ratio\"\r\n)\r\n\r\nquality_ratio = float(quality_ratio)\r\n\r\n# ------------------------------------------------------------\r\n# 5) KPI selection + Incentive calculation\r\n# ------------------------------------------------------------\r\n\r\ntotal_line_incentive = 0.0\r\n\r\nfor d in data:\r\n    product_code = d.get(\"product_code\")\r\n    qty = float(d.get(\"total_quantity\") or 0)\r\n\r\n    # KPI slab logic\r\n    rules = cutoff_map.get(product_code, [])\r\n    selected_kpi = None\r\n\r\n    if rules:\r\n        selected_kpi = rules[0][1]\r\n        output = float(qty)\r\n\r\n        for upper_limit, kpi in rules:\r\n            if upper_limit is None:\r\n                continue\r\n            if output >= float(upper_limit):\r\n                selected_kpi = kpi\r\n            else:\r\n                break\r\n\r\n    d[\"kpi\"] = float(selected_kpi)\r\n\r\n    meta = product_meta_map.get(product_code, {})\r\n    d[\"ui\"] = float(meta.get(\"ui\"))\r\n    d[\"smv\"] = float(meta.get(\"smv\"))\r\n    d[\"quality_ratio\"] = quality_ratio\r\n\r\n    d[\"line_incentive\"] = round((\r\n        d[\"ui\"] *\r\n        d[\"quality_ratio\"] *\r\n        d[\"kpi\"] *\r\n        ((qty * d[\"smv\"]) / 60.0)\r\n    ),2)\r\n\r\n    total_line_incentive += float(d[\"line_incentive\"])\r\n\r\n# ------------------------------------------------------------\r\n# 6) Total + Populate document\r\n# ------------------------------------------------------------\r\n\r\nif doctype and docname:\r\n\r\n    # writes directly to DB (fast + safe for server-script)\r\n    frappe.db.set_value(doctype, docname, \"total_line_incentive\", total_line_incentive)\r\n\r\n# ------------------------------------------------------------\r\n# DONE\r\n# ------------------------------------------------------------\r\n\r\n# (Optional) still return structured data for the client to use later\r\nfrappe.response.message = {\r\n    \"rows\": data,\r\n    \"total_line_incentive\": total_line_incentive\r\n}\r\n\r\n",
  "script_type": "API"
 },
 {
  "allow_guest": 0,
  "api_method": "get_ironing_line_summary",
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Insert",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2025-12-22 04:09:12.212214",
  "module": null,
  "name": "Fetch Ironing Line Summary for Pcs Based Incentive",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": null,
  "script": "# Server Script: get_ironing_line_summary\r\n# - Operators: UI * KPI * total_qty\r\n# Server Script: get_ironing_line_summary\r\n# - Operators: UI * KPI * total_qty\r\n# - Pool = sum(operator incentive where KPI >= 1)\r\n# - Beneficiaries (Technician, Shift Leader, Ironing Leader): 1% EACH of pool (NOT split)\r\n# - Avg per day uses ONLY days where Pcs Produced Per Day Per Employee exists (timesheet days)\r\n\r\nline = frappe.form_dict.get(\"line\")\r\nfrom_date = frappe.form_dict.get(\"from_date\")\r\nto_date = frappe.form_dict.get(\"to_date\")\r\n\r\nif not line or not from_date or not to_date:\r\n    frappe.throw(\"line, from_date, to_date are required\")\r\n\r\nUI = 400\r\n\r\nallowed_designations = [\r\n    \"Ironing Operator\",\r\n    \"Ironing Technician\",\r\n    \"Shift Leader\",\r\n    \"Ironing Leader\",\r\n]\r\n\r\nbeneficiary_designations = [\r\n    \"Ironing Technician\",\r\n    \"Shift Leader\",\r\n    \"Ironing Leader\",\r\n]\r\n\r\nemployees = frappe.get_all(\r\n    \"Employee\",\r\n    filters={\r\n        \"department\": line,\r\n        \"status\": \"Active\",\r\n        \"designation\": [\"in\", allowed_designations],\r\n    },\r\n    fields=[\"name as employee\", \"designation\"],\r\n    order_by=\"name\",\r\n)\r\n\r\nemployee_list = [e.employee for e in employees]\r\n\r\nfinal_rows = []\r\npool_kpi_ge_1 = 0.0\r\n\r\nper_beneficiary = 0.0\r\nbeneficiary_total = 0.0\r\nbeneficiary_count = 0\r\n\r\nif employee_list:\r\n\r\n    # IMPORTANT:\r\n    # working_days = count of distinct p.date where a p record exists for that employee in the range.\r\n    # avg_per_day = total_qty / working_days (not calendar days)\r\n    agg_rows = frappe.db.sql(\r\n        \"\"\"\r\n        SELECT\r\n            p.employee AS employee,\r\n            SUM(c.quantity) AS total_qty,\r\n            COUNT(DISTINCT p.date) AS working_days,\r\n            (\r\n                SUM(c.quantity) / NULLIF(COUNT(DISTINCT p.date), 0)\r\n            ) AS avg_per_day\r\n        FROM `tabPcs Produced Per Day Per Employee` p\r\n        INNER JOIN `tabProduct Produced By Employee` c\r\n            ON c.parent = p.name\r\n        WHERE\r\n            p.line = %(line)s\r\n            AND p.type = 'Ironing'\r\n            AND p.date BETWEEN %(from_date)s AND %(to_date)s\r\n            AND p.employee IN %(employees)s\r\n        GROUP BY p.employee\r\n        \"\"\",\r\n        {\r\n            \"line\": line,\r\n            \"from_date\": from_date,\r\n            \"to_date\": to_date,\r\n            \"employees\": tuple(employee_list),\r\n        },\r\n        as_dict=True\r\n    )\r\n\r\n    agg_map = {r[\"employee\"]: r for r in agg_rows}\r\n\r\n    for e in employees:\r\n        emp = e[\"employee\"]\r\n        des = e[\"designation\"]\r\n\r\n        total_qty = float(agg_map.get(emp, {}).get(\"total_qty\") or 0)\r\n        working_days = int(agg_map.get(emp, {}).get(\"working_days\") or 0)\r\n        avg_per_day = float(agg_map.get(emp, {}).get(\"avg_per_day\") or 0)\r\n\r\n        if avg_per_day >= 300:\r\n            kpi = 1.5\r\n        elif avg_per_day >= 200:\r\n            kpi = 1.2\r\n        elif avg_per_day >= 80:\r\n            kpi = 1.0\r\n        else:\r\n            kpi = 0.0\r\n\r\n        employee_incentive = 0.0\r\n        if des == \"Ironing Operator\":\r\n            employee_incentive = UI * kpi * total_qty\r\n\r\n        final_rows.append({\r\n            \"employee\": emp,\r\n            \"designation\": des,\r\n            \"total_qty\": total_qty,\r\n            \"working_days\": working_days,     # <-- NEW (actual days with entries)\r\n            \"avg_per_day\": avg_per_day,\r\n            \"kpi\": kpi,\r\n            \"employee_incentive\": employee_incentive,\r\n        })\r\n\r\n    # Pool = sum(operator incentive where KPI >= 1\r\n    for r in final_rows:\r\n        if r[\"designation\"] == \"Ironing Operator\" and float(r[\"kpi\"] or 0) >= 1:\r\n            pool_kpi_ge_1 += float(r[\"employee_incentive\"] or 0)\r\n\r\n    # Common beneficiary payout: 1% EACH (not split)\r\n    beneficiaries = [r for r in final_rows if r[\"designation\"] in beneficiary_designations]\r\n    beneficiary_count = len(beneficiaries)\r\n\r\n    per_beneficiary = pool_kpi_ge_1 * 0.01\r\n\r\n    for r in beneficiaries:\r\n        r[\"employee_incentive\"] = per_beneficiary\r\n\r\n    beneficiary_total = per_beneficiary * beneficiary_count\r\n\r\nfrappe.response[\"message\"] = {\r\n    \"rows\": final_rows,\r\n    \"ui\": UI,\r\n    \"pool_kpi_ge_1\": pool_kpi_ge_1,\r\n    \"beneficiary_designations\": beneficiary_designations,\r\n    \"beneficiary_count\": beneficiary_count,\r\n    \"per_beneficiary\": per_beneficiary,\r\n    \"beneficiary_total\": beneficiary_total,\r\n}\r\n\r\n",
  "script_type": "API"
 },
 {
  "allow_guest": 0,
  "api_method": "create_additional_salary_for_ironing",
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Insert",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2026-01-14 17:11:47.336006",
  "module": null,
  "name": "Additional Salary - Pcs Based Incentive - Ironing",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": null,
  "script": "docname = (frappe.form_dict.get(\"docname\") or \"\").strip()\r\nline_type = (frappe.form_dict.get(\"line_type\") or \"\").strip()\r\n\r\nif not docname:\r\n    frappe.throw(\"docname is required\")\r\nif not line_type:\r\n    frappe.throw(\"line_type is required\")\r\n\r\ndoc = frappe.get_doc(\"Pcs Based Incentive\", docname)\r\n\r\n# Payroll date from document\r\npayroll_date = doc.get(\"to_date\")\r\nif not payroll_date:\r\n    frappe.throw(\"to_date is missing on Pcs Based Incentive document\")\r\n\r\nsalary_component = \"Pcs Based Incentive\"\r\nif not frappe.db.exists(\"Salary Component\", salary_component):\r\n    frappe.throw(f\"Salary Component not found: {salary_component}\")\r\n\r\n# Select correct child table\r\nif line_type == \"Ironing\":\r\n    child_rows = doc.get(\"employee_ironing_incentive\") or []\r\nelif line_type == \"Sewing\":\r\n    child_rows = doc.get(\"pcs_based_employee_incentive_table\") or []\r\nelse:\r\n    child_rows = []\r\n\r\n# Detect Additional Salary fields\r\nmeta = frappe.get_meta(\"Additional Salary\")\r\nhas_company = False\r\nhas_currency = False\r\ncompany_is_reqd = False\r\n\r\nfor df in meta.fields:\r\n    if df.fieldname == \"company\":\r\n        has_company = True\r\n        if df.reqd == 1:\r\n            company_is_reqd = True\r\n    if df.fieldname == \"currency\":\r\n        has_currency = True\r\n\r\ncreated = 0\r\nskipped_zero = 0\r\nskipped_duplicate = 0\r\nskipped_missing_company = 0\r\nskipped_missing_ssa = 0\r\nerrors = 0\r\n\r\nmissing_ssa = []\r\ncreated_employees = []\r\n\r\nfor row in child_rows:\r\n    employee = row.get(\"employee\")\r\n    amount = row.get(\"incentive_amount\") or 0\r\n\r\n    if not employee:\r\n        continue\r\n\r\n    # Skip zero/negative amounts\r\n    if amount <= 0:\r\n        skipped_zero += 1\r\n        continue\r\n\r\n    # Resolve company if field exists\r\n    company = None\r\n    if has_company:\r\n        company = doc.get(\"company\") or frappe.db.get_value(\"Employee\", employee, \"company\")\r\n        if company_is_reqd and not company:\r\n            skipped_missing_company += 1\r\n            continue\r\n\r\n    # Salary Structure Assignment REQUIRED\r\n    ssa = frappe.get_all(\r\n        \"Salary Structure Assignment\",\r\n        filters={\"employee\": employee, \"docstatus\": 1},\r\n        fields=[\"salary_structure\"],\r\n        order_by=\"from_date desc\",\r\n        limit_page_length=1\r\n    )\r\n\r\n    if not ssa:\r\n        skipped_missing_ssa += 1\r\n        missing_ssa.append(employee)\r\n        continue\r\n\r\n    salary_structure = ssa[0].get(\"salary_structure\")\r\n\r\n    # Resolve currency if field exists\r\n    currency = None\r\n    if has_currency and salary_structure:\r\n        currency = frappe.db.get_value(\"Salary Structure\", salary_structure, \"currency\")\r\n\r\n    # Duplicate check\r\n    dup_filters = {\r\n        \"employee\": employee,\r\n        \"payroll_date\": payroll_date,\r\n        \"salary_component\": salary_component\r\n    }\r\n    if has_company and company:\r\n        dup_filters[\"company\"] = company\r\n\r\n    if frappe.db.exists(\"Additional Salary\", dup_filters):\r\n        skipped_duplicate += 1\r\n        continue\r\n\r\n    # Create Additional Salary\r\n    try:\r\n        add_salary = frappe.new_doc(\"Additional Salary\")\r\n        add_salary.employee = employee\r\n        add_salary.payroll_date = payroll_date\r\n        add_salary.salary_component = salary_component\r\n        add_salary.salary_component_type = \"Earning\"\r\n        add_salary.overwrite_salary_structure_amount = 1\r\n        add_salary.amount = amount\r\n\r\n        if has_company and company:\r\n            add_salary.company = company\r\n\r\n        if has_currency and currency:\r\n            add_salary.currency = currency\r\n\r\n        add_salary.insert(ignore_permissions=True)\r\n        add_salary.submit()\r\n\r\n        created += 1\r\n        created_employees.append(employee)\r\n\r\n    except Exception:\r\n        errors += 1\r\n        frappe.log_error(\r\n            title=\"Pcs Based Incentive ‚Üí Additional Salary failed\",\r\n            message=frappe.get_traceback()\r\n        )\r\n\r\n# -------- Preview Popup --------\r\n\r\nhtml = \"<div>\"\r\nhtml += f\"<div><b>Document:</b> {frappe.utils.escape_html(doc.name)}</div>\"\r\nhtml += f\"<div><b>Payroll Date:</b> {payroll_date}</div><br>\"\r\n\r\nhtml += f\"<b>Additional Salary Created ({len(created_employees)}):</b><br>\"\r\nif created_employees:\r\n    html += \"<br>\".join(created_employees)\r\nelse:\r\n    html += \"None\"\r\n\r\nhtml += \"<br><br>\"\r\n\r\nhtml += f\"<b>Skipped (No Salary Structure Assignment) ({len(missing_ssa)}):</b><br>\"\r\nif missing_ssa:\r\n    html += \"<br>\".join(missing_ssa)\r\nelse:\r\n    html += \"None\"\r\n\r\nhtml += \"</div>\"\r\n\r\nfrappe.msgprint(html)\r\n\r\n# -------- Response Summary --------\r\n\r\nfrappe.response[\"message\"] = {\r\n    \"ok\": True,\r\n    \"docname\": doc.name,\r\n    \"line_type\": line_type,\r\n    \"payroll_date_used\": str(payroll_date),\r\n    \"created\": created,\r\n    \"skipped_zero\": skipped_zero,\r\n    \"skipped_duplicate\": skipped_duplicate,\r\n    \"skipped_missing_company\": skipped_missing_company,\r\n    \"skipped_missing_ssa\": skipped_missing_ssa,\r\n    \"errors\": errors\r\n}\r\n\r\n\r\n",
  "script_type": "API"
 },
 {
  "allow_guest": 0,
  "api_method": "fetch_sewing_line_rate",
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Insert",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2025-12-14 14:45:04.452172",
  "module": null,
  "name": "Fetch Sewing Line Rate",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": null,
  "script": "line = frappe.request.form.get(\"line\")\r\n\r\nif not line:\r\n    frappe.throw(\"line is required\")\r\n\r\nallowed_designations = [\"Sewing Operator\", \"Sewing Supporter\"]\r\n\r\nEMP_SKILL_LEVEL_FIELD = \"custom_skill_level\"\r\nEMP_OPERATION_LEVEL_FIELD = \"custom_operation_level\"\r\n\r\nSKILL_LEVEL_DOCTYPE = \"Skill Level\"\r\nSKILL_RATE_FIELD = \"skill_rate\"\r\n\r\nOP_LEVEL_DOCTYPE = \"Operation Level\"\r\nOP_RATE_FIELD = \"operation_rate\"\r\n\r\nemployees = frappe.get_all(\r\n    \"Employee\",\r\n    filters={\r\n        \"department\": line,\r\n        \"status\": \"Active\",\r\n        \"designation\": [\"in\", allowed_designations],\r\n    },\r\n    fields=[\r\n        EMP_SKILL_LEVEL_FIELD,\r\n        EMP_OPERATION_LEVEL_FIELD,\r\n    ],\r\n)\r\n\r\nline_rate = 0.0\r\n\r\nfor e in employees:\r\n    skill_level = e.get(EMP_SKILL_LEVEL_FIELD)\r\n    op_level = e.get(EMP_OPERATION_LEVEL_FIELD)\r\n\r\n    skill_rate = frappe.db.get_value(SKILL_LEVEL_DOCTYPE, skill_level, SKILL_RATE_FIELD) if skill_level else 0\r\n    op_rate = frappe.db.get_value(OP_LEVEL_DOCTYPE, op_level, OP_RATE_FIELD) if op_level else 0\r\n\r\n    line_rate += float(skill_rate or 0) * float(op_rate or 0)\r\n\r\nfrappe.response[\"message\"] = {\r\n    \"line_rate\": round(line_rate,2)\r\n}\r\n",
  "script_type": "API"
 },
 {
  "allow_guest": 0,
  "api_method": "get_sewing_employees_with_rates_and_hours",
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Insert",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2025-12-23 15:28:40.003337",
  "module": null,
  "name": "Pcs Based Incentive - Fetch All Employee Incentives",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": null,
  "script": "line = frappe.form_dict.get(\"line\")\r\nfrom_date = frappe.form_dict.get(\"from_date\")\r\nto_date = frappe.form_dict.get(\"to_date\")\r\n\r\nif not line:\r\n    frappe.throw(\"line is required\")\r\nif not from_date or not to_date:\r\n    frappe.throw(\"from_date and to_date are required\")\r\n\r\n\r\n# ============================================================\r\n# QUALITY RATIO EXISTENCE CHECK (UPDATE THESE TO MATCH YOUR SETUP)\r\n# ============================================================\r\nQR_DOCTYPE = \"Quality Ratio For Sewing Line\"\r\nQR_LINE_FIELD = \"line\"\r\nQR_FROM_FIELD = \"from_date\"\r\nQR_TO_FIELD = \"to_date\"\r\n\r\nqr_name = frappe.db.exists(\r\n    QR_DOCTYPE,\r\n    {\r\n        QR_LINE_FIELD: line,\r\n        QR_FROM_FIELD: from_date,\r\n        QR_TO_FIELD: to_date,\r\n    }\r\n)\r\n\r\n\r\n# ============================================================\r\n# EMPLOYEE + RATES\r\n# ============================================================\r\nEMP_SKILL_LEVEL_FIELD = \"custom_skill_level\"\r\nEMP_OPERATION_LEVEL_FIELD = \"custom_operation_level\"\r\n\r\nSKILL_LEVEL_DOCTYPE = \"Skill Level\"\r\nSKILL_RATE_FIELD = \"skill_rate\"\r\n\r\nOP_LEVEL_DOCTYPE = \"Operation Level\"\r\nOP_RATE_FIELD = \"operation_rate\"\r\n\r\nemployees = frappe.get_all(\r\n    \"Employee\",\r\n    filters={\r\n        \"department\": line,\r\n        \"status\": \"Active\",\r\n    },\r\n    fields=[\r\n        \"name\",\r\n        \"employee\",   # needed for mapping with Daily Working Hours\r\n        \"designation\",\r\n        f\"{EMP_SKILL_LEVEL_FIELD} as skill_level\",\r\n        f\"{EMP_OPERATION_LEVEL_FIELD} as operation_level\",\r\n    ],\r\n    order_by=\"name\",\r\n)\r\n\r\n# Collect linked levels for bulk-fetch\r\nskill_levels = sorted({e.get(\"skill_level\") for e in employees if e.get(\"skill_level\")})\r\nop_levels = sorted({e.get(\"operation_level\") for e in employees if e.get(\"operation_level\")})\r\n\r\n# Bulk fetch rates\r\nskill_rate_map = {}\r\nif skill_levels:\r\n    rows = frappe.get_all(\r\n        SKILL_LEVEL_DOCTYPE,\r\n        filters={\"name\": [\"in\", skill_levels]},\r\n        fields=[\"name\", SKILL_RATE_FIELD],\r\n    )\r\n    skill_rate_map = {r[\"name\"]: (r.get(SKILL_RATE_FIELD) or 0) for r in rows}\r\n\r\nop_rate_map = {}\r\nif op_levels:\r\n    rows = frappe.get_all(\r\n        OP_LEVEL_DOCTYPE,\r\n        filters={\"name\": [\"in\", op_levels]},\r\n        fields=[\"name\", OP_RATE_FIELD],\r\n    )\r\n    op_rate_map = {r[\"name\"]: (r.get(OP_RATE_FIELD) or 0) for r in rows}\r\n\r\n\r\n# ============================================================\r\n# DAILY WORKING HOURS AGGREGATION\r\n# standard_working_hours fallback: if null/0 => 8\r\n# ============================================================\r\nDWH_DOCTYPE = \"Daily Working Hours\"\r\nDWH_EMP_FIELD = \"employee_id\"\r\nDWH_DATE_FIELD = \"date\"\r\nDWH_STD_FIELD = \"standard_working_hours\"\r\nDWH_TOTAL_FIELD = \"actual_working_hours\"\r\n\r\nemployee_ids = [e.get(\"employee\") for e in employees if e.get(\"employee\")]\r\ndwh_map = {}\r\n\r\nif employee_ids:\r\n    placeholders = \", \".join([\"%s\"] * len(employee_ids))\r\n    rows = frappe.db.sql(\r\n        f\"\"\"\r\n        SELECT\r\n            `{DWH_EMP_FIELD}` AS employee_id,\r\n            SUM(\r\n                CASE\r\n                    WHEN `{DWH_STD_FIELD}` IS NULL OR `{DWH_STD_FIELD}` = 0\r\n                    THEN 8\r\n                    ELSE `{DWH_STD_FIELD}`\r\n                END\r\n            ) AS std_hours_sum,\r\n            COALESCE(SUM(`{DWH_TOTAL_FIELD}`), 0) AS total_hours_sum\r\n        FROM `tab{DWH_DOCTYPE}`\r\n        WHERE `{DWH_EMP_FIELD}` IN ({placeholders})\r\n          AND `{DWH_DATE_FIELD}` BETWEEN %s AND %s\r\n        GROUP BY `{DWH_EMP_FIELD}`\r\n        \"\"\",\r\n        tuple(employee_ids) + (from_date, to_date),\r\n        as_dict=True,\r\n    )\r\n\r\n    dwh_map = {\r\n        r[\"employee_id\"]: {\r\n            \"std_hours_sum\": (r.get(\"std_hours_sum\") or 0),\r\n            \"total_hours_sum\": (r.get(\"total_hours_sum\") or 0),\r\n        }\r\n        for r in rows\r\n    }\r\n\r\n\r\n# ============================================================\r\n# OUTPUT\r\n# ============================================================\r\nout = []\r\nfor e in employees:\r\n    skill_level = e.get(\"skill_level\")\r\n    op_level = e.get(\"operation_level\")\r\n\r\n    skill_rate = skill_rate_map.get(skill_level, 0)\r\n    op_rate = op_rate_map.get(op_level, 0)\r\n\r\n    emp_id = e.get(\"employee\")\r\n    dwh = dwh_map.get(emp_id, {\"std_hours_sum\": 0, \"total_hours_sum\": 0})\r\n\r\n    out.append({\r\n        \"employee\": e[\"name\"],\r\n        \"designation\": e.get(\"designation\"),\r\n        \"skill_level\": skill_level,\r\n        \"operation_level\": op_level,\r\n        \"skill_rate\": skill_rate,\r\n        \"operation_rate\": op_rate,\r\n\r\n        # keys client uses\r\n        \"standard_working_hours_total\": dwh[\"std_hours_sum\"],\r\n        \"actual_working_hours_total\": dwh[\"total_hours_sum\"],\r\n    })\r\n\r\nfrappe.response.message = {\r\n    \"quality_ratio_exists\": 1 if qr_name else 0,\r\n    \"quality_ratio_name\": qr_name,\r\n    \"rows\": out\r\n}\r\n\r\n",
  "script_type": "API"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "After Save",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2025-12-23 14:11:55.944418",
  "module": null,
  "name": "Generate Sewing Line Incentive Docs for All Employees in Pcs Based",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "Pcs Based Incentive",
  "script": "# -------------------------------------------------------------------\r\n# CONFIG\r\n# -------------------------------------------------------------------\r\nSLI_DOCTYPE = \"Sewing Line Incentive\"\r\nSLI_CHILD_TABLE = \"sewing_line_incentive_item\"\r\n\r\nSLI_ITEM_PRODUCT_FIELD = \"product_code\"\r\nSLI_ITEM_MONTHLY_OUTPUT_FIELD = \"monthly_output\"\r\nSLI_ITEM_AVG_OUTPUT_FIELD = \"avg_output_per_day_for_product\"\r\nSLI_ITEM_KPI_FIELD = \"kpi\"\r\nSLI_ITEM_LINE_INCENTIVE_FIELD = \"line_incentive\"\r\n\r\nallowed_designations = [\"Sewing Operator\", \"Sewing Supporter\"]\r\n\r\nEMP_SKILL_LEVEL_FIELD = \"custom_skill_level\"\r\nEMP_OPERATION_LEVEL_FIELD = \"custom_operation_level\"\r\n\r\nSKILL_LEVEL_DOCTYPE = \"Skill Level\"\r\nSKILL_RATE_FIELD = \"skill_rate\"\r\n\r\nOP_LEVEL_DOCTYPE = \"Operation Level\"\r\nOP_RATE_FIELD = \"operation_rate\"\r\n\r\nQR_DOCTYPE = \"Quality Ratio For Sewing Line\"\r\nQR_LINE_FIELD = \"line\"\r\nQR_FROM_FIELD = \"from_date\"\r\nQR_TO_FIELD = \"to_date\"\r\nQR_VALUE_FIELD = \"quality_ratio\"\r\n# -------------------------------------------------------------------\r\n\r\nline = doc.get(\"line\")\r\nfrom_date = doc.get(\"from_date\")\r\nto_date = doc.get(\"to_date\")\r\nline_type = doc.get(\"line_type\")\r\n\r\nfrappe.msgprint(f\"[DEBUG] Line={line}, From={from_date}, To={to_date}, Line Type={line_type}\")\r\n\r\nif line and from_date and to_date and (not line_type or line_type == \"Sewing\"):\r\n\r\n    # ------------------------------------------------------------\r\n    # A) Check SLI FIRST (before computing anything)\r\n    # ------------------------------------------------------------\r\n    sli_name = frappe.db.exists(\r\n        SLI_DOCTYPE,\r\n        {\"line\": line, \"from_date\": from_date, \"to_date\": to_date}\r\n    )\r\n\r\n    sli_exists = bool(sli_name)\r\n\r\n    if sli_exists:\r\n        # Just link/use existing doc, no computation, no overwrite\r\n        sli = frappe.get_doc(SLI_DOCTYPE, sli_name)\r\n        frappe.msgprint(f\"[INFO] SLI already exists. Using existing SLI: {sli_name}\")\r\n\r\n    else:\r\n        # ------------------------------------------------------------\r\n        # 0) Quality Ratio\r\n        # ------------------------------------------------------------\r\n        qr_name = frappe.db.exists(\r\n            QR_DOCTYPE,\r\n            {\r\n                QR_LINE_FIELD: line,\r\n                QR_FROM_FIELD: from_date,\r\n                QR_TO_FIELD: to_date,\r\n            }\r\n        )\r\n\r\n        frappe.msgprint(f\"[DEBUG] Quality Ratio doc = {qr_name}\")\r\n\r\n        if not qr_name:\r\n            frappe.msgprint(\r\n                f\"[ERROR] Quality Ratio missing for Line={line}, From={from_date}, To={to_date}\"\r\n            )\r\n\r\n        else:\r\n            quality_ratio = float(\r\n                frappe.db.get_value(QR_DOCTYPE, qr_name, QR_VALUE_FIELD) or 0\r\n            )\r\n            frappe.msgprint(f\"[DEBUG] Quality Ratio = {quality_ratio}\")\r\n\r\n            # ------------------------------------------------------------\r\n            # 1) Compute LINE RATE\r\n            # ------------------------------------------------------------\r\n            employees_for_rate = frappe.get_all(\r\n                \"Employee\",\r\n                filters={\r\n                    \"department\": line,\r\n                    \"status\": \"Active\",\r\n                    \"designation\": [\"in\", allowed_designations],\r\n                },\r\n                fields=[EMP_SKILL_LEVEL_FIELD, EMP_OPERATION_LEVEL_FIELD],\r\n            )\r\n\r\n            frappe.msgprint(f\"[DEBUG] Employees for line rate = {len(employees_for_rate)}\")\r\n\r\n            skill_levels = []\r\n            op_levels = []\r\n\r\n            for e in employees_for_rate:\r\n                if e.get(EMP_SKILL_LEVEL_FIELD):\r\n                    skill_levels.append(e.get(EMP_SKILL_LEVEL_FIELD))\r\n                if e.get(EMP_OPERATION_LEVEL_FIELD):\r\n                    op_levels.append(e.get(EMP_OPERATION_LEVEL_FIELD))\r\n\r\n            skill_levels = list(set(skill_levels))\r\n            op_levels = list(set(op_levels))\r\n\r\n            frappe.msgprint(f\"[DEBUG] Skill Levels = {skill_levels}\")\r\n            frappe.msgprint(f\"[DEBUG] Operation Levels = {op_levels}\")\r\n\r\n            skill_rate_map = {}\r\n            if skill_levels:\r\n                rows = frappe.get_all(\r\n                    SKILL_LEVEL_DOCTYPE,\r\n                    filters={\"name\": [\"in\", skill_levels]},\r\n                    fields=[\"name\", SKILL_RATE_FIELD],\r\n                )\r\n                for r in rows:\r\n                    skill_rate_map[r[\"name\"]] = float(r.get(SKILL_RATE_FIELD) or 0)\r\n\r\n            op_rate_map = {}\r\n            if op_levels:\r\n                rows = frappe.get_all(\r\n                    OP_LEVEL_DOCTYPE,\r\n                    filters={\"name\": [\"in\", op_levels]},\r\n                    fields=[\"name\", OP_RATE_FIELD],\r\n                )\r\n                for r in rows:\r\n                    op_rate_map[r[\"name\"]] = float(r.get(OP_RATE_FIELD) or 0)\r\n\r\n            frappe.msgprint(f\"[DEBUG] Skill Rate Map = {skill_rate_map}\")\r\n            frappe.msgprint(f\"[DEBUG] Operation Rate Map = {op_rate_map}\")\r\n\r\n            line_rate = 0.0\r\n            for e in employees_for_rate:\r\n                skill_rate = skill_rate_map.get(e.get(EMP_SKILL_LEVEL_FIELD), 0)\r\n                op_rate = op_rate_map.get(e.get(EMP_OPERATION_LEVEL_FIELD), 0)\r\n                line_rate += skill_rate * op_rate\r\n\r\n            line_rate = round(line_rate, 2)\r\n            frappe.msgprint(f\"[DEBUG] Line Rate = {line_rate}\")\r\n\r\n            # ------------------------------------------------------------\r\n            # 2) Create new SLI (since it doesn't exist)\r\n            # ------------------------------------------------------------\r\n            sli = frappe.new_doc(SLI_DOCTYPE)\r\n            sli.line = line\r\n            sli.from_date = from_date\r\n            sli.to_date = to_date\r\n            sli.line_rate = line_rate\r\n\r\n            # ------------------------------------------------------------\r\n            # 3) LINE monthly output per product + WORKING DAYS\r\n            # ------------------------------------------------------------\r\n            data = frappe.db.sql(\"\"\"\r\n                SELECT\r\n                    c.product_code,\r\n                    SUM(c.quantity) AS total_quantity,\r\n                    COUNT(DISTINCT p.date) AS working_days\r\n                FROM `tabPcs Produced Per Day Per Employee` p\r\n                JOIN `tabProduct Produced By Employee` c\r\n                    ON c.parent = p.name\r\n                WHERE p.line = %s\r\n                  AND p.date BETWEEN %s AND %s\r\n                GROUP BY c.product_code\r\n                ORDER BY c.product_code\r\n            \"\"\", (line, from_date, to_date), as_dict=True)\r\n\r\n            frappe.msgprint(f\"[DEBUG] Production rows = {len(data)}\")\r\n\r\n            if not data:\r\n                frappe.msgprint(\"[ERROR] No production data found\")\r\n\r\n            else:\r\n                working_days = max(int(d.get(\"working_days\") or 0) for d in data)\r\n                if working_days <= 0:\r\n                    working_days = 1\r\n\r\n                frappe.msgprint(f\"[DEBUG] Working days (production based) = {working_days}\")\r\n\r\n                product_codes = [d[\"product_code\"] for d in data if d.get(\"product_code\")]\r\n\r\n                # ------------------------------------------------------------\r\n                # 4) KPI Cutoffs\r\n                # ------------------------------------------------------------\r\n                cutoff_map = {}\r\n                if product_codes:\r\n                    placeholders = \", \".join([\"%s\"] * len(product_codes))\r\n                    cutoffs = frappe.db.sql(f\"\"\"\r\n                        SELECT\r\n                            parent AS product_code,\r\n                            kpi_cutoff_upper_limit,\r\n                            kpi\r\n                        FROM `tabProduct Code KPI Cut Off`\r\n                        WHERE parenttype = 'Product Code'\r\n                          AND parent IN ({placeholders})\r\n                        ORDER BY parent, kpi_cutoff_upper_limit\r\n                    \"\"\", tuple(product_codes), as_dict=True)\r\n\r\n                    for r in cutoffs:\r\n                        cutoff_map.setdefault(r[\"product_code\"], []).append(\r\n                            (r[\"kpi_cutoff_upper_limit\"], r[\"kpi\"])\r\n                        )\r\n\r\n                # ------------------------------------------------------------\r\n                # 5) UI + SMV\r\n                # ------------------------------------------------------------\r\n                product_meta_map = {}\r\n                products = frappe.get_all(\r\n                    \"Product Code\",\r\n                    filters={\"name\": [\"in\", product_codes]},\r\n                    fields=[\"name\", \"ui\", \"smv\"]\r\n                )\r\n\r\n                for p in products:\r\n                    product_meta_map[p[\"name\"]] = {\r\n                        \"ui\": float(p.get(\"ui\") or 0),\r\n                        \"smv\": float(p.get(\"smv\") or 0),\r\n                    }\r\n\r\n                # ------------------------------------------------------------\r\n                # 6) Incentive calculation\r\n                # ------------------------------------------------------------\r\n                total_line_incentive = 0.0\r\n\r\n                for d in data:\r\n                    product_code = d[\"product_code\"]\r\n                    monthly_output = float(d[\"total_quantity\"] or 0)\r\n\r\n                    avg_per_day = round(monthly_output / float(working_days), 2)\r\n\r\n                    selected_kpi = 0\r\n                    for upper, kpi in cutoff_map.get(product_code, []):\r\n                        if avg_per_day >= float(upper or 0):\r\n                            selected_kpi = float(kpi)\r\n\r\n                    meta = product_meta_map.get(product_code, {})\r\n                    ui = meta.get(\"ui\", 0)\r\n                    smv = meta.get(\"smv\", 0)\r\n\r\n                    line_incentive = round(\r\n                        ui * quality_ratio * selected_kpi * ((monthly_output * smv) / 60.0),\r\n                        2\r\n                    )\r\n\r\n                    total_line_incentive += line_incentive\r\n\r\n                    sli.append(SLI_CHILD_TABLE, {\r\n                        SLI_ITEM_PRODUCT_FIELD: product_code,\r\n                        SLI_ITEM_MONTHLY_OUTPUT_FIELD: monthly_output,\r\n                        SLI_ITEM_AVG_OUTPUT_FIELD: avg_per_day,\r\n                        SLI_ITEM_KPI_FIELD: selected_kpi,\r\n                        SLI_ITEM_LINE_INCENTIVE_FIELD: line_incentive,\r\n                    })\r\n\r\n                sli.total_line_incentive = round(total_line_incentive, 2)\r\n                frappe.msgprint(f\"[DEBUG] Total Line Incentive = {sli.total_line_incentive}\")\r\n\r\n                sli.insert(ignore_permissions=True)\r\n                frappe.msgprint(f\"[INFO] Created new SLI: {sli.name}\")\r\n\r\n",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": "generate_sewing_line_incentive_links",
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Insert",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2025-12-19 21:17:41.926021",
  "module": null,
  "name": "Generate Sewing Line Incentive Links",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": null,
  "script": "PBI_DOCTYPE = \"Pcs Based Incentive\"\r\nSLI_DOCTYPE = \"Sewing Line Incentive\"\r\n\r\nCHILD_TABLE_FIELD = \"pcs_based_employee_incentive_table\"\r\n\r\n# Parent field on PBI\r\nPBI_SLI_LINK_FIELD = \"sewing_line_incentive\"\r\n\r\n# ---- Row fieldnames ----\r\nROW_EMP_FIELD = \"employee\"\r\nROW_DESIGNATION_FIELD = \"designation\"\r\nROW_SKILL_RATE_FIELD = \"skill_rate\"\r\nROW_OPERATION_RATE_FIELD = \"operation_rate\"\r\nROW_STD_HRS_FIELD = \"standard_working_hours_total\"\r\nROW_ACT_HRS_FIELD = \"actual_working_hours_total\"\r\nROW_INCENTIVE_FIELD = \"incentive_amount\"\r\n# ------------------------\r\n\r\nSEWING_WORKER_DESIGNATIONS = [\"Sewing Operator\", \"Sewing Supporter\"]\r\nLEADER_DESIGNATIONS = [\"Line Leader\", \"Sub Line Leader\"]\r\nLEADER_PERCENTAGE = 0.01  # 1%\r\n\r\ndocname = frappe.form_dict.get(\"docname\")\r\npbi = frappe.get_doc(PBI_DOCTYPE, docname)\r\n\r\nupdated_workers = 0\r\nupdated_leaders = 0\r\nskipped = 0\r\n\r\n# ------------------------------------------------------------\r\n# Only proceed for Sewing\r\n# ------------------------------------------------------------\r\nif pbi.get(\"line_type\") == \"Sewing\":\r\n\r\n    line = pbi.get(\"line\")\r\n    from_date = pbi.get(\"from_date\")\r\n    to_date = pbi.get(\"to_date\")\r\n\r\n    if not (line and from_date and to_date):\r\n        frappe.throw(\"Line, From Date and To Date are required.\")\r\n\r\n    # ------------------------------------------------------------\r\n    # 1) Fetch SINGLE Sewing Line Incentive\r\n    # ------------------------------------------------------------\r\n    sli_name = frappe.db.get_value(\r\n        SLI_DOCTYPE,\r\n        {\r\n            \"line\": line,\r\n            \"from_date\": from_date,\r\n            \"to_date\": to_date,\r\n        },\r\n        \"name\"\r\n    )\r\n\r\n    if not sli_name:\r\n        frappe.throw(\r\n            f\"Sewing Line Incentive not found for Line={line}, \"\r\n            f\"From={from_date}, To={to_date}\"\r\n        )\r\n\r\n    # Fetch needed parent values\r\n    sli_vals = frappe.db.get_value(\r\n        SLI_DOCTYPE,\r\n        sli_name,\r\n        [\"line_rate\", \"total_line_incentive\"],\r\n        as_dict=True\r\n    ) or {}\r\n\r\n    line_rate = float(sli_vals.get(\"line_rate\") or 0)\r\n    total_line_incentive = float(sli_vals.get(\"total_line_incentive\") or 0)\r\n\r\n    if line_rate <= 0:\r\n        frappe.throw(\"Line Rate is zero. Cannot calculate incentives.\")\r\n\r\n    # ------------------------------------------------------------\r\n    # 2) Link SLI to PBI (parent-level)\r\n    # ------------------------------------------------------------\r\n    pbi.set(PBI_SLI_LINK_FIELD, sli_name)\r\n\r\n    # ------------------------------------------------------------\r\n    # 3) LEADER INCENTIVE CALCULATION (KPI ‚â• 1)\r\n    # ------------------------------------------------------------\r\n    leader_base_amount = 0.0\r\n\r\n    sli_items = frappe.get_all(\r\n        \"Sewing Line Incentive Item\",\r\n        filters={\"parent\": sli_name, \"parenttype\": SLI_DOCTYPE},\r\n        fields=[\"kpi\", \"line_incentive\"]\r\n    )\r\n\r\n    for item in sli_items:\r\n        kpi = float(item.get(\"kpi\") or 0)\r\n        if kpi >= 1:\r\n            leader_base_amount += float(item.get(\"line_incentive\") or 0)\r\n\r\n    leader_incentive_amount = round(leader_base_amount * LEADER_PERCENTAGE, 2)\r\n\r\n    # ------------------------------------------------------------\r\n    # 4) Iterate PBI rows and apply incentives\r\n    # ------------------------------------------------------------\r\n    for r in pbi.get(CHILD_TABLE_FIELD) or []:\r\n\r\n        designation = r.get(ROW_DESIGNATION_FIELD)\r\n\r\n        # -------------------------------\r\n        # Sewing Operators & Supporters\r\n        # -------------------------------\r\n        if designation in SEWING_WORKER_DESIGNATIONS:\r\n\r\n            skill_rate = float(r.get(ROW_SKILL_RATE_FIELD) or 0)\r\n            operation_rate = float(r.get(ROW_OPERATION_RATE_FIELD) or 0)\r\n            std_hours = float(r.get(ROW_STD_HRS_FIELD) or 0)\r\n            act_hours = float(r.get(ROW_ACT_HRS_FIELD) or 0)\r\n\r\n            if std_hours <= 0 or act_hours <= 0:\r\n                skipped += 1\r\n                continue\r\n\r\n            incentive_amount = (\r\n                ((skill_rate * operation_rate) / line_rate)\r\n                * (total_line_incentive / std_hours)\r\n                * act_hours\r\n            )\r\n\r\n            r.set(ROW_INCENTIVE_FIELD, round(incentive_amount, 2))\r\n            updated_workers += 1\r\n\r\n        # -------------------------------\r\n        # Line Leader / Sub Line Leader\r\n        # -------------------------------\r\n        elif designation in LEADER_DESIGNATIONS:\r\n            r.set(ROW_INCENTIVE_FIELD, leader_incentive_amount)\r\n            updated_leaders += 1\r\n\r\n    # ------------------------------------------------------------\r\n    # 5) Save once\r\n    # ------------------------------------------------------------\r\n    pbi.save(ignore_permissions=True)\r\n\r\n    frappe.msgprint(\r\n        \"<b>Sewing Incentive Calculation Complete</b><br>\"\r\n        f\"Linked Sewing Line Incentive: {sli_name}<br>\"\r\n        f\"Updated Workers: {updated_workers}<br>\"\r\n        f\"Updated Leaders: {updated_leaders}<br>\"\r\n        f\"Skipped Rows: {skipped}<br>\"\r\n        f\"Leader Base (KPI ‚â• 1): {round(leader_base_amount, 2)}<br>\"\r\n        f\"Leader Incentive (1%): {leader_incentive_amount}\"\r\n    )\r\n\r\nelse:\r\n    frappe.msgprint(\"Line Type is not Sewing. Action skipped.\")\r\n",
  "script_type": "API"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 1,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Submit",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2025-12-19 10:26:26.322178",
  "module": null,
  "name": "BOM_Operation",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "BOM",
  "script": "# Block ONLY auto-submit from BOM Creator\n# Allow manual submit from UI\n\nimport frappe\n\nbom = frappe.get_doc(\"BOM\", doc.name)\n\n# Only block auto-submit if BOM comes from BOM Creator\nif bom.bom_creator:\n\n    # If NOT submitted via UI (meaning auto-submit)\n    if not frappe.flags.in_controller and not bom.flags.in_ui:\n\n        # Force revert to Draft\n        bom.db_set(\"docstatus\", 0)\n        bom.docstatus = 0\n\n        frappe.throw(\n            \"Auto-submit from BOM Creator is blocked. \"\n            \"BOM has been set to Draft. Please review and submit manually.\"\n        )\n\n# If submit comes from UI ‚Üí allow normally\n",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "After Submit",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2026-01-05 13:32:53.594184",
  "module": null,
  "name": "Create Additional Salary after Approved Employee Overtime",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "Employee Overtime",
  "script": "# ---------------------------------------------------------\r\n# Create Additional Salary on Approval (NO return statements)\r\n# ---------------------------------------------------------\r\n\r\nworkflow_state = (doc.get(\"workflow_state\") or \"\").strip()\r\n\r\nif workflow_state == \"Approved\":\r\n\r\n    SALARY_COMPONENT = \"Overtime\"\r\n\r\n    # Source doctype fields\r\n    EMPLOYEE_FIELD = \"employee_id\"      # Employee Overtime fieldname\r\n    AMOUNT_FIELD = \"overtime_amount\"    # amount field\r\n    DATE_FIELD = \"date\"                 # maps to Additional Salary.payroll_date\r\n\r\n    employee = doc.get(EMPLOYEE_FIELD)\r\n    amount = doc.get(AMOUNT_FIELD) or 0\r\n    payroll_date = doc.get(DATE_FIELD)\r\n\r\n    if not employee:\r\n        frappe.throw(f\"'{EMPLOYEE_FIELD}' is required to create Additional Salary.\")\r\n\r\n    if not payroll_date:\r\n        frappe.throw(f\"'{DATE_FIELD}' is required to create Additional Salary.\")\r\n\r\n    # Normalize (safe even if already a date)\r\n    payroll_date = frappe.utils.getdate(payroll_date)\r\n\r\n    # Fetch company from Employee\r\n    emp_company = frappe.db.get_value(\"Employee\", employee, \"company\")\r\n    if not emp_company:\r\n        frappe.throw(f\"Company not found for Employee '{employee}'.\")\r\n\r\n    # Only proceed if amount > 0\r\n    if amount > 0:\r\n\r\n        # Duplicate prevention\r\n        existing = frappe.db.exists(\"Additional Salary\", {\r\n            \"employee\": employee,\r\n            \"company\": emp_company,\r\n            \"salary_component\": SALARY_COMPONENT,\r\n            \"payroll_date\": payroll_date\r\n        })\r\n\r\n        if not existing:\r\n            add_sal = frappe.new_doc(\"Additional Salary\")\r\n            add_sal.employee = employee\r\n            add_sal.company = emp_company\r\n            add_sal.salary_component = SALARY_COMPONENT\r\n            add_sal.amount = amount\r\n            add_sal.payroll_date = payroll_date\r\n\r\n            add_sal.insert(ignore_permissions=True)\r\n            add_sal.submit()\r\n\r\n            frappe.msgprint(\r\n                f\"Additional Salary <b>{add_sal.name}</b> created for Employee <b>{employee}</b> (Payroll Date: <b>{payroll_date}</b>).\",\r\n                indicator=\"green\"\r\n            )\r\n",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Insert",
  "enable_rate_limit": 0,
  "event_frequency": "Daily",
  "modified": "2026-01-22 12:12:23.057547",
  "module": null,
  "name": "Sync CheckIn Employee",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": null,
  "script": "auth_endpoint = 'http://14.241.121.152:8080/jwt-api-token-auth/'\r\ntransaction_endpoint = 'http://14.241.121.152:8080/iclock/api/transactions/'\r\nusername = 'ballerheadwear'\r\npassword = '2023/B@ller'\r\nheaders = {\r\n    \"Content-Type\": \"application/json\"\r\n}\r\n\r\ndef login_get_token():\r\n    authParams = {\r\n        'username': username,\r\n        'password': password\r\n    }\r\n    try:\r\n     response = frappe.make_post_request(url=auth_endpoint, json=authParams, headers=headers)\r\n     return response['token']\r\n    except:\r\n        frappe.log_error(\"JWT Login Error\")\r\n        \r\ndef get_transactions(jwt_token, params):\r\n    try:\r\n        headers = {\r\n            \"Content-Type\": \"application/json\",\r\n            \"Authorization\": \"JWT \" + jwt_token\r\n        }\r\n        response = frappe.make_get_request(url=transaction_endpoint, params=params, headers=headers)\r\n        return response['data']\r\n    except:\r\n        frappe.log_error(\"Error\")\r\n        \r\ndef get_devices(jwt_token):\r\n    url = 'http://14.241.121.152:8080/iclock/api/terminals/'\r\n    headers = {\r\n        \"Content-Type\": \"application/json\",\r\n        \"Authorization\": \"JWT \" + jwt_token\r\n    }\r\n    params = {\r\n        \"state\" : 1\r\n    }\r\n    response = frappe.make_get_request(url=url, params=params, headers=headers)\r\n    if response['data']:\r\n        return response['data']\r\n    else:\r\n        return []\r\n\r\ndef create_employee_checkin(employee_code, employee_name, time, log_type, device_id=None):\r\n    try:\r\n        doc = frappe.db.sql(\r\n            \"\"\"\r\n            SELECT name\r\n            FROM `tabEmployee Checkin`\r\n            WHERE employee = %s\r\n              AND log_type = %s\r\n              AND DATE(time) = DATE(%s)\r\n            LIMIT 1\r\n            \"\"\",\r\n            (employee_code, log_type, time),\r\n            as_dict=True\r\n        )\r\n    \r\n        if doc:\r\n            frappe.db.set_value(\r\n                \"Employee Checkin\",\r\n                doc[0].name,\r\n                {\r\n                    \"time\": time,\r\n                    \"device_id\": device_id,\r\n                    \"employee_name\": employee_name,\r\n                    \"offshift\": 0,\r\n                    \"skip_auto_attendance\": 1\r\n                }\r\n            )\r\n        else:\r\n            doc = frappe.get_doc({\r\n                \"doctype\": \"Employee Checkin\",\r\n                \"employee\": employee_code,\r\n                \"employee_name\": employee_name,\r\n                \"time\": time,\r\n                \"log_type\": log_type,\r\n                \"device_id\": device_id,\r\n                \"offshift\": 0,\r\n                \"skip_auto_attendance\": 1\r\n            })\r\n            doc.insert(ignore_permissions=True)\r\n    except Exception as e:\r\n        frappe.log_error(str(e), \"Create Employee Checkin Error\")\r\n        return None\r\n\r\ndef run():\r\n    jwt_token = login_get_token()\r\n    end_date = frappe.utils.getdate(frappe.utils.today())\r\n    start_date = frappe.utils.add_to_date(end_date, days=-3)\r\n    # end_date = '2025-12-27'\r\n    # start_date = '2025-12-26'\r\n    current_date = start_date\r\n    while current_date <= end_date:\r\n        process_date = current_date\r\n        process_date_previous_shift = frappe.utils.add_to_date(current_date, days=-2)\r\n        current_date = frappe.utils.add_to_date(current_date, days=1)\r\n        params_shift = {\r\n            \"start_time\": f\"{process_date} 05:30\",\r\n            \"end_time\": f\"{process_date} 21:00\",\r\n            \"page_size\": 2000\r\n        }\r\n        params_previous_shift = {\r\n            \"start_time\":  f\"{process_date_previous_shift} 21:30\",\r\n            \"end_time\": f\"{process_date_previous_shift} 23:59\",\r\n            \"page_size\": 2000\r\n        }\r\n\r\n        transations_previous_shift = get_transactions(jwt_token, params_previous_shift)\r\n        transations = get_transactions(jwt_token, params_shift)\r\n        employees = frappe.db.get_all(\r\n            \"Employee\",\r\n            filters={\"status\": \"Active\"},\r\n            fields=[\"name\", \"employee_name\", \"attendance_device_id\"]\r\n        )\r\n        for transaction in transations:\r\n            emp_code = transaction['emp_code'] or ''\r\n            if not emp_code:\r\n                continue\r\n            \r\n            current_employee = None\r\n            for employee in employees:\r\n                if employee.get('attendance_device_id') == emp_code:\r\n                    current_employee = employee\r\n                    break\r\n\r\n            if not current_employee:\r\n                continue\r\n            \r\n            employee_name = current_employee['employee_name'] or ''\r\n            employee_code = current_employee['name'] or ''\r\n            attendance_device_id = current_employee['attendance_device_id'] or ''\r\n            record = None\r\n            for row in transations_previous_shift:\r\n                if row.get(\"emp_code\") == attendance_device_id:\r\n                    record = row\r\n                    create_employee_checkin(employee_code, employee_name, record['punch_time'], 'IN', device_id=None)\r\n                    transations_previous_shift.remove(row)\r\n                    break\r\n\r\n            if record:\r\n                create_employee_checkin(employee_code, employee_name, transaction['punch_time'], 'OUT', device_id=None)\r\n                transations.remove(transaction)\r\n                continue\r\n\r\n            records = sorted(\r\n                [row for row in transations if row.get(\"emp_code\") == emp_code],\r\n                key=lambda x: x.get(\"punch_time\")\r\n            )\r\n            if not records:\r\n                continue\r\n\r\n            if len(records) > 1:\r\n                start_transaction = records[0]\r\n                end_transaction = records[-1]\r\n                create_employee_checkin(employee_code, employee_name, start_transaction['punch_time'], 'IN', device_id=None)\r\n                create_employee_checkin(employee_code, employee_name, end_transaction['punch_time'], 'OUT', device_id=None)\r\n            else:\r\n                create_employee_checkin(employee_code, employee_name, transaction['punch_time'], 'IN', device_id=None)\r\nrun()\r\n\r\n",
  "script_type": "Scheduler Event"
 },
 {
  "allow_guest": 0,
  "api_method": "get_job_card_selected",
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Insert",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2026-01-05 10:27:12.067968",
  "module": null,
  "name": "Get Job Card When Select",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": null,
  "script": "job_cards = frappe.form_dict.get(\"job_cards\")\r\nworkstation = frappe.form_dict.get(\"workstation\")\r\n\r\nif isinstance(job_cards, str):\r\n    job_cards = json.loads(job_cards)\r\n\r\nconditions = []\r\nparams = []\r\n\r\nif job_cards:\r\n    placeholders = \", \".join([\"%s\"] * len(job_cards))\r\n    conditions.append(f\"name IN ({placeholders})\")\r\n    params.extend(job_cards)\r\n\r\nif workstation:\r\n    conditions.append(\"workstation = %s\")\r\n    params.append(workstation)\r\n\r\nwhere_clause = \" AND \".join(conditions) if conditions else \"1=1\"\r\n\r\nquery = f\"\"\"\r\n    SELECT name, production_item, status, for_quantity, workstation, total_completed_qty\r\n    FROM `tabJob Card`\r\n    WHERE {where_clause}\r\n    ORDER BY status DESC\r\n\"\"\"\r\n\r\nresults = frappe.db.sql(query, params, as_dict=True)\r\nfrappe.response[\"message\"] = results\r\n",
  "script_type": "API"
 },
 {
  "allow_guest": 0,
  "api_method": "update_completed_qty",
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Insert",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2026-01-12 09:34:01.755180",
  "module": null,
  "name": "Update Completed Quantity",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": null,
  "script": "completed_items = frappe.form_dict.get(\"completed_items\")\r\nparent_doctype_name = frappe.form_dict.get(\"parent_doctype_name\")\r\nworkstation_name = parent_doctype_name\r\ntoday_start = frappe.utils.get_datetime(frappe.utils.nowdate() + \" 7:30\")\r\ntoday_end = frappe.utils.get_datetime(frappe.utils.nowdate() + \" 23:59:59\")\r\nemployee = frappe.form_dict.get('employee')\r\nuser_id = frappe.form_dict.get('user')\r\n\r\nif completed_items:\r\n    completed_items = json.loads(completed_items)\r\n    \r\njob_card_tuple = tuple(item[\"job_card\"] for item in completed_items)\r\n\r\ndef handle_employee(parent_doctype_name):\r\n    employees = frappe.db.sql(\"\"\"\r\n        SELECT employee\r\n        FROM `tabWorkstation Employees`\r\n        WHERE parent = %s\r\n        AND employee IS NOT NULL\r\n    \"\"\", (parent_doctype_name), as_dict=True)\r\n\r\n    if not employees:\r\n        return []\r\n\r\n    employee_list = [e[\"employee\"] for e in employees]\r\n    \r\n    placeholders = \", \".join([\"%s\"] * len(employee_list))\r\n \r\n    params = tuple(employee_list) + (today_start, today_end)\r\n    checkins = frappe.db.sql(f\"\"\"\r\n        SELECT employee, shift_start, shift_end\r\n        FROM `tabEmployee Checkin`\r\n        WHERE employee IN ({placeholders})\r\n        AND shift_start BETWEEN %s AND %s\r\n    \"\"\", params, as_dict=True)\r\n\r\n    return checkins\r\n\r\n\r\nif completed_items:\r\n    employee_shift_data = handle_employee(parent_doctype_name)\r\n    total_hours = 0\r\n    for item in employee_shift_data:\r\n        if not item['shift_end']:\r\n            time_end = frappe.utils.now_datetime()\r\n            diff = frappe.utils.time_diff_in_hours(frappe.utils.get_datetime(time_end), frappe.utils.get_datetime(item['shift_start']))\r\n            total_hours = total_hours + diff\r\n        \r\n    placeholders_jobs = \", \".join([\"%s\"] * len(job_card_tuple))\r\n    new_params = job_card_tuple + (workstation_name,)\r\n    total_completed = frappe.db.sql(f\"\"\"\r\n        SELECT SUM(total_completed_qty) AS total\r\n        FROM `tabJob Card`\r\n        WHERE name IN ({placeholders_jobs})\r\n        AND workstation = %s\r\n    \"\"\", new_params, as_dict=True)\r\n    \r\n    total = total_completed[0].total if total_completed and total_completed[0].total else 0\r\n\r\n    for item in completed_items:\r\n        job_card = item[\"job_card\"]\r\n        if not item.get('completed_qty') and not item.get('is_done'):\r\n            continue\r\n        \r\n        doc = frappe.get_doc(\"Job Card\", job_card)\r\n        if doc.status == 'open':\r\n            continue\r\n        \r\n        if not doc.is_corrective_job_card and doc.items and doc.transferred_qty < doc.for_quantity:\r\n            frappe.throw(\r\n                f\"Materials need to be transferred to the work in progress warehouse for the job card {doc.name}\"\r\n            )\r\n\t\t\t\r\n        if item[\"completed_qty\"] > doc.for_quantity:\r\n            frappe.throw(\r\n                f\"The Total Completed Qty ({item['completed_qty']}) must be equal to Qty to Manufacture ({doc.for_quantity})\"\r\n            )\r\n\r\n        completed_qty = item[\"completed_qty\"] + doc.total_completed_qty\r\n\r\n        # Save completed qty\r\n        frappe.db.set_value(\"Job Card\", job_card, \"total_completed_qty\", completed_qty, update_modified=True)\r\n\r\n        # Update status + actual_end_date\r\n        if completed_qty >= doc.for_quantity:\r\n            frappe.db.set_value(\"Job Card\", job_card, \"status\", \"Completed\", update_modified=True)\r\n            frappe.db.set_value(\"Job Card\", job_card, \"actual_end_date\", frappe.utils.now(), update_modified=True)\r\n        else:\r\n            frappe.db.set_value(\"Job Card\", job_card, \"status\", \"Work In Progress\", update_modified=True)\r\n\r\n        if item['is_done']:\r\n            print('item ', item['is_done'])\r\n            frappe.db.set_value(\"Job Card\", job_card, \"status\", 'Completed', update_modified=True)\r\n\r\n        process_loss_qty = doc.for_quantity - completed_qty\r\n        if process_loss_qty < 0:\r\n            process_loss_qty = 0\r\n            \r\n        frappe.db.set_value(\"Job Card\", job_card, \"process_loss_qty\", process_loss_qty, update_modified=True)\r\n        employee = frappe.db.get_value(\r\n            \"Employee\",\r\n            {\"company_email\": user_id},\r\n            \"name\"\r\n        ) or ''\r\n            \r\n        time_log = frappe.get_doc({\r\n            \"doctype\": \"Job Card Time Log\",\r\n            \"parent\": job_card,\r\n            \"parenttype\": \"Job Card\",\r\n            \"parentfield\": \"time_logs\",\r\n            \"employee\": employee,\r\n            \"completed_qty\": item[\"completed_qty\"],\r\n            \"from_time\": frappe.utils.now(),\r\n            \"to_time\": frappe.utils.now(),\r\n        })\r\n        \r\n        time_log.insert()\r\n        frappe.db.commit()\r\n",
  "script_type": "API"
 },
 {
  "allow_guest": 0,
  "api_method": "generate_sli_incentives",
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Insert",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2025-12-23 15:14:30.621175",
  "module": null,
  "name": "Generate Sewing Line Incentive From Direct Monthly Output",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": null,
  "script": "frappe.msgprint(\"[DEBUG] API called\")\r\n\r\ndocname = frappe.form_dict.get(\"docname\")\r\ndoc = frappe.get_doc(\"Sewing Line Incentive\", docname)\r\n\r\nfrappe.msgprint(f\"[DEBUG] {doc}\")\r\n\r\n# ------------------------------------------------------------\r\n# Basic validations\r\n# ------------------------------------------------------------\r\nif not doc.line or not doc.from_date or not doc.to_date:\r\n    frappe.throw(\"Line, From Date and To Date are mandatory.\")\r\n\r\nworking_days = int(doc.get(\"working_days_in_month\") or 0)\r\nif working_days <= 0:\r\n    frappe.throw(\"Working Days in Month must be > 0.\")\r\n\r\nrows = doc.get(\"sewing_line_incentive_item\") or []\r\nif not rows:\r\n    frappe.throw(\"Please add at least one Product row.\")\r\n\r\n# ------------------------------------------------------------\r\n# Calculate Avg Output / Day\r\n# ------------------------------------------------------------\r\nproduct_codes = []\r\n\r\nidx = 1\r\nfor r in rows:\r\n    product_code = (r.get(\"product_code\") or \"\").strip()\r\n    monthly_output_raw = r.get(\"monthly_output\")\r\n\r\n    if not product_code:\r\n        frappe.throw(\"Row {0}: Product Code is required.\".format(idx))\r\n\r\n    if monthly_output_raw is None:\r\n        frappe.throw(\"Row {0}: Monthly Output is required.\".format(idx))\r\n\r\n    monthly_output = float(monthly_output_raw or 0)\r\n    if monthly_output < 0:\r\n        frappe.throw(\"Row {0}: Monthly Output cannot be negative.\".format(idx))\r\n\r\n    avg_per_day = round(monthly_output / float(working_days), 2)\r\n    r.set(\"avg_output_per_day_for_product\", avg_per_day)\r\n\r\n    product_codes.append(product_code)\r\n    idx = idx + 1\r\n\r\nproduct_codes = list(set(product_codes))\r\n\r\n# ------------------------------------------------------------\r\n# Fetch Quality Ratio\r\n# ------------------------------------------------------------\r\nqr_name = frappe.db.exists(\r\n    \"Quality Ratio For Sewing Line\",\r\n    {\"line\": doc.line, \"from_date\": doc.from_date, \"to_date\": doc.to_date}\r\n)\r\n\r\nif not qr_name:\r\n    frappe.throw(\"Quality Ratio not found for this Line and Period.\")\r\n\r\nquality_ratio = float(\r\n    frappe.db.get_value(\"Quality Ratio For Sewing Line\", qr_name, \"quality_ratio\") or 0\r\n)\r\n\r\nif quality_ratio <= 0:\r\n    frappe.throw(\"Quality Ratio must be > 0.\")\r\n\r\n# ------------------------------------------------------------\r\n# KPI Cutoffs (Upper Limit logic)\r\n# ------------------------------------------------------------\r\ncutoff_map = {}\r\n\r\nif product_codes:\r\n    placeholders = \", \".join([\"%s\"] * len(product_codes))\r\n    cutoffs = frappe.db.sql(f\"\"\"\r\n        SELECT\r\n            parent AS product_code,\r\n            kpi_cutoff_upper_limit,\r\n            kpi\r\n        FROM `tabProduct Code KPI Cut Off`\r\n        WHERE parenttype = 'Product Code'\r\n          AND parent IN ({placeholders})\r\n        ORDER BY parent, kpi_cutoff_upper_limit\r\n    \"\"\", tuple(product_codes), as_dict=True)\r\n\r\n    for rr in cutoffs:\r\n        pc = rr.get(\"product_code\")\r\n        if pc not in cutoff_map:\r\n            cutoff_map[pc] = []\r\n        cutoff_map[pc].append(\r\n            (float(rr.get(\"kpi_cutoff_upper_limit\") or 0),\r\n             float(rr.get(\"kpi\") or 0))\r\n        )\r\n\r\n# ------------------------------------------------------------\r\n# UI + SMV\r\n# ------------------------------------------------------------\r\nproduct_meta_map = {}\r\nproducts = frappe.get_all(\r\n    \"Product Code\",\r\n    filters={\"name\": [\"in\", product_codes]},\r\n    fields=[\"name\", \"ui\", \"smv\"],\r\n)\r\n\r\nfor p in products:\r\n    product_meta_map[p[\"name\"]] = {\r\n        \"ui\": float(p.get(\"ui\") or 0),\r\n        \"smv\": float(p.get(\"smv\") or 0),\r\n    }\r\n\r\n# ------------------------------------------------------------\r\n# Line Rate\r\n# ------------------------------------------------------------\r\nallowed_designations = [\"Sewing Operator\", \"Sewing Supporter\"]\r\n\r\nemployees = frappe.get_all(\r\n    \"Employee\",\r\n    filters={\r\n        \"department\": doc.line,\r\n        \"status\": \"Active\",\r\n        \"designation\": [\"in\", allowed_designations],\r\n    },\r\n    fields=[\"custom_skill_level\", \"custom_operation_level\"],\r\n)\r\n\r\nskill_levels = []\r\nop_levels = []\r\n\r\nfor e in employees:\r\n    if e.get(\"custom_skill_level\") and e.get(\"custom_skill_level\") not in skill_levels:\r\n        skill_levels.append(e.get(\"custom_skill_level\"))\r\n    if e.get(\"custom_operation_level\") and e.get(\"custom_operation_level\") not in op_levels:\r\n        op_levels.append(e.get(\"custom_operation_level\"))\r\n\r\nskill_rate_map = {}\r\nif skill_levels:\r\n    tmp = frappe.get_all(\r\n        \"Skill Level\",\r\n        filters={\"name\": [\"in\", skill_levels]},\r\n        fields=[\"name\", \"skill_rate\"],\r\n    )\r\n    for rr in tmp:\r\n        skill_rate_map[rr[\"name\"]] = float(rr.get(\"skill_rate\") or 0)\r\n\r\nop_rate_map = {}\r\nif op_levels:\r\n    tmp = frappe.get_all(\r\n        \"Operation Level\",\r\n        filters={\"name\": [\"in\", op_levels]},\r\n        fields=[\"name\", \"operation_rate\"],\r\n    )\r\n    for rr in tmp:\r\n        op_rate_map[rr[\"name\"]] = float(rr.get(\"operation_rate\") or 0)\r\n\r\nline_rate = 0.0\r\nfor e in employees:\r\n    line_rate += (\r\n        skill_rate_map.get(e.get(\"custom_skill_level\"), 0)\r\n        * op_rate_map.get(e.get(\"custom_operation_level\"), 0)\r\n    )\r\n\r\ndoc.line_rate = round(line_rate, 2)\r\n\r\n# ------------------------------------------------------------\r\n# Incentive Calculation\r\n# - KPI selected using \"Upper Limit\" logic:\r\n#   pick FIRST row where avg_per_day <= cutoff_upper_limit\r\n#   if avg_per_day > all, pick LAST KPI\r\n#   KPI can be 0 / 0.5 / 1 / ...\r\n# ------------------------------------------------------------\r\ntotal_line_incentive = 0.0\r\n\r\nfor r in rows:\r\n    product_code = (r.get(\"product_code\") or \"\").strip()\r\n    monthly_output = float(r.get(\"monthly_output\") or 0)\r\n    avg_per_day = float(r.get(\"avg_output_per_day_for_product\") or 0)\r\n\r\n    selected_kpi = None\r\n\r\n    cut_list = cutoff_map.get(product_code, [])\r\n    for upper, kpi in cut_list:\r\n        if avg_per_day <= upper:\r\n            selected_kpi = kpi\r\n            break\r\n\r\n    if selected_kpi is None:\r\n        if cut_list:\r\n            selected_kpi = cut_list[-1][1]\r\n        else:\r\n            selected_kpi = 0.0\r\n\r\n    r.set(\"kpi\", selected_kpi)\r\n\r\n    meta = product_meta_map.get(product_code, {})\r\n    ui = float(meta.get(\"ui\") or 0)\r\n    smv = float(meta.get(\"smv\") or 0)\r\n\r\n    if ui <= 0 or smv <= 0:\r\n        frappe.throw(\"UI / SMV missing for Product Code: {0}\".format(product_code))\r\n\r\n    line_incentive = round(\r\n        ui * quality_ratio * selected_kpi * ((monthly_output * smv) / 60.0),\r\n        2\r\n    )\r\n\r\n    r.set(\"line_incentive\", line_incentive)\r\n    total_line_incentive += line_incentive\r\n\r\ndoc.total_line_incentive = round(total_line_incentive, 2)\r\n\r\n# ------------------------------------------------------------\r\n# Save document\r\n# ------------------------------------------------------------\r\ndoc.save(ignore_permissions=True)\r\n\r\nfrappe.response[\"message\"] = (\r\n    \"SLI calculated and saved. \"\r\n    f\"Line Rate: {doc.line_rate}, \"\r\n    f\"Total Incentive: {doc.total_line_incentive}\"\r\n)\r\n\r\n",
  "script_type": "API"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "After Submit",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2026-01-07 16:31:16.303610",
  "module": null,
  "name": "Total Billed Of Sales Order",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "Sales Invoice",
  "script": "\ndef update_sales_order_billed_amount(sales_order):\n    if not sales_order:\n        return\n\n    total = frappe.db.sql(\"\"\"\n        SELECT SUM(sii.amount)\n        FROM `tabSales Invoice Item` sii\n        JOIN `tabSales Invoice` si ON si.name = sii.parent\n        WHERE\n            sii.sales_order = %s\n            AND si.docstatus = 1\n    \"\"\", sales_order)[0][0] or 0\n\n    frappe.db.set_value(\n        \"Sales Order\",\n        sales_order,\n        \"custom_total_billed\",\n        total,\n        update_modified=False\n    )\n\n\nfor item in doc.items:\n    if item.sales_order:\n        update_sales_order_billed_amount(item.sales_order)\n",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": "get_total_summary",
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Insert",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2026-01-17 11:55:36.440901",
  "module": null,
  "name": "Get Total Sale Invoice Summary",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": null,
  "script": "sales_order = frappe.form_dict.get('sale_order')\r\n\r\nif not sales_order:\r\n    frappe.throw('Not Found Sale Order')\r\n\r\ntotal = frappe.db.sql(\"\"\"\r\n    SELECT SUM(delivered_qty)\r\n    FROM `tabSales Order Item`\r\n    WHERE parent = %s\r\n\"\"\", sales_order)[0][0] or 0\r\n\r\ntotal_collected = frappe.db.sql(\"\"\"\r\n    SELECT SUM(per.allocated_amount)\r\n    FROM `tabPayment Entry Reference` per\r\n    INNER JOIN `tabSales Invoice` si\r\n        ON per.reference_name = si.name\r\n    WHERE\r\n        per.reference_doctype = 'Sales Invoice'\r\n        AND si.docstatus = 1\r\n        AND per.docstatus = 1\r\n        AND EXISTS (\r\n            SELECT 1\r\n            FROM `tabSales Invoice Item` sii\r\n            WHERE sii.parent = si.name\r\n              AND sii.sales_order = %s\r\n        )\r\n    \"\"\", sales_order)[0][0] or 0\r\n\r\ntotal_billed = frappe.db.sql(\"\"\"\r\n    SELECT SUM(sii.amount)\r\n    FROM `tabSales Invoice Item` sii\r\n    INNER JOIN `tabSales Invoice` si ON si.name = sii.parent\r\n    WHERE\r\n        sii.sales_order = %s\r\n        AND si.docstatus = 1\r\n\"\"\", sales_order)[0][0] or 0\r\n\r\nso_total_qty = frappe.db.sql(\"\"\"\r\n    SELECT SUM(qty)\r\n    FROM `tabSales Order Item`\r\n    WHERE parent = %s\r\n    AND docstatus = 1\r\n\"\"\", sales_order)[0][0] or 0\r\n\r\nfrappe.response['message'] = {\r\n    \"sales_order\": sales_order,\r\n    \"total_delivered_qty\": total,\r\n    \"total_allocated_amount\": total_collected,\r\n    \"total_billed\": total_billed,\r\n    \"total_qty\": so_total_qty\r\n}\r\n",
  "script_type": "API"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 1,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Validate",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2025-12-26 14:43:21.023296",
  "module": null,
  "name": "duplication validate",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "Delivery Note",
  "script": "import uuid\n\nfor row in doc.items:\n    if not row.custom_line_ref:\n        row.line_ref = uuid.uuid4().hex[:8].upper()\n",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Save",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2026-01-06 15:53:27.188882",
  "module": null,
  "name": "Add Routing For Bom Creator",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "BOM",
  "script": "if doc.bom_creator:\r\n    bom_creator_routings = frappe.get_all(\r\n        \"Bom Creator Routing\",\r\n        fields=[\"name\", \"item_code\", \"routing\", \"transfer_material_against\"],\r\n        filters={\r\n            \"parent\": doc.bom_creator\r\n        }\r\n    )\r\n    \r\n    bom_creator_items = frappe.get_all(\r\n        \"BOM Creator Item\",\r\n        fields=[\"operation\", \"item_code\"],\r\n        filters={\r\n            \"fg_item\": doc.item,\r\n            \"parent\": doc.bom_creator\r\n        }\r\n    )\r\n    creator_routing= None\r\n    for item in bom_creator_routings:\r\n        if item.item_code == doc.item:\r\n            creator_routing = item\r\n            break\r\n        \r\n    if creator_routing:\r\n        doc.with_operations = 1\r\n        doc.routing = creator_routing.routing\r\n        doc.transfer_material_against = creator_routing.transfer_material_against\r\n        \r\n        for bom_item in doc.items:\r\n            for bom_creator_item in bom_creator_items:\r\n                if bom_item.item_code == bom_creator_item.item_code:\r\n                    bom_item.operation = bom_creator_item.operation\r\n    ",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": "get_required_materials_from_work_orders",
  "cron_format": null,
  "disabled": 1,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Insert",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2025-07-10 11:18:06.467445",
  "module": "Baller Headwear",
  "name": "get_required_materials_from_work_orders",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": null,
  "script": "def get_required_materials_from_work_orders(work_orders):\n    if isinstance(work_orders, str):\n        work_orders = frappe.parse_json(work_orders)\n\n    if not work_orders:\n        return []\n\n    materials = {}\n\n    for wo in work_orders:\n        bom_items = frappe.get_all(\n            \"Work Order Item\",\n            filters={\"parent\": wo},\n            fields=[\"item_code\", \"required_qty\", \"uom\"]\n        )\n        for item in bom_items:\n            key = (item[\"item_code\"], item[\"uom\"])\n            if key not in materials:\n                materials[key] = 0\n            materials[key] = materials[key] + item[\"required_qty\"]\n\n    return [\n        {\n            \"item_code\": key[0],\n            \"uom\": key[1],\n            \"total_qty\": qty\n        }\n        for key, qty in materials.items()\n    ]\n",
  "script_type": "API"
 },
 {
  "allow_guest": 0,
  "api_method": "get_work_orders_by_production_plan",
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Insert",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2026-01-07 09:17:49.175142",
  "module": "",
  "name": "get_work_orders_by_production_plan",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": null,
  "script": "\r\n# L·∫•y input t·ª´ request\r\nproduction_plan = frappe.form_dict.get(\"production_plan\")\r\nplanned_start_date_from = frappe.form_dict.get(\"planned_start_date_from\")\r\nplanned_start_date_to = frappe.form_dict.get(\"planned_start_date_to\")\r\nitem_to_manufacture = frappe.form_dict.get(\"item_to_manufacture\")\r\npo_number = frappe.form_dict.get(\"po_number\")\r\npurpose = frappe.form_dict.get(\"purpose\")\r\nitem_code = frappe.form_dict.get(\"item_code\")\r\n\r\n# T·∫°o dict filter c∆° b·∫£n\r\nfilters = {}\r\n\r\n# 1. L·ªçc theo tr·∫°ng th√°i Work Order\r\nif purpose == \"Material Transfer for Manufacture\":\r\n    filters[\"status\"] = [\"in\", [\"Not Started\", \"In Process\"]]\r\nelse:\r\n    filters[\"status\"] = \"In Process\"\r\n\r\n# 2. L·ªçc theo kho·∫£ng ng√†y Planned Start\r\nif planned_start_date_from and planned_start_date_to:\r\n    filters[\"planned_start_date\"] = [\"between\", [planned_start_date_from, planned_start_date_to]]\r\n\r\n# 3. L·ªçc theo Production Plan\r\nif production_plan:\r\n    filters[\"production_plan\"] = production_plan\r\n\r\n# 4. L·ªçc theo item_code\r\nif item_code:\r\n    filters[\"production_item\"] = [\"like\", f\"%{item_code}%\"]\r\n\r\n# 5. L·ªçc theo item_to_manufacture (c√≥ th·ªÉ l√† JSON list)\r\nif item_to_manufacture:\r\n    try:\r\n        items = json.loads(item_to_manufacture)\r\n        if isinstance(items, list) and len(items) > 0:\r\n            filters[\"production_item\"] = [\"in\", items]\r\n    except Exception:\r\n        # n·∫øu kh√¥ng ph·∫£i JSON, d√πng nh∆∞ string\r\n        filters[\"production_item\"] = item_to_manufacture\r\n\r\n# 6. L·ªçc theo PO Number\r\nif po_number:\r\n    filters[\"po_number\"] = po_number\r\n\r\n# Query danh s√°ch Work Orders theo filter c∆° b·∫£n\r\nwork_orders = frappe.get_all(\r\n    \"Work Order\",\r\n    filters=filters,\r\n    fields=[\r\n        \"name\",\r\n        \"qty\",\r\n        \"production_item\",\r\n        \"bom_no\",\r\n        \"material_transferred_for_manufacturing\",\r\n    ],\r\n)\r\n\r\n# 7. N·∫øu purpose l√† \"Material Transfer\" => ch·ªâ gi·ªØ WO c√≥ Material Request\r\nif purpose == \"Material Transfer\":\r\n    work_orders = [\r\n        wo for wo in work_orders\r\n        if frappe.db.exists(\"Material Request\", {\"work_order\": wo.name})\r\n    ]\r\n\r\n# 8. N·∫øu purpose l√† \"Material Transfer for Manufacturing\" => ch·ªâ gi·ªØ nh·ªØng WO ch∆∞a chuy·ªÉn h·∫øt\r\nif purpose == \"Material Transfer for Manufacturing\":\r\n    work_orders = [\r\n        wo for wo in work_orders\r\n        if float(wo.get(\"material_transferred_for_manufacturing\") or 0) < float(wo.get(\"qty\") or 0)\r\n    ]\r\n\r\n# 9. Tr·∫£ v·ªÅ k·∫øt qu·∫£\r\nfrappe.response[\"message\"] = work_orders\r\n",
  "script_type": "API"
 },
 {
  "allow_guest": 0,
  "api_method": "get_pick_list_items_from_wo",
  "cron_format": null,
  "disabled": 1,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Insert",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2025-07-10 11:18:06.600283",
  "module": "Baller Headwear",
  "name": "get_pick_list_items_from_wo",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": null,
  "script": "def get_pick_list_items_from_wo(work_orders):\n    work_orders = frappe.parse_json(work_orders)\n    result = []\n\n    for wo in work_orders:\n        doc = frappe.get_doc(\"Work Order\", wo)\n        for item in doc.required_items:\n            result.append({\n                \"item_code\": item.item_code,\n                \"source_warehouse\": item.source_warehouse,\n                \"required_qty\": item.required_qty,\n                \"stock_qty\": item.transferred_qty or 0\n            })\n\n    return result\n",
  "script_type": "API"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Save",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2025-07-10 11:18:06.696959",
  "module": "Baller Headwear",
  "name": "Validate BOM Creator",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "BOM Creator",
  "script": "valid_items = [doc.item_code] + [r.item_code for r in doc.items]\n\nfor row in doc.items:\n    if not row.fg_item:\n        frappe.throw(f\"Row {row.idx or '-'} is missing FG Item.\")\n\n    if row.custom_planned_fabric_needed <= 0:\n        frappe.throw(f\"Row {row.idx or '-'} ({row.item_code}) has invalid Planned Fabric Needed: {row.custom_planned_fabric_needed}\")\n\n    if row.fg_item not in valid_items:\n        frappe.throw(\n            f\"Row {row.idx or '-'}: FG Item '{row.fg_item}' is invalid. It must match the main Item Code '{doc.item_code}' or one of the Item Codes in the table.\"\n        )\n",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Save",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2025-07-10 11:18:06.673863",
  "module": "Baller Headwear",
  "name": "Validate FG Reference",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "BOM Creator",
  "script": "parent_reference = {row.idx: row.name for row in doc.items}\n\nfor row in doc.items:\n    ref_id = \"\"\n\n    try:\n        parent_row_no = int(row.parent_row_no) if row.parent_row_no else None\n    except (ValueError, TypeError):\n        parent_row_no = None\n\n    if parent_row_no:\n        ref_id = parent_reference.get(parent_row_no)\n\n    if row.fg_reference_id and row.fg_reference_id == ref_id:\n        continue\n\n    if parent_row_no:\n        row.fg_reference_id = ref_id\n    elif row.fg_item == doc.item_code:\n        row.fg_reference_id = doc.name\n",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Delete",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2026-01-07 16:31:01.975085",
  "module": null,
  "name": "Total Billed Of Sales Order Before Delete",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "Sales Invoice",
  "script": "\ndef update_sales_order_billed_amount(sales_order):\n    if not sales_order:\n        return\n\n    total = frappe.db.sql(\"\"\"\n        SELECT SUM(sii.amount)\n        FROM `tabSales Invoice Item` sii\n        JOIN `tabSales Invoice` si ON si.name = sii.parent\n        WHERE\n            sii.sales_order = %s\n            AND si.docstatus = 1\n    \"\"\", sales_order)[0][0] or 0\n\n    frappe.db.set_value(\n        \"Sales Order\",\n        sales_order,\n        \"custom_total_billed\",\n        total,\n        update_modified=False\n    )\n\n\nfor item in doc.items:\n    if item.sales_order:\n        update_sales_order_billed_amount(item.sales_order)\n",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Validate",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2026-01-08 10:48:01.466238",
  "module": null,
  "name": "Ignore Validate 242",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "Asset Category",
  "script": "doc.flags.ignore_validate = True",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Insert",
  "enable_rate_limit": 0,
  "event_frequency": "Daily",
  "modified": "2026-01-11 21:21:22.507973",
  "module": null,
  "name": "Daily Working Hours Auto Create",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": null,
  "script": "# # --------------------------------------------\n# # Daily Working Hours Auto Entry - SAFE VERSION\n# # --------------------------------------------\n\n# today = frappe.utils.getdate(frappe.utils.nowdate())\n# yesterday = frappe.utils.add_days(today, -1)\n\n# # Fetch Standard Working Hours from HR Settings (safe)\n# hr_settings = frappe.get_doc(\"HR Settings\")\n# standard_hours = hr_settings.standard_working_hours or 8\n\n# # Get all employees\n# employee_list = frappe.get_all(\"Employee\", fields=[\"name\"])\n\n# for emp in employee_list:\n#     emp_id = emp.name\n\n#     # Fetch IN checkin\n#     checkin_in = frappe.db.sql(\"\"\"\n#         SELECT name, time, shift FROM `tabEmployee Checkin`\n#         WHERE employee=%s AND log_type='IN' AND DATE(time)=%s\n#         ORDER BY time ASC LIMIT 1\n#     \"\"\", (emp_id, yesterday), as_dict=True)\n\n#     # Fetch OUT checkin\n#     checkin_out = frappe.db.sql(\"\"\"\n#         SELECT name, time, shift FROM `tabEmployee Checkin`\n#         WHERE employee=%s AND log_type='OUT' AND DATE(time)=%s\n#         ORDER BY time DESC LIMIT 1\n#     \"\"\", (emp_id, yesterday), as_dict=True)\n\n#     if not checkin_in or not checkin_out:\n#         continue\n\n#     in_row = checkin_in[0]\n#     out_row = checkin_out[0]\n\n#     in_time = in_row.time\n#     out_time = out_row.time\n#     shift_type = in_row.shift\n\n#     # Compute total hours\n#     total_hours = (out_time - in_time).total_seconds() / 3600\n\n#     # Avoid duplicate Daily Working Hours\n#     exists = frappe.db.exists(\"Daily Working Hours\", {\n#         \"employee_id\": emp_id,\n#         \"date\": yesterday\n#     })\n\n#     if exists:\n#         continue\n\n#     # Create Daily Working Hours\n#     dwh = frappe.new_doc(\"Daily Working Hours\")\n#     dwh.employee_id = emp_id\n#     dwh.date = yesterday\n#     dwh.shift_type = shift_type\n#     dwh.checkin_date_time = in_time\n#     dwh.checkout_date_time = out_time\n#     dwh.employee_checkin_id = in_row.name\n#     dwh.employee_checkout_id = out_row.name\n#     dwh.total_hours = total_hours\n#     dwh.standard_working_hours = standard_hours\n#     dwh.overtime_hours = max(0, total_hours - standard_hours)\n#     dwh.save(ignore_permissions=True)\n#     frappe.db.commit()\n\n#     # If overtime > 0 create Employee Overtime\n#     if dwh.overtime_hours > 0:\n#         ot = frappe.new_doc(\"Employee Overtime\")\n#         ot.employee_id = emp_id\n#         ot.date = yesterday\n#         ot.shift_type = shift_type\n#         ot.checkin_date_time = in_time\n#         ot.checkout_date_time = out_time\n#         ot.employee_checkin_id = in_row.name\n#         ot.employee_checkout_id = out_row.name\n#         ot.total_hours = total_hours\n#         ot.standard_working_hours = standard_hours\n#         ot.overtime_hours = dwh.overtime_hours\n#         ot.daily_working_hours_reference = dwh.name\n#         ot.save(ignore_permissions=True)\n#         frappe.db.commit()\n\n\n\n# ------------------------------------------------------------\n# Monthly Working Hours Auto Entry (PREVIOUS MONTH)\n# SAFE + Shift Assignment + Cross-midnight + Break Window + Batch Commit\n#\n# Guarantees:\n# - 1 Daily Working Hours per employee + shift_start_date\n# - 1 Employee Overtime per Daily Working Hours\n# - Fully idempotent (safe re-run)\n#\n# Employee Overtime:\n# - Uses fields: shift, daily_working_hours_id, hourly_rate (Float)\n# - Fetches hourly rate from latest submitted Salary Structure Assignment\n#   where from_date <= shift_start_date (order by from_date desc)\n# - If no SSA, hourly_rate = 0 (still creates OT)\n# ------------------------------------------------------------\n\ntoday = frappe.utils.getdate(frappe.utils.nowdate())\n\n# Previous month range\nthis_month_start = today.replace(day=1)\nprev_month_end = frappe.utils.add_days(this_month_start, -1)\nprev_month_start = prev_month_end.replace(day=1)\n\nOUT_WINDOW_HOURS = 20\nCOMMIT_EVERY = 100\n\nshift_cache = {}\nhourly_rate_cache = {}  # {(emp_id, as_of_date): hourly_rate}\n\nemployee_list = frappe.get_all(\n    \"Employee\",\n    filters={\"status\": \"Active\"},\n    fields=[\"name\"]\n)\n\npending_writes = 0\ndays_in_prev_month = (prev_month_end - prev_month_start).days + 1\n\nfor day_offset in range(days_in_prev_month):\n\n    target_end_date = frappe.utils.add_days(prev_month_start, day_offset)\n\n    # Shifts that can END on target_end_date:\n    # - Day shifts start same date\n    # - Night shift starts previous date\n    start_dates = [\n        target_end_date,\n        frappe.utils.add_days(target_end_date, -1)\n    ]\n\n    for emp in employee_list:\n        emp_id = emp.name\n\n        for shift_start_date in start_dates:\n\n            try:\n                # ------------------------------------------------------------\n                # Shift Assignment (as on shift_start_date)\n                # ------------------------------------------------------------\n                shift_row = frappe.db.sql(\"\"\"\n                    SELECT shift_type\n                    FROM `tabShift Assignment`\n                    WHERE employee=%s\n                      AND docstatus=1\n                      AND start_date <= %s\n                      AND (end_date IS NULL OR end_date >= %s)\n                    ORDER BY start_date DESC\n                    LIMIT 1\n                \"\"\", (emp_id, shift_start_date, shift_start_date), as_dict=True)\n\n                if not shift_row or not shift_row[0].get(\"shift_type\"):\n                    continue\n\n                shift_type = shift_row[0].shift_type\n\n                # ------------------------------------------------------------\n                # Prevent duplicate DWH (1 per employee + shift_start_date)\n                # ------------------------------------------------------------\n                if frappe.db.exists(\n                    \"Daily Working Hours\",\n                    {\"employee_id\": emp_id, \"date\": shift_start_date}\n                ):\n                    continue\n\n                # ------------------------------------------------------------\n                # Shift timing cache\n                # ------------------------------------------------------------\n                if shift_type not in shift_cache:\n                    st = frappe.db.get_value(\n                        \"Shift Type\",\n                        shift_type,\n                        [\n                            \"start_time\",\n                            \"end_time\",\n                            \"custom_break_start_time\",\n                            \"custom_break_end_time\",\n                        ],\n                        as_dict=True\n                    )\n                    if not st:\n                        continue\n                    shift_cache[shift_type] = st\n\n                st = shift_cache[shift_type]\n\n                standard_in = frappe.utils.get_datetime(f\"{shift_start_date} {st.start_time}\")\n                standard_out = frappe.utils.get_datetime(f\"{shift_start_date} {st.end_time}\")\n\n                # Cross-midnight shift\n                if st.end_time <= st.start_time:\n                    standard_out = frappe.utils.add_days(standard_out, 1)\n\n                # We settle ONLY shifts that ended on target_end_date\n                if frappe.utils.getdate(standard_out) != target_end_date:\n                    continue\n\n                # ------------------------------------------------------------\n                # Break window (compute STANDARD break hours + overlap later)\n                # ------------------------------------------------------------\n                break_hours = 0.0\n                break_start_dt = None\n                break_end_dt = None\n\n                if st.custom_break_start_time and st.custom_break_end_time:\n                    break_start_dt = frappe.utils.get_datetime(f\"{shift_start_date} {st.custom_break_start_time}\")\n                    break_end_dt = frappe.utils.get_datetime(f\"{shift_start_date} {st.custom_break_end_time}\")\n\n                    # Break crosses midnight\n                    if st.custom_break_end_time <= st.custom_break_start_time:\n                        break_end_dt = frappe.utils.add_days(break_end_dt, 1)\n\n                    # Night shift: break might be after midnight next day\n                    if break_end_dt <= standard_in:\n                        break_start_dt = frappe.utils.add_days(break_start_dt, 1)\n                        break_end_dt = frappe.utils.add_days(break_end_dt, 1)\n\n                    clamp_bs = max(break_start_dt, standard_in)\n                    clamp_be = min(break_end_dt, standard_out)\n\n                    if clamp_be > clamp_bs:\n                        break_hours = (clamp_be - clamp_bs).total_seconds() / 3600.0\n\n                # ------------------------------------------------------------\n                # Punches\n                # ------------------------------------------------------------\n                in_search_start = frappe.utils.add_to_date(standard_in, hours=-2)\n                in_search_end = frappe.utils.add_to_date(standard_out, hours=4)\n\n                in_row = frappe.db.sql(\"\"\"\n                    SELECT name, time\n                    FROM `tabEmployee Checkin`\n                    WHERE employee=%s AND log_type='IN'\n                      AND time BETWEEN %s AND %s\n                    ORDER BY time ASC\n                    LIMIT 1\n                \"\"\", (emp_id, in_search_start, in_search_end), as_dict=True)\n\n                if not in_row:\n                    continue\n\n                actual_in = in_row[0].time\n\n                out_search_end = frappe.utils.add_to_date(actual_in, hours=OUT_WINDOW_HOURS)\n\n                out_row = frappe.db.sql(\"\"\"\n                    SELECT name, time\n                    FROM `tabEmployee Checkin`\n                    WHERE employee=%s AND log_type='OUT'\n                      AND time BETWEEN %s AND %s\n                    ORDER BY time DESC\n                    LIMIT 1\n                \"\"\", (emp_id, actual_in, out_search_end), as_dict=True)\n\n                if not out_row:\n                    continue\n\n                actual_out = out_row[0].time\n\n                # ------------------------------------------------------------\n                # Hours\n                # ------------------------------------------------------------\n                total_hours = (actual_out - actual_in).total_seconds() / 3600.0\n                if total_hours <= 0 or total_hours > OUT_WINDOW_HOURS:\n                    continue\n\n                standard_total = (standard_out - standard_in).total_seconds() / 3600.0\n                standard_working_hours = max(standard_total - break_hours, 0.0)\n\n                regular_in = max(actual_in, standard_in)\n                regular_out = min(actual_out, standard_out)\n\n                presence_hours = max((regular_out - regular_in).total_seconds() / 3600.0, 0.0)\n\n                break_overlap = 0.0\n                if break_start_dt and break_end_dt and regular_out > regular_in:\n                    ov_start = max(regular_in, break_start_dt)\n                    ov_end = min(regular_out, break_end_dt)\n                    if ov_end > ov_start:\n                        break_overlap = (ov_end - ov_start).total_seconds() / 3600.0\n\n                actual_working_hours = min(\n                    max(presence_hours - break_overlap, 0.0),\n                    standard_working_hours\n                )\n\n                overtime_hours = 0.0\n                if actual_out > standard_out:\n                    overtime_hours = (actual_out - standard_out).total_seconds() / 3600.0\n\n                # ------------------------------------------------------------\n                # Create DWH\n                # ------------------------------------------------------------\n                dwh = frappe.new_doc(\"Daily Working Hours\")\n                dwh.employee_id = emp_id\n                dwh.date = shift_start_date\n                dwh.shift_type = shift_type\n\n                dwh.checkin_date_time = actual_in\n                dwh.checkout_date_time = actual_out\n                dwh.employee_checkin_id = in_row[0].name\n                dwh.employee_checkout_id = out_row[0].name\n\n                dwh.total_hours = total_hours\n                dwh.standard_working_hours = standard_working_hours\n                dwh.actual_working_hours = actual_working_hours\n                dwh.overtime_hours = overtime_hours\n                dwh.break_time = break_overlap\n\n                dwh.save(ignore_permissions=True)\n                pending_writes += 1\n\n                # ------------------------------------------------------------\n                # Create Employee Overtime (ONE per DWH)\n                # ------------------------------------------------------------\n                if overtime_hours > 0 and not frappe.db.exists(\n                    \"Employee Overtime\",\n                    {\"daily_working_hours_id\": dwh.name}\n                ):\n                    # Hourly rate fetch (cached)\n                    rate_key = (emp_id, shift_start_date)\n\n                    if rate_key in hourly_rate_cache:\n                        hourly_rate = hourly_rate_cache[rate_key]\n                    else:\n                        ssa_name = frappe.db.get_value(\n                            \"Salary Structure Assignment\",\n                            {\n                                \"employee\": emp_id,\n                                \"docstatus\": 1,\n                                \"from_date\": (\"<=\", shift_start_date),\n                            },\n                            \"name\",\n                            order_by=\"from_date desc\"\n                        )\n\n                        if ssa_name:\n                            ssa_doc = frappe.get_doc(\"Salary Structure Assignment\", ssa_name)\n                            hourly_rate = ssa_doc.custom_hourly_rate or 0.0\n                        else:\n                            hourly_rate = 0.0\n\n                        hourly_rate_cache[rate_key] = hourly_rate\n\n                    ot = frappe.new_doc(\"Employee Overtime\")\n                    ot.employee_id = emp_id\n                    ot.date = shift_start_date\n                    ot.shift = shift_type\n                    ot.daily_working_hours_id = dwh.name\n                    ot.hourly_rate = hourly_rate\n                    ot.overtime_fomulas_details = \"Working Overtime On Normal Workdays.\"\n\n                    ot.total_hours = total_hours\n                    ot.standard_working_hours = standard_working_hours\n                    ot.overtime_hours = overtime_hours\n\n                    ot.save(ignore_permissions=True)\n                    pending_writes += 1\n\n                if pending_writes >= COMMIT_EVERY:\n                    frappe.db.commit()\n                    pending_writes = 0\n\n            except Exception:\n                frappe.log_error(\n                    frappe.utils.get_traceback(),\n                    \"Monthly Working Hours Auto Entry\"\n                )\n\nif pending_writes:\n    frappe.db.commit()\n\n\n\n# # --------------------------------------------\n# # Monthly Working Hours Auto Entry - SAFE VERSION\n# # --------------------------------------------\n\n# today = frappe.utils.getdate(frappe.utils.nowdate())\n# first_day = today.replace(day=1)\n# last_day = frappe.utils.add_days(frappe.utils.add_months(first_day, 1), -1)\n\n# # Fetch Standard Working Hours from HR Settings\n# hr_settings = frappe.get_doc(\"HR Settings\")\n# standard_hours = hr_settings.standard_working_hours or 8\n\n# # Get all employees\n# employee_list = frappe.get_all(\"Employee\", fields=[\"name\"])\n\n# # Loop: For each employee\n# for emp in employee_list:\n#     emp_id = emp.name\n\n#     # Loop: For each date of the month\n#     loop_date = first_day\n#     while loop_date <= last_day:\n\n#         # Fetch IN checkin\n#         checkin_in = frappe.db.sql(\"\"\"\n#             SELECT name, time, shift FROM `tabEmployee Checkin`\n#             WHERE employee=%s AND log_type='IN' AND DATE(time)=%s\n#             ORDER BY time ASC LIMIT 1\n#         \"\"\", (emp_id, loop_date), as_dict=True)\n\n#         # Fetch OUT checkin\n#         checkin_out = frappe.db.sql(\"\"\"\n#             SELECT name, time, shift FROM `tabEmployee Checkin`\n#             WHERE employee=%s AND log_type='OUT' AND DATE(time)=%s\n#             ORDER BY time DESC LIMIT 1\n#         \"\"\", (emp_id, loop_date), as_dict=True)\n\n#         # If either missing ‚Üí skip\n#         if not checkin_in or not checkin_out:\n#             loop_date = frappe.utils.add_days(loop_date, 1)\n#             continue\n\n#         in_row = checkin_in[0]\n#         out_row = checkin_out[0]\n\n#         in_time = in_row.time\n#         out_time = out_row.time\n#         shift_type = in_row.shift\n\n#         # Compute total hours\n#         total_hours = (out_time - in_time).total_seconds() / 3600\n\n#         # Avoid duplicate Daily Working Hours\n#         exists = frappe.db.exists(\"Daily Working Hours\", {\n#             \"employee_id\": emp_id,\n#             \"date\": loop_date\n#         })\n\n#         if not exists:\n#             # Create Daily Working Hours entry\n#             dwh = frappe.new_doc(\"Daily Working Hours\")\n#             dwh.employee_id = emp_id\n#             dwh.date = loop_date\n#             dwh.shift_type = shift_type\n#             dwh.checkin_date_time = in_time\n#             dwh.checkout_date_time = out_time\n#             dwh.employee_checkin_id = in_row.name\n#             dwh.employee_checkout_id = out_row.name\n#             dwh.total_hours = total_hours\n#             dwh.standard_working_hours = standard_hours\n#             dwh.overtime_hours = max(0, total_hours - standard_hours)\n#             dwh.save(ignore_permissions=True)\n#             frappe.db.commit()\n\n#             # Create Overtime Entry if needed\n#             if dwh.overtime_hours > 0:\n#                 ot = frappe.new_doc(\"Employee Overtime\")\n#                 ot.employee_id = emp_id\n#                 ot.date = loop_date\n#                 ot.shift_type = shift_type\n#                 ot.checkin_date_time = in_time\n#                 ot.checkout_date_time = out_time\n#                 ot.employee_checkin_id = in_row.name\n#                 ot.employee_checkout_id = out_row.name\n#                 ot.total_hours = total_hours\n#                 ot.standard_working_hours = standard_hours\n#                 ot.overtime_hours = dwh.overtime_hours\n#                 ot.daily_working_hours_reference = dwh.name\n#                 ot.save(ignore_permissions=True)\n#                 frappe.db.commit()\n\n#         # move to next date\n#         loop_date = frappe.utils.add_days(loop_date, 1)\n\n",
  "script_type": "Scheduler Event"
 },
 {
  "allow_guest": 0,
  "api_method": "attendance_bonus_build_rows",
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Insert",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2026-01-21 15:40:56.282099",
  "module": null,
  "name": "Attendance Bonus Calc",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": null,
  "script": "# ---------------------------------------------------------\r\n# API Server Script: attendance_bonus_build_rows\r\n# Inputs:\r\n#   frappe.form_dict.payroll_date (Date)\r\n#   frappe.form_dict.company\r\n# Output:\r\n#   frappe.response[\"message\"] = {month_start, month_end, rows: []}\r\n# ---------------------------------------------------------\r\n\r\npayroll_date = (frappe.form_dict.get(\"payroll_date\") or \"\").strip()\r\ncompany = (frappe.form_dict.get(\"company\") or \"\").strip()\r\n\r\nif not payroll_date:\r\n    frappe.throw(\"payroll_date is required\")\r\n\r\nif not company:\r\n    frappe.throw(\"company is required\")\r\n\r\n# ----------------------------\r\n# Attendance Regulation names (must match exactly)\r\n# ----------------------------\r\nREG_FULL = \"Full monthly working hours\"\r\nREG_4_8 = \"Unexcused absence 4‚Äì8 working hours/month\"\r\nREG_OVER_8 = \"Unexcused absence over 8 working hours/month\"\r\n\r\n# New filter: only employees whose branch is Factory\r\nFACTORY_BRANCH_NAME = \"Factory\"\r\n\r\nEXCLUDED_DESIGNATION_KEYWORDS = [\"leader\", \"manager\", \"supervisor\"]\r\n\r\n# ----------------------------\r\n# Month range from payroll_date (safe)\r\n# ----------------------------\r\nym = payroll_date[:7]          # \"YYYY-MM\"\r\nmonth_start = ym + \"-01\"\r\nnext_month_start = frappe.utils.add_months(month_start, 1)\r\nmonth_end = frappe.utils.add_days(next_month_start, -1)\r\nmonth_15 = ym + \"-15\"\r\n\r\n# ----------------------------\r\n# Holiday list from Company\r\n# ----------------------------\r\ncompany_doc = frappe.get_doc(\"Company\", company)\r\nholiday_list_name = company_doc.default_holiday_list or \"\"\r\nif not holiday_list_name:\r\n    frappe.throw(\"Company '\" + company + \"' has no Default Holiday List set.\")\r\n\r\n# ----------------------------\r\n# Build holiday map for month\r\n# ----------------------------\r\nholiday_rows = frappe.get_all(\r\n    \"Holiday\",\r\n    filters={\r\n        \"parent\": holiday_list_name,\r\n        \"holiday_date\": [\"between\", [month_start, month_end]],\r\n    },\r\n    fields=[\"holiday_date\"],\r\n    limit_page_length=0\r\n)\r\n\r\nholiday_map = {}\r\nfor r in (holiday_rows or []):\r\n    d = frappe.utils.getdate(r.get(\"holiday_date\"))\r\n    holiday_map[str(d)] = 1\r\n\r\ndays_in_month = (frappe.utils.getdate(month_end) - frappe.utils.getdate(month_start)).days + 1\r\nmonth_expected_working_days = days_in_month - len(holiday_map)\r\n\r\n# ----------------------------\r\n# Check if Daily Working Hours has 'company' field (safe_exec friendly)\r\n# ----------------------------\r\ndwh_meta = frappe.get_meta(\"Daily Working Hours\")\r\nhas_company_field = 0\r\nfor df in (dwh_meta.fields or []):\r\n    if (df.fieldname or \"\") == \"company\":\r\n        has_company_field = 1\r\n        break\r\n\r\n# ----------------------------\r\n# Check if Employee has 'branch' field (safe_exec friendly)\r\n# ----------------------------\r\nemp_meta = frappe.get_meta(\"Employee\")\r\nhas_branch_field = 0\r\nfor df in (emp_meta.fields or []):\r\n    if (df.fieldname or \"\") == \"branch\":\r\n        has_branch_field = 1\r\n        break\r\n\r\nif has_branch_field == 0:\r\n    frappe.throw(\"Employee doctype has no 'branch' field. Please add/enable 'branch' or update this script to use the correct fieldname.\")\r\n\r\n# ----------------------------\r\n# Aggregate Daily Working Hours per employee\r\n# - Sum standard_working_hours\r\n# - Sum actual_working_hours\r\n# - Count distinct worked days where checkin+checkout exist\r\n# (Removed Day Shift logic)\r\n# ----------------------------\r\nif has_company_field:\r\n    wh_rows = frappe.db.sql(\r\n        \"\"\"\r\n        SELECT\r\n            employee_id,\r\n            COALESCE(SUM(standard_working_hours), 0) AS standard_hours,\r\n            COALESCE(SUM(actual_working_hours), 0)   AS actual_hours,\r\n            COUNT(DISTINCT CASE\r\n                WHEN IFNULL(checkin_date_time,'') != '' AND IFNULL(checkout_date_time,'') != ''\r\n                THEN `date` ELSE NULL END\r\n            ) AS worked_days\r\n        FROM `tabDaily Working Hours`\r\n        WHERE `date` BETWEEN %s AND %s\r\n          AND IFNULL(employee_id, '') != ''\r\n          AND company = %s\r\n        GROUP BY employee_id\r\n        \"\"\",\r\n        (month_start, month_end, company),\r\n        as_dict=True\r\n    )\r\nelse:\r\n    wh_rows = frappe.db.sql(\r\n        \"\"\"\r\n        SELECT\r\n            employee_id,\r\n            COALESCE(SUM(standard_working_hours), 0) AS standard_hours,\r\n            COALESCE(SUM(actual_working_hours), 0)   AS actual_hours,\r\n            COUNT(DISTINCT CASE\r\n                WHEN IFNULL(checkin_date_time,'') != '' AND IFNULL(checkout_date_time,'') != ''\r\n                THEN `date` ELSE NULL END\r\n            ) AS worked_days\r\n        FROM `tabDaily Working Hours`\r\n        WHERE `date` BETWEEN %s AND %s\r\n          AND IFNULL(employee_id, '') != ''\r\n        GROUP BY employee_id\r\n        \"\"\",\r\n        (month_start, month_end),\r\n        as_dict=True\r\n    )\r\n\r\n# Empty response if nothing\r\nif not wh_rows:\r\n    frappe.response[\"message\"] = {\"month_start\": month_start, \"month_end\": month_end, \"rows\": []}\r\nelse:\r\n    employee_ids = [r.get(\"employee_id\") for r in wh_rows if r.get(\"employee_id\")]\r\n\r\n    if not employee_ids:\r\n        frappe.response[\"message\"] = {\"month_start\": month_start, \"month_end\": month_end, \"rows\": []}\r\n    else:\r\n        # ----------------------------\r\n        # Load Active employees for this company + branch=Factory + (designation, DOJ)\r\n        # ----------------------------\r\n        emp_rows = frappe.get_all(\r\n            \"Employee\",\r\n            filters={\r\n                \"status\": \"Active\",\r\n                \"company\": company,\r\n                \"branch\": FACTORY_BRANCH_NAME,\r\n                \"name\": [\"in\", employee_ids],\r\n            },\r\n            fields=[\"name\", \"employee_name\", \"designation\", \"date_of_joining\", \"branch\"],\r\n            limit_page_length=0\r\n        )\r\n\r\n        emp_map = {}\r\n        for e in (emp_rows or []):\r\n            emp_map[e.get(\"name\")] = {\r\n                \"employee_name\": e.get(\"employee_name\") or \"\",\r\n                \"designation\": e.get(\"designation\") or \"\",\r\n                \"date_of_joining\": e.get(\"date_of_joining\"),\r\n                \"branch\": e.get(\"branch\") or \"\",\r\n            }\r\n\r\n        # ----------------------------\r\n        # Allowance map (only needed regs)\r\n        # ----------------------------\r\n        reg_docs = frappe.get_all(\r\n            \"Attendance Regulation\",\r\n            filters={\"name\": [\"in\", [REG_FULL, REG_4_8, REG_OVER_8]]},\r\n            fields=[\"name\", \"allowance_amount\"],\r\n            limit_page_length=0\r\n        )\r\n\r\n        allowance_map = {}\r\n        for rd in (reg_docs or []):\r\n            allowance_map[rd.get(\"name\")] = float(rd.get(\"allowance_amount\") or 0)\r\n\r\n        if REG_FULL not in allowance_map:\r\n            allowance_map[REG_FULL] = 0.0\r\n        if REG_4_8 not in allowance_map:\r\n            allowance_map[REG_4_8] = 0.0\r\n        if REG_OVER_8 not in allowance_map:\r\n            allowance_map[REG_OVER_8] = 0.0\r\n\r\n        rows_out = []\r\n\r\n        # Pre-calc these date objects once\r\n        ms_dt = frappe.utils.getdate(month_start)\r\n        me_dt = frappe.utils.getdate(month_end)\r\n        m15_dt = frappe.utils.getdate(month_15)\r\n\r\n        for r in wh_rows:\r\n            emp = r.get(\"employee_id\")\r\n            if not emp:\r\n                continue\r\n\r\n            # Must be active employee in emp_map (company+active+branch filter)\r\n            if emp not in emp_map:\r\n                continue\r\n\r\n            desg_full = (emp_map[emp].get(\"designation\") or \"\")\r\n            desg_lower = desg_full.lower()\r\n\r\n            # Filter out leader/manager/supervisor designations\r\n            skip_emp = 0\r\n            for w in EXCLUDED_DESIGNATION_KEYWORDS:\r\n                if w in desg_lower:\r\n                    skip_emp = 1\r\n                    break\r\n            if skip_emp == 1:\r\n                continue\r\n\r\n            standard = float(r.get(\"standard_hours\") or 0)\r\n            actual = float(r.get(\"actual_hours\") or 0)\r\n            worked_days = int(r.get(\"worked_days\") or 0)\r\n\r\n            # ----------------------------\r\n            # Employee expected working days\r\n            # Join rule applies ONLY if DOJ is within the month\r\n            # ----------------------------\r\n            emp_expected_working_days = month_expected_working_days\r\n            join_rule_applied = 0\r\n            doj = emp_map[emp].get(\"date_of_joining\")\r\n\r\n            if doj:\r\n                doj_dt = frappe.utils.getdate(doj)\r\n                if doj_dt >= ms_dt and doj_dt <= me_dt:\r\n                    join_rule_applied = 1\r\n\r\n                    if doj_dt <= m15_dt:\r\n                        effective_start = doj_dt\r\n                    else:\r\n                        effective_start = m15_dt\r\n\r\n                    cnt = 0\r\n                    dd = effective_start\r\n                    while dd <= me_dt:\r\n                        if str(dd) not in holiday_map:\r\n                            cnt = cnt + 1\r\n                        dd = frappe.utils.add_days(dd, 1)\r\n\r\n                    emp_expected_working_days = cnt\r\n\r\n            # Missing days based on expected vs worked days\r\n            missing_days = emp_expected_working_days - worked_days\r\n            if missing_days < 0:\r\n                missing_days = 0\r\n\r\n            # Hours difference (standard - actual), only meaningful when missing_days == 0\r\n            hours_diff = standard - actual\r\n            if hours_diff < 0:\r\n                hours_diff = 0.0\r\n\r\n            # ----------------------------\r\n            # Regulation selection rules\r\n            # ----------------------------\r\n            regulation = \"\"\r\n            if missing_days > 0:\r\n                regulation = REG_OVER_8\r\n            else:\r\n                if hours_diff < 4:\r\n                    regulation = REG_FULL\r\n                elif hours_diff <= 8:\r\n                    regulation = REG_4_8\r\n                else:\r\n                    regulation = REG_OVER_8\r\n\r\n            allowance = float(allowance_map.get(regulation, 0) or 0)\r\n\r\n            # ----------------------------\r\n            # Proration for mid joiners\r\n            # allowance_prorated = allowance * (emp_expected / month_expected)\r\n            # Only if joined within the month (join_rule_applied)\r\n            # ----------------------------\r\n            prorate_factor = 1.0\r\n            if join_rule_applied == 1:\r\n                if month_expected_working_days > 0:\r\n                    prorate_factor = float(emp_expected_working_days) / float(month_expected_working_days)\r\n\r\n            allowance_prorated = float(allowance) * float(prorate_factor)\r\n\r\n            rows_out.append({\r\n                \"employee\": emp,\r\n                \"designation\": desg_full,\r\n                \"missing_days\": missing_days,\r\n                \"standard_working_hours\": round(standard, 3),\r\n                \"actual_working_hours\": round(actual, 3),\r\n                \"difference\": round(hours_diff, 3),\r\n                \"regulation\": regulation,\r\n                \"allowance_amount\": round(allowance_prorated, 3)\r\n            })\r\n\r\n        frappe.response[\"message\"] = {\r\n            \"month_start\": month_start,\r\n            \"month_end\": month_end,\r\n            \"rows\": rows_out\r\n        }\r\n",
  "script_type": "API"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Save",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2026-01-19 19:32:59.470346",
  "module": null,
  "name": "Hourly Rate Calc on Salary Structure Assignment",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "Salary Structure Assignment",
  "script": "# ---------------------------------------------------------\r\n# BEFORE SAVE Server Script (INLINE)\r\n# 1) custom_monthly_salary = sum(monthly components)\r\n# 2) custom_hourly_rate = custom_monthly_salary / 208\r\n# 3) each component hourly = component / 208\r\n# ---------------------------------------------------------\r\n\r\nDIVISOR = 208.0\r\nROUND_TO = 2  # change to 3 if you want 0.000\r\n\r\n# Map: (monthly_component_fieldname, hourly_component_fieldname)\r\npairs = [\r\n    (\"custom_basic_salary\", \"custom_basic_salary_hourly\"),\r\n    (\"custom_house_allowance\", \"custom_house_allowance_hourly\"),\r\n    (\"custom_meal_allowance\", \"custom_meal_allowance_hourly\"),\r\n    (\"custom_child_allowance\", \"custom_child_allowance_hourly\"),\r\n    (\"custom_uniform_allowance\", \"custom_uniform_allowance_hourly\"),\r\n    (\"custom_women_allowance\", \"custom_women_allowance_hourly\"),\r\n    (\"custom_fuel_allowance\", \"custom_fuel_allowance_hourly\"),\r\n    (\"custom_toxic_allowance\", \"custom_toxic_allowance_hourly\"),\r\n    (\"custom_skill_allowance\", \"custom_skill_allowance_hourly\"),\r\n    (\"custom_phone_allowance\", \"custom_phone_allowance_hourly\"),\r\n    (\"custom_attendance_allowance\", \"custom_attendance_allowance_hourly\"),\r\n]\r\n\r\n# --- Sum monthly components ---\r\ntotal_monthly = 0.0\r\n\r\nfor monthly_field, hourly_field in pairs:\r\n    val = doc.get(monthly_field)\r\n\r\n    # safe float conversion\r\n    try:\r\n        val = float(val or 0)\r\n    except Exception:\r\n        val = 0.0\r\n\r\n    total_monthly += val\r\n\r\n# set monthly salary\r\ndoc.custom_monthly_salary = round(total_monthly, ROUND_TO)\r\n\r\n# --- Hourly Rate = monthly / 208 ---\r\nif total_monthly > 0:\r\n    doc.custom_hourly_rate = round(total_monthly / DIVISOR, ROUND_TO)\r\nelse:\r\n    doc.custom_hourly_rate = 0\r\n\r\n# --- Each component hourly = component / 208 ---\r\nfor monthly_field, hourly_field in pairs:\r\n    val = doc.get(monthly_field)\r\n\r\n    try:\r\n        val = float(val or 0)\r\n    except Exception:\r\n        val = 0.0\r\n\r\n    if val > 0:\r\n        doc.set(hourly_field, round(val / DIVISOR, ROUND_TO))\r\n    else:\r\n        doc.set(hourly_field, 0)\r\n\r\n",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "After Submit",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2026-01-15 11:53:08.765795",
  "module": null,
  "name": "Total Purchase Order Percent",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "Purchase Invoice",
  "script": "\ndef update_purchase_order_billed_amount(purchase_order):\n    frappe.msgprint(purchase_order)\n    if not purchase_order:\n        return\n\n    total = frappe.db.sql(\"\"\"\n        SELECT SUM(sii.amount)\n        FROM `tabPurchase Invoice Item` sii\n        JOIN `tabPurchase Invoice` si ON si.name = sii.parent\n        WHERE\n            sii.purchase_order = %s\n            AND si.docstatus = 1\n    \"\"\", purchase_order)[0][0] or 0\n\n    frappe.db.set_value(\n        \"Purchase Order\",\n        purchase_order,\n        \"custom_total_billed\",\n        total,\n        update_modified=False\n    )\n\n\nfor item in doc.items:\n    if item.purchase_order:\n        update_purchase_order_billed_amount(item.purchase_order)",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "After Delete",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2026-01-15 11:54:00.065835",
  "module": null,
  "name": "Total Purchase Order Before Delete",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "Purchase Invoice",
  "script": "\ndef update_purchase_order_billed_amount(purchase_order):\n    if not purchase_order:\n        return\n\n    total = frappe.db.sql(\"\"\"\n        SELECT SUM(sii.amount)\n        FROM `tabPurchase Invoice Item` sii\n        JOIN `tabPurchase Invoice` si ON si.name = sii.parent\n        WHERE\n            sii.purchase_order = %s\n            AND si.docstatus = 1\n    \"\"\", purchase_order)[0][0] or 0\n\n    frappe.db.set_value(\n        \"Purchase Order\",\n        purchase_order,\n        \"custom_total_billed\",\n        total,\n        update_modified=False\n    )\n\n\nfor item in doc.items:\n    if item.purchase_order:\n        update_purchase_order_billed_amount(item.purchase_order)",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": "get_purchase_order_info",
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Insert",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2026-01-17 11:58:38.326684",
  "module": null,
  "name": "Get Purchase Info",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": null,
  "script": "purchase_order = frappe.form_dict.get('purchase_order')\r\n\r\nif not purchase_order:\r\n    frappe.throw('Not Found Purchase Order')\r\n\r\ntotal = frappe.db.sql(\"\"\"\r\n    SELECT SUM(received_qty)\r\n    FROM `tabPurchase Order Item`\r\n    WHERE parent = %s\r\n\"\"\", purchase_order)[0][0] or 0\r\n\r\ntotal_collected = frappe.db.sql(\"\"\"\r\n    SELECT SUM(per.allocated_amount)\r\n    FROM `tabPayment Entry Reference` per\r\n    INNER JOIN `tabPurchase Invoice` si\r\n        ON per.reference_name = si.name\r\n    WHERE\r\n        per.reference_doctype = 'Purchase Invoice'\r\n        AND si.docstatus = 1\r\n        AND per.docstatus = 1\r\n        AND EXISTS (\r\n            SELECT 1\r\n            FROM `tabPurchase Invoice Item` sii\r\n            WHERE sii.parent = si.name\r\n              AND sii.purchase_order = %s\r\n        )\r\n    \"\"\", purchase_order)[0][0] or 0\r\n\r\ntotal_billed = frappe.db.sql(\"\"\"\r\n    SELECT SUM(sii.amount)\r\n    FROM `tabPurchase Invoice Item` sii\r\n    INNER JOIN `tabPurchase Invoice` si ON si.name = sii.parent\r\n    WHERE\r\n        sii.purchase_order = %s\r\n        AND si.docstatus = 1\r\n\"\"\", purchase_order)[0][0] or 0\r\n\r\nso_total_qty = frappe.db.sql(\"\"\"\r\n    SELECT SUM(qty)\r\n    FROM `tabPurchase Order Item`\r\n    WHERE parent = %s\r\n    AND docstatus = 1\r\n\"\"\", purchase_order)[0][0] or 0\r\n\r\nfrappe.response['message'] = {\r\n    \"sales_order\": purchase_order,\r\n    \"total_delivered_qty\": total,\r\n    \"total_allocated_amount\": total_collected,\r\n    \"total_billed\": total_billed,\r\n    \"total_qty\": so_total_qty\r\n}\r\n",
  "script_type": "API"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "After Cancel",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2026-01-22 14:55:06.362760",
  "module": null,
  "name": "update_left_over_after_cancel",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "Material Summary",
  "script": "leftover_summary = frappe.get_doc(\"Left Over Summary\", \"Left Over Summary Record\")  \n\nif not leftover_summary.left_over_table:\n    leftover_summary.left_over_table = []\n    \nexisting_rows = {(r.item_code,r.source_warehouse): r for r in leftover_summary.left_over_table}\n    \nfor row in doc.items:  \n    b_row = existing_rows.get(row.item_code)\n    if not b_row:\n        b_row = leftover_summary.append(\"left_over_table\",{})\n        b_row.item_code = row.item_code\n        b_row.source_warehouse = row.source_warehouse\n\n    b_row.leftover_qty = -row.planned_leftover_qty\n\nleftover_summary.save(ignore_permissions=True)\n",
  "script_type": "DocType Event"
 }
]